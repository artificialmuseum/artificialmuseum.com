import{X as t,Y as e,Z as o,a0 as i,$ as s,J as n,x as a,a1 as h,a2 as r,a3 as d,a4 as l,a5 as u,a6 as c,a7 as m}from"../vendor.js";import{MovementPad as v}from"./MovementPad.js";import"./utils.js";var p=new WeakMap,f=new WeakMap,w=new WeakMap,M=new WeakMap,y=new WeakMap,g=new WeakMap,b=new WeakMap,k=new WeakMap,x=new WeakMap,P=new WeakMap,W=new WeakMap,Y=new WeakMap,D=new WeakMap,B=new WeakMap,C=new WeakMap,R=new WeakSet,S=new WeakSet,E=new WeakSet;class K{constructor(u,c,m,K){t(this,E),t(this,S),t(this,R),e(this,"movementPad",void 0),e(this,"container",void 0),e(this,"config",void 0),e(this,"fpsBody",void 0),e(this,"mouse",void 0),e(this,"enabled",!0),o(this,p,{writable:!0,value:void 0}),o(this,f,{writable:!0,value:void 0}),o(this,w,{writable:!0,value:void 0}),o(this,M,{writable:!0,value:void 0}),o(this,y,{writable:!0,value:!1}),o(this,g,{writable:!0,value:!1}),o(this,b,{writable:!0,value:!1}),o(this,k,{writable:!0,value:!1}),o(this,x,{writable:!0,value:!1}),o(this,P,{writable:!0,value:!1}),o(this,W,{writable:!0,value:!1}),o(this,Y,{writable:!0,value:!1}),o(this,D,{writable:!0,value:!1}),o(this,B,{writable:!0,value:1}),o(this,C,{writable:!0,value:1}),this.container=c.parentNode.parentNode,this.canvas=c,this.camera=u,i&&(s.on(document,"gesturestart",this.gestureChange),s.on(document,"gesturechange",this.gestureChange),s.on(document,"gestureend",this.gestureEnd),document.documentElement.style.position="fixed",document.documentElement.style.height="100%",document.documentElement.style.overflow="hidden",document.body.style.width="100vw",document.body.style.height="100vh",document.body.style.overflowY="scroll",document.body.style.overflowX="hidden",document.body.style.WebkitOverflowScrolling="touch"),this.config=n(m.touchControls,{delta:.75,moveSpeed:.03,rotationSpeed:.003,maxPitch:0}),this.camConfig=n(m.cam,{x:0,y:1.7,z:5});var X=n(m,{floorTargets:[]});X.floorTargets.length&&(this.targets=X.floorTargets.map((t=>K.model.getObjectByName(t))).filter((t=>t)),this.targets.length&&(this.currentCameraHeight=1.7,this.rayOrigin=new a,this.rayDirection=new a(0,-1,0),this.floorRay=new h)),r(this,f,[]),r(this,M,this.config.maxPitch*Math.PI/180),r(this,w,new a(0,0,0)),this.mouse=new d,this.fpsBody=K.camera,this.movementPad=new v(this),this.onYawPitch=this.onYawPitch.bind(this),this.onPadMove=this.onPadMove.bind(this),this.onStopMove=this.onStopMove.bind(this),this.onContextMenu=this.onContextMenu.bind(this),this.onKeyDown=this.onKeyDown.bind(this),this.onKeyUp=this.onKeyUp.bind(this),this.onMouseMove=this.onMouseMove.bind(this),this.onMouseOut=this.onMouseOut.bind(this),this.onMouseDown=this.onMouseDown.bind(this),this.onMouseUp=this.onMouseUp.bind(this),s.on(this.movementPad.padElement,"move",this.onPadMove),s.on(this.movementPad.padElement,"stopMove",this.onStopMove),s.on(this.container,"contextmenu",this.onContextMenu),s.on(this.container,"mousedown",this.onMouseDown),s.on(this.container,"mouseup",this.onMouseUp),s.on(document,"touchstart",(t=>{i&&!t.target.attribute("id").startsWith("hud")&&(t.preventDefault(),t.stopPropagation())})),s.on(document,"keydown",this.onKeyDown),s.on(document,"keyup",this.onKeyUp),s.on(document,"mousemove",this.onMouseMove),s.on(document,"mouseout",this.onMouseOut),l(this,R,U).call(this)}onPadMove(t){r(this,B,Math.abs(t.detail.deltaY)),r(this,C,Math.abs(t.detail.deltaX)),t.detail.deltaY==t.detail.middle?(r(this,B,1),r(this,g,r(this,b,!1))):t.detail.deltaY>t.detail.middle?(r(this,g,!0),r(this,b,!1)):t.detail.deltaY<t.detail.middle&&(r(this,g,!1),r(this,b,!0));var e=l(this,S,X).call(this,-t.detail.deltaX,t.detail.deltaY);this.setRotation(e.rx,e.ry)}onYawPitch(t){var e=l(this,S,X).call(this,t.detail.deltaX,t.detail.deltaY);this.setRotation(e.rx,e.ry)}onStopMove(t){r(this,B,r(this,C,1)),r(this,g,r(this,b,r(this,k,r(this,x,!1))))}onContextMenu(t){t.preventDefault()}gestureChange(t){t.preventDefault(),document.body.style.zoom=.9999999}gestureEnd(t){t.preventDefault(),document.body.style.zoom=1}unspawn(){s.off(this.movementPad.padElement,"move",this.onPadMove),s.off(this.movementPad.padElement,"stopMove",this.onStopMove),i&&(s.off(document,"gesturestart",this.gestureChange),s.off(document,"gesturechange",this.gestureChange),s.off(document,"gestureend",this.gestureEnd)),s.off(this.container,"contextmenu",this.onContextMenu),s.off(document,"keydown",this.onKeyDown),s.off(document,"keyup",this.onKeyUp),s.off(this.container,"mousedown",this.onMouseDown),s.off(this.container,"mouseup",this.onMouseUp),s.off(document,"mousemove",this.onMouseMove),s.off(document,"mouseout",this.onMouseOut),s.remove(this.movementPad.padElement),i&&(document.documentElement.style={},document.body.style={})}onMouseDown(t){this.enabled&&2===t.button&&(r(this,y,!0),t.preventDefault(),t.stopPropagation())}onMouseUp(t){this.enabled&&2===t.button&&r(this,y,!1)}onMouseMove(t){if(this.mouse.x=t.clientX/window.innerWidth*2-1,this.mouse.y=-t.clientY/window.innerHeight*2+1,this.enabled&&u(this,y)){var e=t.movementX||0,o=t.movementY||0,i=l(this,S,X).call(this,-1*e,-1*o);this.setRotation(i.rx,i.ry)}}onMouseOut(t){r(this,y,!1)}onKeyDown(t){if(this.enabled)switch(t.keyCode){case 38:case 87:r(this,g,!0);break;case 37:case 65:r(this,k,!0);break;case 40:case 83:r(this,b,!0);break;case 39:case 68:r(this,x,!0)}}onKeyUp(t){switch(t.keyCode){case 38:case 87:r(this,g,!1);break;case 37:case 65:r(this,k,!1);break;case 40:case 83:r(this,b,!1);break;case 39:case 68:r(this,x,!1)}}updateRayCaster(t){this.floorRay.set(this.camera.position,this.rayDirection);var e=this.floorRay.intersectObjects(this.targets).filter((t=>t.object.visible)),o=0;e.length?e.forEach((t=>{var e=t.point.y;o=e+this.currentCameraHeight})):o=this.currentCameraHeight,this.targetY=o}update(){u(this,w).x+=-1*u(this,w).x*this.config.delta,u(this,w).z+=-1*u(this,w).z*this.config.delta,u(this,g)&&!u(this,P)&&(u(this,w).z-=u(this,B)*this.config.moveSpeed*this.config.delta),u(this,b)&&!u(this,W)&&(u(this,w).z+=u(this,B)*this.config.moveSpeed*this.config.delta),u(this,k)&&!u(this,Y)&&(u(this,w).x-=u(this,C)*this.config.moveSpeed*this.config.delta),u(this,x)&&!u(this,D)&&(u(this,w).x+=u(this,C)*this.config.moveSpeed*this.config.delta),this.floorRay&&(this.updateRayCaster(),this.fpsBody.position.y=this.targetY),this.fpsBody.translateX(u(this,w).x),this.fpsBody.translateZ(u(this,w).z)}getDirection2(t){var e=new a(0,0,-1),o=new c(0,0,0,"YXZ"),i=this.fpsBody.rotation.x,s=this.fpsBody.rotation.y;return o.set(i,s,0),t.copy(e).applyEuler(o),t}getDirection(){var t=0,e=0,o=new a(0,0,-1),i=new c(0,0,0,"YXZ");return null!=self&&(t=this.fpsBody.rotation.x,e=this.fpsBody.rotation.y),s=>(i.set(t,e,0),s.copy(o).applyEuler(i),s)}isMoveLeft(){return u(this,k)}isMoveRight(){return u(this,x)}isMoveForward(){return u(this,g)}isMoveBackward(){return u(this,b)}lockMoveForward(t){r(this,P,t)}lockMoveBackward(t){r(this,W,t)}lockMoveLeft(t){r(this,Y,t)}lockMoveRight(t){r(this,D,t)}unlockAllDirections(){this.lockMoveForward(!1),this.lockMoveBackward(!1),this.lockMoveLeft(!1),this.lockMoveRight(!1)}addToScene(t){r(this,p,t),u(this,p).add(this.fpsBody)}setPosition(t,e,o){this.fpsBody.position.set(t,e,o)}stopMouseMoving(){r(this,y,!1)}setRotation(t,e){null!==t&&(this.fpsBody.rotation.x=t),null!==e&&(this.fpsBody.rotation.y=e)}}function U(){var t=new m;t.makeRotationY(0),u(this,f).push(t);var e=new m;e.makeRotationY(180*Math.PI/180),u(this,f).push(e);var o=new m;o.makeRotationY(90*Math.PI/180),u(this,f).push(o);var i=new m;i.makeRotationY(270*Math.PI/180),u(this,f).push(i)}function X(t,e,o){var i=o||this.config.rotationSpeed,s=this.fpsBody.rotation.y-t*i,n=this.fpsBody.rotation.x-e*i;return{rx:n=Math.max(-u(this,M),Math.min(u(this,M),n)),ry:s}}export{K as ArmTouchControls};
