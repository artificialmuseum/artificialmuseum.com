import{$ as e,ar as t,L as i,W as a,aR as o,aS as n,aT as r,S as s,aa as l,aM as d,aU as h,aV as c,aO as p,c as m,_ as v,b6 as u,M as f}from"../vendor.js";class g{constructor(r){var{artifact:s,engine:l,preload:d,videoElement:h}=r;this.engine=l,this.preload=d,h||(h=d.assets.videoElement),this.videoElement=h,this.name="Record3D";var{filterSize:c="1",minDepth:p="0.1",maxDepth:m="5.0",depthThresholdFilter:v="0.9",scale:u="2.0",ptSize:f=1,depthScale:g="1.0",pixelDepth:y="1.0",permanentSeconds:x=[],useBone:S=!1,parentName:b="parent",playbackRate:D=1,loopVideo:w=!0,continueVideoSound:z=!1,useFog:P=!1,addFog:B=1e-4,fogColor:V=16448250,rotation:I={},videoAlpha:k=1,permanentAlpha:F=.1,hideModelsOnVideoEnded:N=[],addReflector:O=!1}=s;this.shaderConfig={filterSize:c,minDepth:p,maxDepth:m,depthThresholdFilter:v,scale:u,depthScale:g,ptSize:(f*window.devicePixelRatio).toFixed(1).toString(),pixelDepth:y},this.permanentSeconds=x,this.currentSecondId=0,this.useBone=S,this.parentName=b,this.useFog=P,this.addFog=B,this.fogColor=V,this.loopVideo=w,this.continueVideoSound=z,this.hideModelsOnVideoEnded=N,this.addReflector=O,this.videoAlpha=k,this.permanentAlpha=F,this.rotation=I,this.playbackRate=D,this.hideCharacter=this.hideCharacter.bind(this);var{videoWidth:j,videoHeight:_}=h;if(h){h.playbackRate=this.playbackRate,this.modelsToHide=[],(this.hideModelsOnVideoEnded.length||!1===this.loopVideo)&&(e.on(h,"seeked",this.hideCharacter),this.hideModelsOnVideoEnded.forEach((e=>{var t=d.assets.gltf.scene.getObjectByName(e);t.material.transparent=!0,this.modelsToHide.push(t)})));var C=new t(h,{minFilter:i});this.videoTexture=C,this.pointCopies=[],this.canvases=[],this.permanentSeconds.forEach(((t,n)=>{var r=e.create("canvas",{height:_,width:j,style:{position:"fixed",left:"100vw"},parent:a.B});this.canvases.push(r);var s=new o(r,{minFilter:i}),d=this.createPoints(s,this.permanentAlpha);d.visible=!1,this.pointCopies.push(d),l.scene.add(d)}));var A=this.createPoints(C,this.videoAlpha),E=this.rotation;E.x&&A.rotateX(E.x),E.y&&A.rotateY(E.y),E.z&&A.rotateZ(E.z),this.useBone?this.child=A:this.model=A,this.useFog&&(this.fog=new n(this.fogColor,.005),this.engine.scene.fog=this.fog)}}hideCharacter(){this.hasTriggeredOnce?this.fadeOutModel=!0:this.hasTriggeredOnce=!0}createPoints(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"1.0",{artifact:i={}}=this.engine,{videoElement:a}=this,{videoWidth:o,videoHeight:n}=a,m=new r,{ifx:v=.00125,ify:u=.00125,itx:f=-.4,ity:g=-.6}=i,{filterSize:y,minDepth:x,maxDepth:S,depthScale:b,depthThresholdFilter:D,scale:w,ptSize:z,pixelDepth:P}=this.shaderConfig,B=new s({uniforms:{texImg:{type:"t",value:e},texSize:{type:"i2",value:[o,n]},iK:{type:"f4",value:[v,u,f,g]},alpha:{type:"f",value:t},filterSize:{type:"f",value:y},minDepth:{type:"f",value:x},maxDepth:{type:"f",value:S},depthThresholdFilter:{type:"f",value:D},scale:{type:"f",value:w},ptSize:{type:"f",value:z},pixelDepth:{type:"f",value:P},depthScale:{type:"f",value:b}},side:l,transparent:!0,vertexShader:"#define GLSLIFY 1\nattribute float vertexIdx;varying float vVertexIdx;varying vec2 vPtPos;uniform ivec2 texSize;uniform sampler2D texImg;uniform vec4 iK;uniform float scale;uniform float minDepth;uniform float maxDepth;uniform float pixelDepth;uniform int filterSize;uniform float ptSize;uniform float depthThresholdFilter;uniform float depthScale;float rgb2hue(vec3 c){vec4 K=vec4(0.0,-1.0/3.0,2.0/3.0,-1.0);vec4 p=mix(vec4(c.bg,K.wz),vec4(c.gb,K.xy),step(c.b,c.g));vec4 q=mix(vec4(p.xyw,c.r),vec4(c.r,p.yzx),step(p.x,c.r));float d=q.x-min(q.w,q.y);float e=1.0e-10;return abs(q.z+(q.w-q.y)/(6.0*d+e));}float getPixelDepth(ivec2 pixel){vec2 lookupPt=(vec2(pixel)+vec2(0.5))/vec2(texSize);float hue=rgb2hue(texture2D(texImg,lookupPt).rgb);float pxDepth=pixelDepth*hue;return pxDepth;}bool shouldDiscard(ivec2 currPixel){float centerPixelDepth=getPixelDepth(currPixel);for(int i=-filterSize;i<=filterSize;i++){for(int j=-filterSize;j<=filterSize;j++){if(i==0&&j==0){continue;}float currDepth=getPixelDepth(currPixel+ivec2(j,i));if(currDepth<minDepth||currDepth>=maxDepth||abs(centerPixelDepth-currDepth)>depthThresholdFilter){return true;}}}return false;}void main(){ivec2 frameSize=ivec2(texSize.x/2,texSize.y);int vertIdx=int(vertexIdx);int actualNumPts=frameSize.x*frameSize.y;if(vertIdx>=actualNumPts){gl_Position=vec4(0.0);return;}int ptY=vertIdx/int(frameSize.x);int ptX=vertIdx-ptY*int(frameSize.x);ivec2 pt=ivec2(ptX,ptY);if(shouldDiscard(pt)){gl_Position=vec4(0.0);return;}float currDepth=getPixelDepth(pt);vec3 ptPos=scale*vec3((iK.x*float(ptX)+iK.z)*currDepth,(iK.y*float(ptY)+iK.w)*currDepth,-currDepth*depthScale);vec4 mvPos=modelViewMatrix*vec4(ptPos,1.0);gl_Position=projectionMatrix*mvPos;vPtPos=vec2(float(ptX),float(ptY));vVertexIdx=vertexIdx;gl_PointSize=ptSize;}",fragmentShader:"#define GLSLIFY 1\nvarying float vVertexIdx;varying vec2 vPtPos;uniform ivec2 texSize;uniform sampler2D texImg;uniform float alpha;void main(){vec2 frameSizeF=vec2(texSize.x/2,texSize.y);ivec2 frameSize=ivec2(frameSizeF);int vertIdx=int(vVertexIdx);int actualNumPts=frameSize.x*frameSize.y;if(vertIdx>=actualNumPts){discard;}vec2 lookupPt=(vec2(vPtPos.x+frameSizeF.x,vPtPos.y)+vec2(0.5))/vec2(texSize);vec3 currColor=texture2D(texImg,lookupPt).rgb;gl_FragColor=vec4(currColor,alpha);}"}),V=o/2*n,I=new Uint32Array(V),k=new Float32Array(V),F=0;F<V;F++)I[F]=F,k[F]=F;var N=new d;N.setAttribute("vertexIdx",new h(k,1)),N.setIndex(new c(new Uint32Array(I),1));var O=new p(N,B);return O.frustumCulled=!1,m.add(O),m}exit(){e.remove(this.canvasImgs)}renderCopies(){new Promise((e=>{var{videoElement:t}=this,{videoHeight:i,videoWidth:a}=t;if(this.waitForSecond){if(t.currentTime>this.waitForSecond){this.canvases[this.currentSecondId].getContext("2d").drawImage(t,0,0,a,i);var o=this.pointCopies[this.currentSecondId];o.visible=!0,this.child.matrixWorld.decompose(o.position,o.rotation,o.scale),this.currentSecondId++,this.waitForSecond=this.permanentSeconds[this.currentSecondId]}}else this.waitForSecond=this.permanentSeconds[this.currentSecondId];e()}))}tick(e){var{engine:t}=e;if(this.currentSecondId<this.permanentSeconds.length&&this.renderCopies(t),this.fog&&this.addFog&&(this.fog.density+=this.addFog),this.fadeOutModel&&!this.hasFaded){this.modelsToHide.forEach((e=>{e.material.opacity>0?e.material.opacity-=.05:e.visible&&(e.visible=!1)}));var i=this.model||this.child;if(i&&i.visible){var a,o,n,r=null==i?void 0:i.children[0];(null==r||null===(a=r.material)||void 0===a||null===(o=a.uniforms)||void 0===o||null===(n=o.alpha)||void 0===n?void 0:n.value)>0?r.material.uniforms.alpha.value-=.05:i.visible&&(i.visible=!1,this.continuePlayingNonLoopedVideo&&this.videoElement.pause())}}}}class y{constructor(e){var{artifact:t,mergeConfig:i,preload:a}=e;this.artifact=t,this.preloader=a,this.config=i(t,{apiHost:"api.artificialmuseum.com",font:{size:.2,height:.02,curveSegments:4,bevelThickness:.01,bevelSize:.01,bevelEnabled:!0}}),this.hasVoted=!1}preload(){var e=this;return m((function*(){var[t,i]=yield Promise.all([e.preloader.loadVideo({dir:"artificialroom",video:"gameover",id:"artificialroom-gVideo"}),e.preloader.loadVideo({dir:"artificialroom",video:"replay",id:"artificialroom-rVideo"})]);e.gVideo=t,e.rVideo=i}))()}exit(){e.remove([this.gVideo,this.rVideo,this.gButton,this.rButton])}afterLoadModel(t){var i=this,{engine:a,preload:o}=t;this.engine=a,this.gChar=a.model.getObjectByName("cyborg_gameover"),this.rChar=a.model.getObjectByName("cyborg_replay"),this.bunny=a.model.getObjectByName("bunny"),this.bunny.visible=!1,a.model.getObjectByName("interface_01").castShadow=!1,a.model.getObjectByName("result").visible=!1;var n=v(v({},this.artifact),{},{scale:"3.0"});this.r3DG=new g({artifact:n,engine:a,preload:o,videoElement:this.gVideo}),a.model.getObjectByName("cyborg_gameover").getObjectByName("parent").add(this.r3DG.model);var r,s,l=v(v({},this.artifact),{},{scale:"1.5"});this.r3DR=new g({artifact:l,engine:a,preload:o,videoElement:this.rVideo}),a.model.getObjectByName("cyborg_replay001").getObjectByName("parent_1").add(this.r3DR.model),this.gVideo.play(),this.rVideo.play(),this.gButton=e.create("button",{id:"gameover",style:{position:"fixed",left:0,bottom:"5px",width:"100%",display:"none"},on:{click:(r=m((function*(){(yield window.fetch("https://".concat(i.config.apiHost,"/v1/vote?0"))).ok&&(i.gButton.style.display="none",i.afterVote(0))})),function(){return r.apply(this,arguments)})},parent:this.engine.hud.gui}),e.create("img",{src:"https://static.artificialmuseum.com/button/artificialroom/btn_gameover.png",parent:this.gButton,style:{position:"relative",margin:"0 auto",maxWidth:"60%"}}),this.rButton=e.create("button",{id:"replay",style:{position:"fixed",left:0,bottom:"5px",width:"100%",display:"none"},on:{click:(s=m((function*(){(yield window.fetch("https://".concat(i.config.apiHost,"/v1/vote?1"))).ok&&(i.rButton.style.display="none",i.afterVote(1))})),function(){return s.apply(this,arguments)})},parent:this.engine.hud.gui}),e.create("img",{src:"https://static.artificialmuseum.com/button/artificialroom/btn_replay.png",parent:this.rButton,style:{position:"relative",margin:"0 auto",maxWidth:"60%"}}),this.gameOverAssets=[this.engine.model.getObjectByName("clipping_door"),this.engine.model.getObjectByName("clipping001"),this.engine.model.getObjectByName("Sphere"),this.engine.model.getObjectByName("moon"),this.engine.model.getObjectByName("end_replay")],this.gameOverAssets.forEach((e=>{null!=e&&e.visible&&(e.visible=!1)}))}afterVote(t){var i=this;return m((function*(){if(i.hasVoted=!0,i.vote=t,0===i.vote){i.gameOverAssets.forEach((e=>{e.visible=!0})),i.engine.actions.find((e=>"clippDoor_opens"===e._clip.name)).paused=!1;var a=i.engine.actions.find((e=>"landing"===e._clip.name));a.paused=!1}else if(1===i.vote){i.bunny.visible=!0;var o=i.engine.actions.find((e=>"location"===e._clip.name));o.paused=!1;var n=i.engine.actions.find((e=>"shapekeys"===e._clip.name));n.paused=!1}var r=i.artifact.fonts[0],{assets:s}=i.preloader,l=s.fonts[r],{TextGeometry:d}=s.examples,h=yield fetch("https://".concat(i.config.apiHost,"/v1/result/?verbose=1")),c=yield h.json(),p=[new u({color:16777215,flatShading:!0}),new u({color:16777215})],m=new d("".concat(c.gp,"%"),v(v({},i.config.font),{},{font:l}));m.computeBoundingBox();var g=new f(m,p);g.geometry.center(),g.position.set(-1,2.3,0);var y=new d("".concat(c.rp,"%"),v(v({},i.config.font),{},{font:l}));y.computeBoundingBox();var x=new f(y,p);x.geometry.center(),x.position.set(1,2.3,0),i.engine.model.add(g),i.engine.model.add(x);var S=e.create("img",{src:"https://static.artificialmuseum.com/button/artificialroom/thanksforvoting.jpg",style:{top:"calc(50vh - 70px)",left:"calc(50vw - 150px)",width:"300px",height:"140px",margin:"0 auto",position:"fixed"},parent:i.engine.hud.gui});setTimeout((()=>{e.remove(S)}),5e3)}))()}distanceMatch(e){var{distance:t,config:i,node:a}=e,{min:o=0,max:n}=i.distance;if(t<=n&&t>=o){if(!this.trackedNode){this.trackedNode=a;var[r]=a.name.split("_");this.trackedAction=this.engine.actions.find((e=>e._clip.name==="active_".concat(r))),this.trackedAction.paused=!1,"replay"===r?this.r3DR.model.visible=!1:"gameover"===r&&(this.r3DG.model.visible=!1)}}else this.trackedNode&&a.name===this.trackedNode.name&&(this.trackedNode=null,this.trackedAction&&(this.trackedAction.paused=!0,this.trackedAction=null),this.r3DG.model.visible=!0,this.r3DR.model.visible=!0)}tick(){var{x:e,z:t}=this.engine.camera.position;!this.hasVoted&&this.engine.modelSpawned&&(e<-.05&&t>0?"inherit"!==this.gButton.style.display&&(this.gButton.style.display="inherit",this.rButton.style.display="none"):e>.05&&t>0?"inherit"!==this.rButton.style.display&&(this.rButton.style.display="inherit",this.gButton.style.display="none"):("none"!==this.gButton.style.display&&(this.gButton.style.display="none"),"none"!==this.rButton.style.display&&(this.rButton.style.display="none")))}}export{y as default};
