import{a5 as e,c as t,$ as i,_ as o,ad as a,x as r,aa as n}from"../vendor.js";class s{constructor(t){var{artifact:i,mergeConfig:o,preload:a}=t;this.artifact=i,this.preloader=a,this.config=o(i,{apiHost:"api.artificialmuseum.com",font:{size:.2,height:.02,curveSegments:4,bevelThickness:.01,bevelSize:.01,bevelEnabled:!0},artificialroom:{names:{clipDoor:"clipping_door",gameoverCyborg:"cyborg_gameover",gameoverParent:"parent_gameover",replayCyborg:"cyborg_replay",replayParent:"parent_replay",result:"result",assets:["clipping_door","clipping","sphere","moon","end_replay"]}}}),this.hasVoted=!1,this.parentPos=new e}preload(){var e=this;return t((function*(){var[t,i]=yield Promise.all([e.preloader.loadVideo({dir:"artificialroom",video:"gameover",id:"artificialroom-gVideo"}),e.preloader.loadVideo({dir:"artificialroom",video:"replay",id:"artificialroom-rVideo"})]);e.gVideo=t,e.rVideo=i}))()}exit(){i.remove([this.gVideo,this.rVideo,this.gButton,this.rButton])}afterLoadModel(e){var{engine:t,preload:a}=e;this.engine=t,this.parent=t.model,this.gChar=t.model.getObjectByName(this.config.artificialroom.names.gameoverCyborg),this.rChar=t.model.getObjectByName(this.config.artificialroom.names.replayCyborg);var{Record3D:r}=a.assets,n=t.model.getObjectByName(this.config.artificialroom.names.result);n&&(n.visible=!1);var s=o(o({},this.artifact),{},{scale:"3.0"});this.r3DG=new r({artifact:s,engine:t,preload:a,videoElement:this.gVideo}),this.gChar.getObjectByName(this.config.artificialroom.names.gameoverParent).add(this.r3DG.model);var c=o(o({},this.artifact),{},{scale:"1.5"});if(this.r3DR=new r({artifact:c,engine:t,preload:a,videoElement:this.rVideo}),this.rChar.getObjectByName(this.config.artificialroom.names.replayParent).add(this.r3DR.model),this.gVideo.play(),this.rVideo.play(),!this.engine.XR){var l={fontSize:"1.1em",fontWeight:"bold",backgroundColor:"#fafafa",color:"#0c0c0c",padding:"0.5em",position:"fixed",bottom:"10px",width:"auto"};this.gButton=i.create("button",{id:"gameover",style:o(o({},l),{},{right:"51%",left:"auto"}),innerText:"GAMEOVER",on:{click:()=>this.sendVote(0)},parent:this.engine.hud.gui}),this.rButton=i.create("button",{id:"replay",style:o(o({},l),{},{left:"51%"}),innerText:"REPLAY",on:{click:()=>this.sendVote(1)},parent:this.engine.hud.gui})}this.gameOverAssets=this.config.artificialroom.names.assets.map((e=>this.engine.model.getObjectByName(e))),this.gameOverAssets.forEach(((e,t)=>{e&&(e.userData.originalPosition={x:e.position.x,y:e.position.y,z:e.position.z},e.position.set(5e3,5e3,5e3))}))}onTouch(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];this.engine.XR&&e.length&&e.forEach((e=>{"cyborg_gameover_clicktarget"===e.target?this.sendVote(0):"cyborg_replay_clicktarget"===e.target&&this.sendVote(1)}))}sendVote(e){var i=this;return t((function*(){i.isVoting||(i.isVoting=!0,(yield window.fetch("https://".concat(i.config.apiHost,"/v1/vote?").concat(e))).ok&&(i.gButton&&(i.gButton.style.display="none"),i.rButton&&(i.rButton.style.display="none"),i.afterVote(e)))}))()}afterVote(e){var s=this;return t((function*(){var t;if(s.hasVoted=!0,s.isVoting=!1,s.vote=e,0===e?(t="replay",s.r3DG.model.visible=!1):1===e&&(t="gameover",s.r3DR.model.visible=!1),t){s.engine.actions.forEach((e=>{var i="active_".concat(t);e._clip.name===i&&e.stop()}));var c=s.engine.model.getObjectByName("voting_replay");c&&(c.visible=!1);var l=s.engine.model.getObjectByName("voting_gameover");l&&(l.visible=!1)}var g=s.artifact.fonts[0],{assets:d}=s.preloader,m=d.fonts[g],{TextGeometry:h}=d.examples,p=yield fetch("https://".concat(s.config.apiHost,"/v1/result/?verbose=1")),f=yield p.json(),v=[new a({color:16777215,flatShading:!0}),new a({color:16777215})],u=new h("".concat(f.gp,"%"),o(o({},s.config.font),{},{font:m}));u.computeBoundingBox();var y=new r(u,v);y.geometry.center(),y.position.set(-1.5,1.8,0);var b=new h("".concat(f.rp,"%"),o(o({},s.config.font),{},{font:m}));b.computeBoundingBox();var V=new r(b,v);V.geometry.center(),V.position.set(1.5,1.8,0),s.engine.model.add(y),s.engine.model.add(V);var B=i.create("img",{src:"https://static.artificialmuseum.com/button/artificialroom/thanksforvoting.jpg",style:{top:"calc(50vh - 70px)",left:"calc(50vw - 150px)",width:"300px",height:"140px",margin:"0 auto",position:"fixed"},parent:s.engine.hud.gui});setTimeout((()=>{i.remove(B),s.gameOverAssets.forEach((e=>{var{x:t,y:i,z:o}=e.userData.originalPosition;e.position.set(t,i,o)})),s.engine.actions.find((e=>"KeyAction"===e._clip.name)).paused=!1;var e=s.engine.actions.find((e=>"longLanding_LivingCity"===e._clip.name));setTimeout((()=>{e.loop=n,e.clampWhenFinished=!0,e.paused=!1}),3e3)}),2e3)}))()}}export{s as default};
