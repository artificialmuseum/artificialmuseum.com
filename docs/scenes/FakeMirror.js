import{ao as e,L as t,aN as i,aO as a,aP as r,S as o,a8 as s,aH as n,aQ as h,aR as l,aJ as d}from"../vendor.js";class p{constructor(e){var{artifact:t,$:i,W:a}=e;this.W=a,this.$=i;var{filterSize:r="1",minDepth:o="0.1",maxDepth:s="5.0",depthThresholdFilter:n="0.9",scale:h="7.0",ptSize:l=1,depthScale:d="1.0",pixelDepth:p="2.0",permanentSeconds:c=[],useBone:v=!1,parentName:f="parent",playbackRate:u=1,loopVideo:m=!0,continueVideoSound:x=!1,useFog:g=!1,addFog:S=1e-4,fogColor:y=16448250,rotation:z={},videoAlpha:P=1,permanentAlpha:D=.1,hideModelsOnVideoEnded:I=[],addReflector:w=!1}=t;this.shaderConfig={filterSize:r,minDepth:o,maxDepth:s,depthThresholdFilter:n,scale:h,depthScale:d,ptSize:(l*window.devicePixelRatio).toFixed(1).toString(),pixelDepth:p},this.permanentSeconds=c,this.currentSecondId=0,this.useBone=v,this.parentName=f,this.useFog=g,this.addFog=S,this.fogColor=y,this.loopVideo=m,this.continueVideoSound=x,this.hideModelsOnVideoEnded=I,this.addReflector=w,this.videoAlpha=P,this.permanentAlpha=D,this.rotation=z,this.playbackRate=u,this.hideCharacter=this.hideCharacter.bind(this)}beforeLoadModel(r){var{engine:o,preload:s}=r;this.engine=o,this.preload=s;var{videoElement:n}=s.assets,{videoWidth:h,videoHeight:l}=n;if(n){n.playbackRate=this.playbackRate,this.modelsToHide=[],(this.hideModelsOnVideoEnded.length||!1===this.loopVideo)&&(this.$.on(n,"seeked",this.hideCharacter),this.hideModelsOnVideoEnded.forEach((e=>{var t=s.assets.gltf.scene.getObjectByName(e);t.material.transparent=!0,this.modelsToHide.push(t)})));var d=new e(n,{minFilter:t});this.pointCopies=[],this.canvases=[],this.permanentSeconds.forEach(((e,a)=>{var r=this.$.create("canvas",{height:l,width:h,style:{position:"fixed",left:"100vw"},parent:this.W.B});this.canvases.push(r);var s=new i(r,{minFilter:t}),n=this.createPoints(s,this.permanentAlpha);n.visible=!1,this.pointCopies.push(n),o.scene.add(n)}));var p=this.createPoints(d,this.videoAlpha),c=this.rotation;c.x&&p.rotateX(c.x),c.y&&p.rotateY(c.y),c.z&&p.rotateZ(c.z),this.useBone?this.child=p:this.model=p,this.useFog&&(this.fog=new a(this.fogColor,.005),this.engine.scene.fog=this.fog)}}hideCharacter(){this.hasTriggeredOnce?this.fadeOutModel=!0:this.hasTriggeredOnce=!0}createPoints(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"1.0",{artifact:i={}}=this.engine,{videoElement:a}=this.preload,{videoWidth:p,videoHeight:c}=a,v=new r,{ifx:f=.00125,ify:u=.00125,itx:m=-.4,ity:x=-.6}=i,{filterSize:g,minDepth:S,maxDepth:y,depthScale:z,depthThresholdFilter:P,scale:D,ptSize:I,pixelDepth:w}=this.shaderConfig,F=new o({uniforms:{texImg:{type:"t",value:e},texSize:{type:"i2",value:[p,c]},iK:{type:"f4",value:[f,u,m,x]},alpha:{type:"f",value:t},filterSize:{type:"f",value:g},minDepth:{type:"f",value:S},maxDepth:{type:"f",value:y},depthThresholdFilter:{type:"f",value:P},scale:{type:"f",value:D},ptSize:{type:"f",value:I},pixelDepth:{type:"f",value:w},depthScale:{type:"f",value:z}},side:s,transparent:!0,vertexShader:"#define GLSLIFY 1\nattribute float vertexIdx;varying float vVertexIdx;varying vec2 vPtPos;uniform ivec2 texSize;uniform sampler2D texImg;uniform vec4 iK;uniform float scale;uniform float minDepth;uniform float maxDepth;uniform float pixelDepth;uniform int filterSize;uniform float ptSize;uniform float depthThresholdFilter;uniform float depthScale;float rgb2hue(vec3 c){vec4 K=vec4(0.0,-1.0/3.0,2.0/3.0,-1.0);vec4 p=mix(vec4(c.bg,K.wz),vec4(c.gb,K.xy),step(c.b,c.g));vec4 q=mix(vec4(p.xyw,c.r),vec4(c.r,p.yzx),step(p.x,c.r));float d=q.x-min(q.w,q.y);float e=1.0e-10;return abs(q.z+(q.w-q.y)/(6.0*d+e));}float getPixelDepth(ivec2 pixel){vec2 lookupPt=(vec2(pixel)+vec2(0.5))/vec2(texSize);float hue=rgb2hue(texture2D(texImg,lookupPt).rgb);float pxDepth=pixelDepth*hue;return pxDepth;}bool shouldDiscard(ivec2 currPixel){float centerPixelDepth=getPixelDepth(currPixel);for(int i=-filterSize;i<=filterSize;i++){for(int j=-filterSize;j<=filterSize;j++){if(i==0&&j==0){continue;}float currDepth=getPixelDepth(currPixel+ivec2(j,i));if(currDepth<minDepth||currDepth>=maxDepth||abs(centerPixelDepth-currDepth)>depthThresholdFilter){return true;}}}return false;}void main(){ivec2 frameSize=ivec2(texSize.x/2,texSize.y);int vertIdx=int(vertexIdx);int actualNumPts=frameSize.x*frameSize.y;if(vertIdx>=actualNumPts){gl_Position=vec4(0.0);return;}int ptY=vertIdx/int(frameSize.x);int ptX=vertIdx-ptY*int(frameSize.x);ivec2 pt=ivec2(ptX,ptY);if(shouldDiscard(pt)){gl_Position=vec4(0.0);return;}float currDepth=getPixelDepth(pt);vec3 ptPos=scale*vec3((iK.x*float(ptX)+iK.z)*currDepth,(iK.y*float(ptY)+iK.w)*currDepth,-currDepth*depthScale);vec4 mvPos=modelViewMatrix*vec4(ptPos,1.0);gl_Position=projectionMatrix*mvPos;vPtPos=vec2(float(ptX),float(ptY));vVertexIdx=vertexIdx;gl_PointSize=ptSize;}",fragmentShader:"#define GLSLIFY 1\nvarying float vVertexIdx;varying vec2 vPtPos;uniform ivec2 texSize;uniform sampler2D texImg;uniform float alpha;void main(){vec2 frameSizeF=vec2(texSize.x/2,texSize.y);ivec2 frameSize=ivec2(frameSizeF);int vertIdx=int(vVertexIdx);int actualNumPts=frameSize.x*frameSize.y;if(vertIdx>=actualNumPts){discard;}vec2 lookupPt=(vec2(vPtPos.x+frameSizeF.x,vPtPos.y)+vec2(0.5))/vec2(texSize);vec3 currColor=texture2D(texImg,lookupPt).rgb;gl_FragColor=vec4(currColor,alpha);}"}),b=p/2*c,C=new Uint32Array(b),V=new Float32Array(b),T=0;T<b;T++)C[T]=T,V[T]=T;var E=new n;E.setAttribute("vertexIdx",new h(V,1)),E.setIndex(new l(new Uint32Array(C),1));var k=new d(E,F);return k.frustumCulled=!1,v.add(k),v}exit(){this.$.remove(this.canvasImgs)}renderCopies(e){new Promise((t=>{var{videoElement:i}=e,{videoHeight:a,videoWidth:r}=i;if(this.waitForSecond){if(i.currentTime>this.waitForSecond){this.canvases[this.currentSecondId].getContext("2d").drawImage(i,0,0,r,a);var o=this.pointCopies[this.currentSecondId];o.visible=!0,this.child.matrixWorld.decompose(o.position,o.rotation,o.scale),this.currentSecondId++,this.waitForSecond=this.permanentSeconds[this.currentSecondId]}}else this.waitForSecond=this.permanentSeconds[this.currentSecondId];t()}))}tick(e){var{engine:t}=e;if(this.currentSecondId<this.permanentSeconds.length&&this.renderCopies(t),this.fog&&this.addFog&&(this.fog.density+=this.addFog),this.fadeOutModel&&!this.hasFaded){this.modelsToHide.forEach((e=>{e.material.opacity>0?e.material.opacity-=.05:e.visible&&(e.visible=!1)}));var i=this.model||this.child;if(i&&i.visible){var a,r,o,s=null==i?void 0:i.children[0];(null==s||null===(a=s.material)||void 0===a||null===(r=a.uniforms)||void 0===r||null===(o=r.alpha)||void 0===o?void 0:o.value)>0?s.material.uniforms.alpha.value-=.05:i.visible&&(i.visible=!1,this.continuePlayingNonLoopedVideo&&this.preload.videoElement.pause())}}}}export{p as default};
