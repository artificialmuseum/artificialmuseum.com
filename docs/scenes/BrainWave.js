import{az as e,c as t,aq as a,aJ as i,aK as s,aL as n,a as r,ad as o,aM as u,a9 as h,aN as l,aG as d,M as p,aO as m,aB as c,aP as v,C as g,a6 as b,W as w}from"../vendor.js";import{WireframeMaterial as f}from"../materials/WireframeMaterial.js";var S=function(t){for(var a=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:Infinity,n=t.getIndex()||t.getAttribute("position"),r=n.count/3,o=[],u=i;u<r&&u<=s;u++){var h=u%2==0,l=a?1:0;h?o.push(0,0,1,0,1,0,1,0,l):o.push(0,1,0,0,0,1,1,0,l)}var d=new Float32Array(o),p=new e(d,3);t.setAttribute("barycentric",p)};class y{constructor(e){var{artifact:t}=e;this.artifact=t;var{radiusSegments:a=5,tube1Radius:i=.4,tube2Radius:s=.37,growSteps:n=1,edgeRemoval:r=!1,positionScaleFactor:o=1,tubeScale:u=.1,tube1Rotation:h=90,tube2Rotation:l=2*-Math.PI,audioThreshold:d=.02,fps:p=60,maximalSplineLength:m=5e3}=t;this.radiusSegments=a,this.tube1Radius=i*o,this.tube2Radius=s*o,this.growSteps=n,this.positionScaleFactor=o,this.audioThreshold=d,this.tubeScale=u,this.tube1Rotation=h,this.tube2Rotation=l,this.edgeRemoval=r,this.currentDrawRangeMin=0,this.direction=1,this.msBetweenSplineExpansions=1e3/p,this.maximalSplineLength=m,this.audioDistanceMaxMeters=8}preload(){var e=this;return t((function*(){e.data=yield e.loadData(),e.buffer=yield e.loadAudio(),e.matcapTexture=yield e.loadMatCap()}))()}loadMatCap(){var e="".concat(w.STATIC_URL,"/textures/matcap/grey-white-light.jpg");return new Promise((t=>{(new a).load(e,(e=>t(e)))}))}loadData(){var e=this;return t((function*(){var{artifact:t}=e,a=t.data?t.data:t.slug,i="".concat(w.STATIC_URL,"/data/").concat(a,".js"),{data:s}=yield import(i);return s}))()}beforeLoadModel(e){var{engine:t,preload:a}=e,{camera:n,modelSpawned:r,renderer:o,scene:u,listener:h,XR:l}=t;this.listener=h,this.XR=l,this.scene=u,this.modelSpawned=r,this.engine=t,this.model=a.assets.gltf.scene,this.camera=n,n.far=1e3,n.updateProjectionMatrix(),this.renderer=o,o.toneMapping=i,o.outputEncoding=s,this.createCubes(),this.create3dSplines(),this.addAudio()}spawnModel(){this.audioTarget1.play(),this.audioTarget2.play()}loadAudio(){var e=this;return t((function*(){var{artifact:t}=e,a=new n,i=r.str(t.audio)?t.audio:t.slug,s="".concat(w.MEDIA_URL,"/audio/").concat(i,".mp3");return new Promise((e=>{a.load(s,(t=>{e(t)}))}))}))()}addAudio(){var e=this;return t((function*(){var{camera:t,model:a,parent1:i,parent2:s}=e,n=new o;t.add(n);var r=i.position,h=new u(n);h.name="audiotarget_1",h.position.set(r.x,r.y,r.z),h.setBuffer(e.buffer),h.setLoop(!0),h.setVolume(0);var l=s.position,d=new u(n);d.name="audiotarget_2",d.position.set(l.x,l.y,l.z),d.setBuffer(e.buffer),d.setLoop(!0),d.setVolume(0),d.offset=.1,a.add(h),a.add(d),e.audioTarget1=h,e.audioTarget2=d}))()}createCubes(){var e=this.positionScaleFactor,t=1.1*e,a=new h(t,t,t),i=new l({matcap:this.matcapTexture});this.cubeGroup=new d,this.cubeGroup.position.set(0,0,0);for(var s=0;s<5;s++)for(var n=0;n<28;n++){var r=new p(a,i);r.name="Cube_".concat(s,"_").concat(n),r.rotateY(2*Math.PI/28*n),r.position.x=e*Math.sin(2*Math.PI/28*n)*Math.sqrt(28),r.position.z=e*Math.cos(2*Math.PI/28*n)*Math.sqrt(28),r.position.y=e*s*1.2+.5*t+.01,this.cubeGroup.add(r)}this.model.add(this.cubeGroup),this.collisionMaxDistance=t/2}create3dSplines(){var{artifact:e,radiusSegments:t,tube1Radius:a,tube2Radius:i,tube1Rotation:s,tube2Rotation:n,tubeScale:r,positionScaleFactor:o}=this,u=o*r;this.points=[{x:0,y:0,z:0},...this.data.map((e=>{var[t,a,i]=e;return{x:t*u,y:a*u,z:i*u}}))];var h=2*this.points.length;this.spline=new m(this.points,!1,"catmullrom"),this.parent1=new c,this.parent1.position.set(0,7*o,0),this.parent2=new c,this.parent2.position.set(0,5*o,0),this.tube1Geometry=new v(this.spline,h,a,t,!1).toNonIndexed(),this.tube1Geometry.rotateY(s),this.tube1Geometry.setDrawRange(0,this.maximalSplineLength),this.tube2Geometry=new v(this.spline,h,i,t,!1).toNonIndexed(),this.tube2Geometry.rotateY(n),this.tube2Geometry.setDrawRange(0,this.maximalSplineLength);var{spline1RemoveEdges:l=!0,spline2RemoveEdges:d=!0}=e;S(this.tube1Geometry,l),S(this.tube2Geometry,d);var{spline1Uniforms:w={time:{value:0},fill:{value:new g(14138052)},stroke:{value:new g(16711680)},noiseA:{value:!1},noiseB:{value:!0},dualStroke:{value:!1},seeThrough:{value:!0},insideAltColor:{value:!1},thickness:{value:.1},secondThickness:{value:.05},dashEnabled:{value:!1},dashRepeats:{value:1},dashOverlap:{value:!1},dashLength:{value:.7},dashAnimate:{value:!1},squeeze:{value:!0},squeezeMin:{value:.28},squeezeMax:{value:1}}}=e;this.spline1material=new f({uniforms:w,side:b,transparent:!0});var{spline2Uniforms:y={time:{value:0},fill:{value:new g(12802834)},stroke:{value:new g(16711680)},noiseA:{value:!1},noiseB:{value:!0},dualStroke:{value:!1},seeThrough:{value:!0},insideAltColor:{value:!1},thickness:{value:.1},secondThickness:{value:.05},dashEnabled:{value:!1},dashRepeats:{value:1},dashOverlap:{value:!1},dashLength:{value:.7},dashAnimate:{value:!1},squeeze:{value:!0},squeezeMin:{value:.28},squeezeMax:{value:1}}}=e;this.spline2material=new f({uniforms:y,side:b,transparent:!0});var x=new p(this.tube1Geometry,this.spline1material);x.name="tube_1";var M=new p(this.tube2Geometry,this.spline2material);M.name="tube_2",this.parent1.add(x),this.parent2.add(M),this.model.add(this.parent1),this.model.add(this.parent2)}removeCubeIfTouchedBySpline(e){this.cubeGroup.traverse((t=>{t.isMesh&&t.visible&&e.forEach((e=>{t.position.distanceToSquared(e)<this.collisionMaxDistance&&(t.visible=!1)}))}))}exit(){var e,t;this.tube1Geometry.setDrawRange(0,this.maximalSplineLength),this.tube2Geometry.setDrawRange(0,this.maximalSplineLength),null!==(e=this.audioTarget1)&&void 0!==e&&e.isPlaying&&this.audioTarget1.stop(),null!==(t=this.audioTarget2)&&void 0!==t&&t.isPlaying&&this.audioTarget2.stop(),this.cubeGroup.traverse((e=>{e.visible=!0}))}tick(e){var{timestamp:t}=e;this.engine.modelSpawned&&(this.lastTimeStamp||(this.lastTimeStamp=this.msBetweenSplineExpansions+1),t-this.lastTimeStamp>=this.msBetweenSplineExpansions&&(this.lastTimeStamp=t,this.expandSpline()))}expandSpline(){var e=this.growSteps*this.radiusSegments*3*this.direction;this.currentDrawRangeMin+=e,this.tube1Geometry.setDrawRange(this.currentDrawRangeMin,this.maximalSplineLength),this.tube2Geometry.setDrawRange(this.currentDrawRangeMin,this.maximalSplineLength);for(var t=[],a=this.tube1Geometry.getAttribute("position").array,i=this.tube2Geometry.getAttribute("position").array,s=3*this.currentDrawRangeMin,n=3*(this.maximalSplineLength+this.currentDrawRangeMin),r=s;r<n;r+=3){var o={x:a[r],y:a[r+1]+this.parent1.position.y,z:a[r+2]};o.y>=0&&t.push(o);var u={x:i[r],y:i[r+1]+this.parent2.position.y,z:i[r+2]};u.y>=0&&t.push(u)}var h=t[t.length-2],l=t[t.length-1];this.repositionAudioTarget(this.audioTarget1,h),this.repositionAudioTarget(this.audioTarget2,l),this.removeCubeIfTouchedBySpline(t)}repositionAudioTarget(e,t){if(t&&e){var a=this.camera.position.distanceToSquared(t),i=e.getVolume(),s=Math.max(.1,Math.min(1,this.audioDistanceMaxMeters/a));Math.abs(i-s)>this.audioThreshold&&e.setVolume(s.toFixed(2))}}}export{y as default};
