import{$ as e,u as t,v as a,x as i,c as n,y as o,M as r,C as s,P as l,V as d,A as c,B as h,D as m,L as u,R as p,E as f,F as v,S as g,W as y,G as w,H as b,I as x,J as T,K as E,N as A,O as S,Q as k,U as C,X as P,Y as _,Z as j,a as O,a0 as I,a1 as L,a2 as R,a3 as B,a4 as F,a5 as D,a6 as W,a7 as z,a8 as H,w as U,a9 as X,aa as N,ab as V,ac as Y,ad as q,ae as G,af as K,ag as Z,ah as J,ai as Q,aj as $,ak as ee,al as te,_ as ae,am as ie,an as ne,ao as oe,ap as re,aq as se,ar as le,as as de,at as ce,au as he,av as me,aw as ue,ax as pe,ay as fe,az as ve,aA as ge,aB as ye,aC as we,aD as be,aE as xe,aF as Te,aG as Ee,aH as Ae,aI as Se,aJ as ke,r as Ce,aK as Me}from"./vendor.js";class Pe{constructor(n){var{scene:o,sceneInstance:r,renderer:s,endSession:l}=n;this.endSession=l,this.engine=n,this.gui=e("#".concat(t)),this.hitSearch=e("#hud-searching-hittest"),this.scene=o,this.renderer=s,this.sceneInstance=r,e.on("#".concat(a),"click",this.onExitButtonClick.bind(this)),i(this),this.animToggler=e("#toggle-animation-button")}setCamera(t){this.cameraAccess=t,t?e.show(this.recordVideoButton):e.hide(this.recordVideoButton)}showAnimToggler(t){this.animToggler&&(this.animToggler.classList.remove("play"),e.show(this.animToggler),this.animTogglerInit||(this.animTogglerInit=!0,this.eventListener=()=>{this.animToggler.classList.toggle("play"),t()},e.on(this.animToggler,"click",this.eventListener)))}hideAnimToggler(){e.hide(this.animToggler)}addSession(e){this.session=e}show(){e.show(this.gui)}hide(){e.hide(this.gui)}onExitButtonClick(){var t=this;return n((function*(){if(t.session)try{yield t.session.end()}catch(e){t.hide()}else yield t.endSession();e.off(t.animToggler,"click",t.eventListener),t.sceneInstance&&t.sceneInstance.exit&&t.sceneInstance.exit(t),o()}))()}showHitSearch(){e.show(this.hitSearch)}hideHitSearch(){e.hide(this.hitSearch)}showElement(t){t.shown||(e.show(t),t.shown=!0)}hideElement(t){t.shown&&(e.hide(t),t.shown=!1)}}class _e extends r{constructor(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},a=arguments.length>2?arguments[2]:void 0;super(e),this.type="Reflector",this.XR=a.XR,this.skybox=a.skybox,this.shadowPlane=a.shadowPlane;var i=this,{textureHeight:n=512,textureWidth:o=512,clipBias:r=0,fragmentShader:y=Oe,vertexShader:w=je}=t,b=void 0!==t.color?new s(t.color):new s(8355711),x=new l,T=new d,E=new d,A=new d,S=new c,k=new d(0,0,-1),C=new h,M=new d,P=new d,_=new h,j=new c,O=new m,I=new f(o,n,{minFilter:u,magFilter:u,format:p});v.isPowerOfTwo(o)&&v.isPowerOfTwo(n)||(I.texture.generateMipmaps=!1);var L={tDiffuse:{value:I.texture},color:{value:b},textureMatrix:{value:j}},R=new g({uniforms:L,fragmentShader:y,vertexShader:w});this.material=R,this.onBeforeRender=(e,t,a)=>{var n;if(E.setFromMatrixPosition(i.matrixWorld),A.setFromMatrixPosition(a.matrixWorld),S.extractRotation(i.matrixWorld),T.set(0,0,1),T.applyMatrix4(S),M.subVectors(E,A),!(M.dot(T)>0)){M.reflect(T).negate(),M.add(E),S.extractRotation(a.matrixWorld),k.set(0,0,-1),k.applyMatrix4(S),k.add(A),P.subVectors(E,k),P.reflect(T).negate(),P.add(E),O.position.copy(M),O.up.set(0,1,0),O.up.applyMatrix4(S),O.up.reflect(T),O.lookAt(P),O.far=a.far,O.updateMatrixWorld(),O.projectionMatrix.copy(a.projectionMatrix),j.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),j.multiply(O.projectionMatrix),j.multiply(O.matrixWorldInverse),j.multiply(i.matrixWorld),x.setFromNormalAndCoplanarPoint(T,E),x.applyMatrix4(O.matrixWorldInverse),C.set(x.normal.x,x.normal.y,x.normal.z,x.constant);var o=O.projectionMatrix;_.x=(Math.sign(C.x)+o.elements[8])/o.elements[0],_.y=(Math.sign(C.y)+o.elements[9])/o.elements[5],_.z=-1,_.w=(1+o.elements[10])/o.elements[14],C.multiplyScalar(2/C.dot(_)),o.elements[2]=C.x,o.elements[6]=C.y,o.elements[10]=C.z+1-r,o.elements[14]=C.w,I.texture.encoding=e.outputEncoding,i.visible=!1;var s=e.getRenderTarget(),l=e.xr.enabled,d=e.shadowMap.autoUpdate;e.xr.enabled=!1,e.shadowMap.autoUpdate=!1,e.setRenderTarget(I),e.state.buffers.depth.setMask(!0),!1===e.autoClear&&e.clear(),this.XR&&this.skybox&&(this.skybox.visible=!0);var c=!1;null!==(n=this.shadowPlane)&&void 0!==n&&n.visible&&(this.shadowPlane.visible=!1,c=!0),e.render(t,O),e.xr.enabled=l,e.shadowMap.autoUpdate=d,e.setRenderTarget(s),this.XR&&this.skybox&&(this.skybox.visible=!1),c&&(this.shadowPlane.visible=!0);var h=a.viewport;void 0!==h&&e.state.viewport(h),i.visible=!0}},this.getRenderTarget=()=>I}}_e.prototype.isReflector=!0;var je="\nuniform mat4 textureMatrix;\nvarying vec4 vUv;\n\n#include <common>\n#include <logdepthbuf_pars_vertex>\n\nvoid main() {\n  vUv = textureMatrix * vec4( position, 1.0 );\n\n  gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n  #include <logdepthbuf_vertex>\n}",Oe="\nuniform vec3 color;\nuniform sampler2D tDiffuse;\nvarying vec4 vUv;\n\n#include <logdepthbuf_pars_fragment>\n\nfloat blendOverlay( float base, float blend ) {\n  return( base < 0.5 ? ( 2.0 * base * blend ) : ( 1.0 - 2.0 * ( 1.0 - base ) * ( 1.0 - blend ) ) );\n}\n\nvec3 blendOverlay( vec3 base, vec3 blend ) {\n  return vec3( blendOverlay( base.r, blend.r ), blendOverlay( base.g, blend.g ), blendOverlay( base.b, blend.b ) );\n}\n\nvoid main() {\n  #include <logdepthbuf_fragment>\n\n  vec4 base = texture2DProj( tDiffuse, vUv );\n  gl_FragColor = vec4( blendOverlay( base.rgb, color ), 1.0 );\n}\n",Ie=["audio","action","actions","buffer","target","distanceTarget"],Le=y.APP_DB.SCENE_TYPES;class Re{constructor(e){var{artifact:t,preload:a,XR:i}=e;this.XR=i,this.artifact=t,this.preload=a;var{type:n=Le.Hit}=t;this.type=n,this.clock=new w,this.scene=new b,this.customMaterials=[],this.spatialObjects=[],this.spatialAnimations=[],this.lookAtCameraObjects=[],this.animateObjects=[],this.audioAnalysers=[],this.audioAnalyserEmissionConfigs=[],this.circlingLights=[],this.customObjects=[],this.videoTargets=[],this.audioRamps={},this.animationListeners=[],this.onResize=this.onResize.bind(this),this.render=this.render.bind(this),this.initFallbackSession=this.initFallbackSession.bind(this),this.toggleAnimations=this.toggleAnimations.bind(this),this.endSession=this.endSession.bind(this)}init(t){var a=this;return n((function*(){var i,{artifact:o,preload:r,scene:s,type:l,XR:d}=a;t&&(a.sceneInstance=t);var{fov:c,near:h,far:u}=x(o.cam,T),p=y.innerWidth/y.innerHeight;a.camera=new m(c,p,h,u),a.camera.updateProjectionMatrix(),s.add(a.camera);var f=new E({antialias:!0,alpha:!0});a.renderer=f,f.setPixelRatio(y.devicePixelRatio),f.domElement.id=A,f.physicallyCorrectLights=!0,f.outputEncoding=S,f.toneMappingExposure=1;var{audio:v,circlingLights:g,clickables:w,customMaterials:b,wireframes:M,customObjects:P,hideLight:_,ocean:j,particles:O,shadow:I,spatialAudio:L,triggerVideo:R,underwater:B}=o;!1!==I&&(f.shadowMap.enabled=!0,f.shadowMap.type=k),a.hud=new Pe(a);var F=null===(i=a.artifact.animateObjects)||void 0===i?void 0:i.some((e=>e.sound));if((v||L||F)&&a.addAudio(),a.addSkybox(),_||a.addLights(),a.videoElement=r.assets.videoElement,null!=t&&t.init&&(yield t.init({engine:a,preload:r})),null!=t&&t.beforeLoadModel&&t.beforeLoadModel({engine:a,preload:r}),yield a.loadModel(),null!=t&&t.afterLoadModel&&t.afterLoadModel({engine:a,preload:r}),null!=g&&g.length&&a.addCirclingLights(),b&&(yield a.addCustomMaterials()),P&&(yield a.addCustomObjects()),M&&M.forEach((e=>{var t=a.model.getObjectByName(e.target);t&&t.material&&(t.material.wireframe=!0,e.transparent&&(t.material.transparent=!0,t.material.opacity=e.opacity))})),R&&a.addVideoTrigger(),B&&(yield a.underwaterPlane()),j&&(yield a.oceanPlane()),O){var{Particles:D}=yield import("./Particles.js");a.particles=new D(a),yield a.particles.init()}if(f.setSize(y.innerWidth,y.innerHeight),e.append(f.domElement,"#".concat(C)),d)try{var W=f.xr.getController(0);a.controller=W;var{clickable:z,shadow:H,shadowPlane:U}=o;if(!1!==H&&!1!==U&&a.addShadowPlane(),!a.isHittestScene())throw new Error("Unknown scene type ".concat(l));l!==Le.Float&&a.spawnReticle(),e.on(W,"select",(()=>{if(!a.justUnspawned){a.spawnModel(!1),z?a.hud.showAnimToggler(a.toggleAnimations):a.hud.hideAnimToggler()}})),z||a.hud.hideAnimToggler(),s.add(W),a.initScene=n((function*(){var t;return e.hide("#Locator"),t=yield y.NAV.xr.requestSession("immersive-ar",{requiredFeatures:["hit-test","dom-overlay"],domOverlay:{root:e("#hud")}}),e.on(t,"end",(()=>{a.endSession()})),a.hud.addSession(t),a.refSpace=yield t.requestReferenceSpace("viewer"),a.renderer.xr.enabled=!0,a.renderer.xr.setReferenceSpaceType("local"),yield a.renderer.xr.setSession(t),t.initFallbackSession=a.initFallbackSession.bind(a),t}))}catch(e){a.initScene=a.initFallbackSession}else a.initScene=a.initFallbackSession;return null!=w&&w.length&&(yield a.addClickables()),e.on(y,"resize",a.onResize),a.onResize(),f.setAnimationLoop(a.render),a}))()}onResize(){var{innerWidth:e,innerHeight:t}=y;this.camera.aspect=e/t,this.camera.updateProjectionMatrix(),this.renderer.setSize(e,t)}addLights(){var{directionalLightPosition:e=_.directionalPosition}=this.artifact,t=new P(_.directionalColor,_.directionalIntensity);t.position.set(...e),t.castShadow=!0,!1!==this.artifact.shadow&&(t.shadow.bias=-1e-4,t.shadow.mapSize.width=512,t.shadow.mapSize.height=512,t.shadow.camera.near=.1,t.shadow.camera.far=300),this.directionalLight=t,this.scene.add(t),this.ambientLight=new j(_.ambientColor,_.ambientIntensity),this.scene.add(this.ambientLight)}addCustomMaterials(){var{preload:e}=this,{customMaterials:t=[]}=e.assets;t.forEach((e=>{var{config:t,material:a}=e,i=this.model.getObjectByName(t.target);i&&(i.material=a,O.fn(a.init)&&a.init({engine:this}),this.customMaterials.push({config:t,material:a}))}))}addCustomObjects(){var{artifact:e}=this,{customObjects:t}=e;t.forEach((e=>{var{config:t,object:a}=e,i=this.model.getObjectByName(t.target);i&&(a.child?i.add(a.child):a.model&&(i.parent.add(a.model),i.parent.remove(i)),this.customObjects.push({config:t,object:a}),O.fn(a.init)&&a.init({engine:this}))}))}addShadowPlane(){var e=new I(150,150,64,64),t=new L;t.opacity=R;var a=new r(e,t);a.receiveShadow=!0,a.lookAt(0,100,0),a.position.set(0,.01,0),this.shadowPlane=a}spawnReticle(){var e=new B(.15,.2,32).rotateX(-M.PI/2),t=new F;this.reticle=new r(e,t),this.reticle.matrixAutoUpdate=!1,this.reticle.visible=!1,this.scene.add(this.reticle)}onAnimationLoop(){for(var e=arguments.length,t=new Array(e),a=0;a<e;a++)t[a]=arguments[a]}onAnimationFinished(){for(var e=arguments.length,t=new Array(e),a=0;a<e;a++)t[a]=arguments[a]}glow(){var{glow:e}=this.artifact;this.model.traverse((t=>{if(D(t.name,"glow")){var a=O.bool(e)?238:e,i=new F({color:a,side:W,blending:z,transparent:!0});t.material=i}}))}addClickables(){var t=this;return n((function*(){var{artifact:a,model:i}=t,{clickables:n=[]}=a,o=[];if(!0===n?o.push(t.model):n.length&&i.traverse((e=>{n.forEach((a=>{if(O.str(a)&&(a={target:a}),H({node:e,search:a.target})){var i;a.node=e;var n=!0===a.audio?e.name:a.audio;null!==(i=t.preload.assets.audioElements)&&void 0!==i&&i.length&&(a.player=t.preload.assets.audioElements.find((e=>e.dataset.name===n))),o.includes(a)||o.push(a)}}))})),o.length){var{Controls:r}=yield import("./Controls.js");t.controls=new r({clickables:o,engine:t}),t.controller?e.on(t.controller,"select",t.controls.select,!1):e.on(t.renderer.domElement,"mousedown",t.controls.click,!1)}}))()}onTouch(t){var a=this;return n((function*(){var i;null!==(i=a.sceneInstance)&&void 0!==i&&i.onTouch&&(yield a.sceneInstance.onTouch(t)),t.forEach(((t,i)=>{if(!(i+1>a.artifact.maxTouches)){var{emission:n,emissionIntensity:o=.2,link:r,player:l}=t;if(r&&(U?window.location.href=r:window.open(r,"_hacked")),l&&(l.loop?l.paused?l.play():(l.currentTime=0,l.pause()):(l.currentTime=0,l.play())),n){var d=t.node.name.split("_")[0],c=a.model.getObjectByName(d);if(!c)return;("Group"===c.type?c.children:[c]).forEach((t=>{if(t&&(t.userData.origEmissive||(t.userData.origEmissive=t.material.emissive),t.userData.origEmissiveIntensity||(t.userData.origEmissiveIntensity=t.material.emissiveIntensity),l))if(X.same(t.material.emissive,t.userData.origEmissive)){var a=new s(1,1,1);O.bool(n)?t.material.color&&(a=t.material.color):O.arr(n)&&(a=new s(...n)),t.material.emissive=a,t.material.emissiveIntensity=o,l.loop||e.on(l,"ended",(()=>{t.material.emissive=t.userData.origEmissive,t.material.emissiveIntensity=t.userData.origEmissiveIntensity}))}else l.loop&&(t.material.emissive=t.userData.origEmissive,t.material.emissiveIntensity=t.userData.origEmissiveIntensity)}))}}}))}))()}nosort(){this.renderer.sortObjects=!1}clip(){var{model:e,artifact:t}=this,{clipSide:a,clipInFallback:i}=t;e.traverse((e=>{if(D(e.name,"clip"))if(this.XR||!1!==i){var t=W;"back"===a?t=Z:"front"===a&&(t=me),e.material=new F({color:"green",colorWrite:!1,side:t}),e.castShadow=!1,e.receiveShadow=!1,e.renderOrder=1}else e.visible=!1;else e.renderOrder=2}))}mirror(){var{mirrors:e}=this.artifact,t=y.devicePixelRatio,a=y.innerWidth*t,i=y.innerHeight*t;this.mirrors=e.map((e=>{var t,{clipBias:n=.003,color:o=7829367,type:r,params:s=[4,32],rotation:l={},position:d={}}=e,c=APP_DB.MESH_TYPES;t=r===c.CIRCLE?new N(...s):r===c.PLANE?new I(...s):r===c.RING?new B(...s):r===c.BOX?new V(...s):r===c.SPHERE?new Y(...s):new I(...s);var h=new _e(t,{clipBias:n,textureWidth:a,textureHeight:i,color:o},this),{x:m,y:u,z:p}=l;m&&h.rotateX(v.degToRad(m)),u&&h.rotateY(v.degToRad(u)),p&&h.rotateZ(v.degToRad(p));var{x:f,y:g,z:y}=d;return f&&h.position.setX(f),g&&h.position.setY(g),y&&h.position.setZ(y),this.model.add(h),h}))}addCirclingLights(){this.artifact.circlingLights.forEach((e=>{var{color:t=16711680,intensity:a=1,dim:i=0,decay:n=2,shadows:o=!1,show:s=!1}=e,l=new q(t,a,i,n);if(o&&(l.castShadow=!0,l.shadow.camera.near=.1,l.shadow.camera.far=5),s){var d=new Y(.005,6,6),c=new F({color:t}),h=new r(d,c);l.add(h)}this.circlingLights.push({light:l,config:e}),this.model.add(l)}))}analyseAudio(){var e,{audioElement:t,audioElements:a=[]}=this.preload.assets;(t||null!=a&&a.length)&&([t,...a].filter((e=>e)).forEach((e=>{var t=new AudioContext,a=t.createMediaElementSource(e),i=t.createAnalyser();i.fftSize=this.artifact.fftSize||32,a.connect(i),a.connect(t.destination);var n=new Uint8Array(i.frequencyBinCount);i.getByteFrequencyData(n),this.audioAnalysers.push({name:e.id,analyser:i,array:n})})),null===(e=this.artifact.audioAnalyserEmission)||void 0===e||e.forEach((e=>{var t=x(e,{intensity:.004,minIntensity:0,color:[],target:""}),a=[];this.model.traverse((e=>{var i;H({node:e,search:t.target})&&(e.material?a.includes(e.material)||a.push(e.material):null!==(i=e.children)&&void 0!==i&&i.length&&e.children.forEach((e=>{e.material&&a.push(e.material)})))})),t.targets=a,t.targets.length,this.audioAnalyserEmissionConfigs.push(t)})))}underwaterPlane(){var e=this;return n((function*(){var{UnderwaterPlane:t}=yield import("./UnderwaterPlane.js");e.cameraPlane=new t,yield e.cameraPlane.preload(e)}))()}oceanPlane(){var e=this;return n((function*(){var{name:t="ocean",normals:a="oceannormals1"}=e.artifact.ocean,{Water:i}=yield import("./vendor.js").then((function(e){return e.bb})),n=e.model.getObjectByName(t),o=yield e.preload.promisifiedLoad({loader:e.preload.textureLoader,file:"https://static.artificialmuseum.com/textures/ocean/".concat(a,".jpg")});o.wrapS=o.wrapT=G,e.ocean=new i(n.geometry,{textureWidth:512,textureHeight:512,waterNormals:o,sunDirection:new d,sunColor:16777215,waterColor:1048575,distortionScale:3.7,fog:!1}),e.ocean.position.copy(n.position),e.ocean.rotation.copy(n.rotation),e.model.add(e.ocean),n.visible=!1}))()}addSkybox(){var e=this;return n((function*(){var{artifact:t,preload:a,renderer:i,scene:n,XR:o}=e,s=ue,l=null==t?void 0:t.skySphere;O.arr(l)&&l.length&&(s=l);var d=new Y(...s),c=a.assets.skybox,h=new K(i);h.compileEquirectangularShader();var m=h.fromEquirectangular(c).texture;h.dispose();var u=new F({map:c,side:Z}),p=new r(d,u);p.rotation.y=v.degToRad(180),p.visible=!o,n.add(p),!1===t.light||t.hideEnvironment||(n.environment=m),e.skybox=p}))()}addAudio(){this.listener=new J,this.camera.add(this.listener)}addVideoTrigger(){this.model.traverse((e=>{this.videoTrigger||["videotarget","videotrigger"].some((t=>D(e.name,t)))&&(this.videoTrigger=e,this.videoTrigger.visible=!1)}))}startMedia(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];if(!this.isMediaPlaying){var{actions:t=[],artifact:a,preload:i}=this,{audioElement:n,videoElement:o,audioElements:r=[]}=i.assets;a.triggerAudio||(n&&(e&&(n.currentTime=0),n.play()),null!=r&&r.length&&r.forEach((t=>{t.autoplay&&(e&&(t.currentTime=0),t.play())}))),o&&!a.triggerVideo&&(e&&(o.currentTime=0),o.play()),t.forEach((e=>e.play())),this.isMediaPlaying=!0}}stopMedia(){var{audioElement:e,videoElement:t,actions:a=[],audioElements:i=[]}=this;e&&e.pause(),t&&t.pause(),a&&a.length&&a.forEach((e=>e.stop())),i.forEach((e=>e.pause())),this.isMediaPlaying=!1}toggleAnimations(){this.actions.forEach((e=>e.paused=!e.paused))}initFallbackSession(){this.XR=!1,y.B.classList.add(Q);var{camera:e,artifact:t,model:a,renderer:i}=this,n=new $(e,i.domElement);this.controller=n,this.skybox.visible=!0,Object.entries(ee).forEach((e=>{var[t,a]=e;n[t]=a}));var{cam:o={},orbit:r={},clickable:s}=t;O.num(r.min)&&(n.minDistance=r.min),O.num(r.max)&&(n.maxDistance=r.max),O.num(o.maxPolar)&&(n.maxPolarAngle=v.degToRad(o.maxPolar)),O.num(o.minPolar)&&(n.minPolarAngle=v.degToRad(o.minPolar)),s?this.hud.showAnimToggler(this.toggleAnimations):this.hud.hideAnimToggler();var{cam:l={}}=t,c=pe,{x:h=c.x,y:m=c.y,z:u=c.z}=l;e.position.set(h,m,u);var{lookat:p={}}=t,{x:f=0,y:g=0,z:w=0}=p;if(n.target=new d(f,g,w),a){var{x:b,y:x,z:T}=a.scale,{scale:E}=t;E&&a.scale.set(b*E,x*E,T*E)}n.update();this.spawnModel(!0),i.domElement.focus()}loadModel(){var e=this;return n((function*(){var t,a,i,o,{artifact:r,preload:s,sceneInstance:l={}}=e;null!=l&&l.model?e.model=l.model:null!==(t=s.assets.gltf)&&void 0!==t&&t.scene&&(e.model=s.assets.gltf.scene);var d=x(r.ply,{vertexColors:!0,size:"0.001",sizeAttenuation:0,opacity:"1.0"});e.morphTargetInfluenceConfig=x(r.ply,{animated:!1,delay:1e3,speed:1});var c=new te(ae(ae({},d),{},{transparent:"1.0"!==d.opacity})),h=new ie;if(O.arr(s.assets.ply)&&null!==(a=s.assets.ply)&&void 0!==a&&a.length)if(e.morphTargetInfluenceConfig.animated){var[m]=s.assets.ply;m.morphAttributes={position:[],color:[]},s.assets.ply.forEach((e=>{m.morphAttributes.position.push(e.attributes.position),m.morphAttributes.color.push(e.attributes.color)}));var{size:u,sizeAttenuation:p,vertexColors:f}=x(r.plyanim,{vertexColors:!0,size:.03,sizeAttenuation:1e-4}),v=new te({size:u,sizeAttenuation:p,vertexColors:f}),g=new ne(m,v);g.morphTargetInfluences[0]=1,e.animatedPoints=g,e.morphTargetTargetIndex=1,h.add(g)}else s.assets.ply.forEach((e=>{h.add(new ne(e,c))}));else h.add(new ne(s.assets.ply,c));if(e.model?e.model.add(h):e.model=h,null!=l&&l.animations?e.animations=l.animations:null!==(i=s.assets.gltf)&&void 0!==i&&i.animations&&(e.animations=s.assets.gltf.animations),e.actions=[],null!==(o=e.animations)&&void 0!==o&&o.length){e.mixer=new oe(e.model);var{animations:y={}}=r,{loop:w,startOnTouch:b,clampWhenFinished:T=!0,autoplay:E=!0,noLoopAnimations:A=[],pausedAnimations:k=[]}=y;e.animations.forEach((t=>{var a=e.mixer.clipAction(t),i=e.spatialAnimations.find((e=>e._clip.name===a.name)),n=k.includes(t.name),o=b||!E||i||n;(!1===w||A.includes(t.name))&&(a.clampWhenFinished=T,a.loop=re),o&&(a.paused=!0),e.actions.push(a)}))}if(e.model){var C,M={};e.model.traverse((t=>{var a;if(l.parentName&&l.child&&D(t.name,l.parentName)&&(C=t),e.customObjects.forEach((e=>{var{object:a}=e;a.parentName&&a.child&&D(t.name,a.parentName)&&(M[a.name]=t)})),t.isMesh){var{frustumCulled:i,transparent:n,castShadow:o,receiveShadow:s}=r;!1===i&&(t.frustumCulled=!1),!1===n&&(t.material.transparent=!1),D(t.name,"noshadow")||(t.castShadow=!1!==o,t.receiveShadow=!1!==s),D(t.name,"videotarget")&&e.videoTargets.push(t),t.material.map&&(t.material.map.anisotropy=16,t.material.map.encoding=S),t.material.emissiveMap&&(t.material.emissiveMap.encoding=S),(t.material.map||t.material.emissiveMap)&&(t.material.needsUpdate=!0)}if(null!==(a=r.lookAtCameraObjects)&&void 0!==a&&a.length){var d=r.lookAtCameraObjects.find((e=>H({node:t,search:O.str(e)?e:e.name})));if(d){O.num(e.lookAtAlpha)||(e.lookAtAlpha=0);var{speed:c,lookAtY:h,fromLookAtY:m}=d;O.num(c)||(c=O.num(e.artifact.lookAtSpeed)?e.artifact.lookAtSpeed:.001),!O.bool(h)&&O.bool(e.artifact.lookAtY)&&(h=!O.bool(e.artifact.lookAtY)||e.artifact.lookAtY),O.num(m)||(m=O.num(e.artifact.fromLookAtY)?e.artifact.fromLookAtY:0),e.lookAtCameraObjects.push({speed:c,lookAtY:h,fromLookAtY:m,node:t})}}var u=[];r.animateObjects&&r.animateObjects.forEach((a=>{if(D(t.name,a.name)){var i=e.actions.find((e=>e._clip.name===t.name));if(a.sound){!0===a.sound&&(a.sound={name:e.artifact.slug}),a.sound.name||(a.sound.name=e.artifact.slug);var n=e.preload.assets.animateObjects[a.sound.name];if(n){var o=new se(e.listener);o.setBuffer(n);var{loopSound:r=!0}=a;if(o.setLoop(r),a.audio=o,a.sound.distance){var s=!1!==a.sound.yDistanceTest;u.push({buffer:o,distance:a.sound.distance,distanceTarget:t.name,target:t.name,yDistanceTest:s})}}}e.animateObjects.push(ae(ae({},a),{},{action:i,node:t}))}}));var{spatialObjects:p=[],audioElements:f=[]}=r,v=[...p,...f,...u];v.length&&v.forEach((a=>{var{audio:i,action:n,actions:o,buffer:r,target:s,distanceTarget:l}=a,d=le(a,Ie);if(H({node:t,search:s})){var c=ae(ae({},d),{},{node:t});if(l&&(c.distanceTarget=e.model.getObjectByName(l)),r)c.audio=r;else if(i){var h;null!==(h=e.preload.assets.audioElements)&&void 0!==h&&h.length&&(c.audio=e.preload.assets.audioElements.find((e=>e.dataset.name===i)))}var m=[];if(O.arr(o)&&o.length&&(e.actions.filter((e=>o.includes(e._clip.name))),de("finalActions")),n){var u=e.actions.find((e=>e._clip.name===n));u&&m.push(u),c.off||e.spatialAnimations.push(c.action)}m.length&&(c.actions=m),e.spatialObjects.push(c)}}))})),C&&C.add(l.child),e.customObjects.forEach((t=>{var{object:a}=t;a.child?M[a.name].add(a.child):a.model&&e.model.add(a.model)})),e.videoElement&&e.videoTargets.length&&(yield Promise.all(e.videoTargets.map(function(){var t=n((function*(t){var a=new fe(e.videoElement),{flipVideo:i,chromaKey:n}=r;if(!1!==i&&(a.flipY=!1),t.material.map=a,n){var{ChromaKeyMaterial:o}=yield import("./materials/ChromaKeyMaterial.js");t.material=new o(r.chromaKey,a)}}));return function(e){return t.apply(this,arguments)}}())))}var{clip:P,glow:_,mirrors:j,nosort:I}=e.artifact;_&&e.glow(),e.model&&P&&e.clip(),I&&e.nosort(),null!=j&&j.length&&e.mirror(),e.artifact.analyseAudio&&e.analyseAudio(),e.model&&(e.model.position.set(5e3,5e3,5e3),e.scene.add(e.model))}))()}spawnModel(e){var t,{artifact:a,camera:i,controller:n,floatSpawnAtZeroY:o=!1,model:r,reticle:s,scene:l,sceneInstance:d={},shadowPlane:c,type:h,XR:m}=this,{showSkybox:u}=a;if(!m||e)r&&(this.applyPositionAndRotation(),r.position.set(0,0,0)),this.modelSpawned=!0,null!=d&&d.spawnModel&&d.spawnModel({engine:this}),null!=d&&d.afterSpawnModel&&d.afterSpawnModel({engine:this});else if(this.isHittestScene()){if(!this.modelSpawned&&this.lastHit){s.updateMatrixWorld(),r.position.setFromMatrixPosition(s.matrixWorld),r.updateMatrixWorld();var p=i.position,f=r.position,v=p.x-f.x,g=p.z-f.z,y=Math.atan2(v,g);r.rotation.y=y,c&&(c.position.setFromMatrixPosition(s.matrixWorld),l.add(c)),r.visible=!0,s.visible=!1,this.modelSpawned=!0,null!=d&&d.spawnModel&&d.spawnModel({engine:this}),null!=d&&d.afterSpawnModel&&d.afterSpawnModel({engine:this})}this.applyPositionAndRotation()}else if(h===Le.Float){var w=r.clone();w.position.set(0,0,-1).applyMatrix4(n.matrixWorld),o&&(w.position.y=0),this.applyPositionAndRotation(),l.add(w)}if(this.startMedia(),u&&(this.skybox.visible=!0),null!==(t=this.preload.gui)&&void 0!==t&&t.afterSpawnModel){var{afterSpawnModel:b}=this.preload.gui;b.style.visibility="visible",b.style.opacity=1,setTimeout((()=>{var e;O.fn(null===(e=b.parentNode)||void 0===e?void 0:e.removeChild)&&b.parentNode.removeChild(b)}),8e3)}}unspawnModel(){this.modelSpawned&&(this.scene.remove(this.model),this.modelSpawned=!1,this.isAnimationRunning=!1,this.stopMedia(),this.exitSceneInstance(),this.justUnspawned=!0,setTimeout((()=>{this.justUnspawned=!1}),200))}exitSceneInstance(){var e;this.customObjects.forEach((e=>{var{object:t}=e;O.fn(t.exit)&&t.exit({engine:this})})),this.customMaterials.forEach((e=>{var{material:t}=e;O.fn(t.exit)&&t.exit({engine:this})})),this.animateObjects.forEach((e=>{var t;null===(t=e.audio)||void 0===t||t.stop()})),null!==(e=this.sceneInstance)&&void 0!==e&&e.exit&&this.sceneInstance.exit({engine:this})}applyPositionAndRotation(){var{artifact:e,model:t}=this;if(t){var{pos:a={},rot:i={}}=e;a.x&&(t.position.x+=a.x),a.y&&(t.position.y+=a.y),a.z&&(t.position.z+=a.z);var n=v.degToRad;i.x&&t.rotateX(n(i.x)),i.y&&t.rotateY(n(i.y)),i.z&&t.rotateZ(n(i.z))}}endSession(){var t=this;return n((function*(){t.hud.hide(),t.renderer.setAnimationLoop(null),e("#".concat(C)).classList.remove("visible"),t.exitSceneInstance(),t.scene&&ce(t.scene),e.remove(".".concat(he));var a=e("#".concat(A));if(a){var i=a.parentNode;i.id===C?e.remove(a):e.remove(i)}y.B.classList.remove(Q),e(".start-experience-button").forEach((e=>{e.removeAttribute("disabled")})),U&&y.location.reload()}))()}isHittestScene(){return![Le.Float].includes(this.type)}render(e,t){var a=this;return n((function*(){var i,n,o,r,s,l,d,c,h=a.clock.getDelta();a.renderHittest(t),a.mixer&&a.mixer.update(h);var m={delta:h,timestamp:e,engine:a,frame:t};a.modelSpawned&&a.artifact.triggerVideo&&a.videoTrigger&&a.renderVideoTrigger(),null!==(i=a.sceneInstance)&&void 0!==i&&i.tick&&a.sceneInstance.tick(m),null!==(n=a.spatialObjects)&&void 0!==n&&n.length&&a.modelSpawned&&a.renderSpatial(m),null!==(o=a.audioAnalysers)&&void 0!==o&&o.length&&a.renderAnalyseAudio(m),null!==(r=a.circlingLights)&&void 0!==r&&r.length&&a.renderCirclingLights(m),null!==(s=a.artifact.ply)&&void 0!==s&&s.animated&&a.renderPlyMorphTargetInfluences(m),null!==(l=a.lookAtCameraObjects)&&void 0!==l&&l.length&&a.renderLookAtCamera(m),null!==(d=a.animateObjects)&&void 0!==d&&d.length&&a.renderAnimateObjects(m),a.cameraPlane&&a.renderUnderwater(m),a.ocean&&a.renderOcean(m),a.particles&&a.particles.update(m),a.customMaterials.length&&a.renderCustomMaterials(m),a.customObjects.length&&a.renderCustomObjects(m),null!==(c=a.sceneInstance)&&void 0!==c&&c.render?a.sceneInstance.render(m):a.renderer.render(a.scene,a.camera)}))()}renderPlyMorphTargetInfluences(e){var{delta:t,timestamp:a}=e;this.nextMorphTargetStep||(this.nextMorphTargetStep=a+this.morphTargetInfluenceConfig.delay);var i=this.animatedPoints,n=i.morphTargetInfluences.length-1,o=t*this.morphTargetInfluenceConfig.speed;i.morphTargetInfluences=i.morphTargetInfluences.map(((e,t)=>{if(t===this.morphTargetTargetIndex){var i=Math.min(e+o,1);return i>=1&&a>this.nextMorphTargetStep&&(this.nextMorphTargetStep=a+this.morphTargetInfluenceConfig.delay,this.hasRun=!this.hasRun,this.hasRun||(this.morphTargetTargetIndex+=1,this.morphTargetTargetIndex>n&&(this.morphTargetTargetIndex=0))),i}return Math.max(e-o,0)}))}renderCustomMaterials(e){var{delta:t}=e;this.customMaterials.forEach((a=>{var{config:i,material:n}=a;if(n.uniforms.uTime){var{speed:o=1}=i;n.uniforms.uTime.value+=t*o}O.fn(n.tick)&&n.tick(e)}))}renderCustomObjects(e){this.customObjects.forEach((t=>{var{object:a}=t;O.fn(a.tick)&&a.tick(e)}))}renderLookAtCamera(e){var{delta:t}=e,{camera:a,lookAtCameraObjects:i=[]}=this;i.forEach((e=>{var{lookAtY:i=!0,fromLookAtY:n=0,node:o,speed:r}=e,s=new d(0,n,o.position.distanceTo(a.position));o.localToWorld(s);var l=s.clone();if(this.lookAtAlpha+=t*r,l.distanceToSquared(a.position)>.5){var c=a.position.clone();!1===i&&(c.y=o.position.y),l.lerp(c,Math.min(1,this.lookAtAlpha)),o.lookAt(l)}}))}renderAnimateObjects(e){var{timestamp:t}=e;this.animateObjects.forEach((e=>{var{action:a,audio:i,speed:n,minSpeed:o=0,maxDelay:r=2,minDelay:s=1}=e;if(a&&a.paused&&(e.nextAnimation||(e.nextAnimation=t+Math.random()*(1e3*r)+1e3*s),i.isPlaying&&i.stop(),e.nextAnimation<=t)){e.nextAnimation=!1;var l=Math.random()>.5?1:-1,d=Math.max(o,Math.random()*n)*l;a.timeScale=d,a.paused=!1,a.play(),i&&!i.isPlaying&&i.play()}}))}renderVideoTrigger(){var{triggerVideoDistance:e=1.1,triggerAudio:t,triggerVideo:a=!0}=this.artifact,i=e*e,n=this.videoTrigger.position.clone();n.add(this.videoTrigger.parent.position),this.camera.position.distanceToSquared(n)<=i?(a&&this.videoElement&&this.videoElement.paused&&(this.videoElement.play(),this.videoTrigger.visible=!0),t&&this.audioElement&&this.audioElement.paused&&this.audioElement.play()):(!this.videoElement.paused&&a&&(this.videoElement.pause(),this.videoTrigger.visible=!1),t&&this.audioElement&&!this.audioElement.paused&&this.audioElement.pause())}renderHittest(t){var a=this;return n((function*(){if(t&&a.XR){var i=a.renderer.xr.getSession();a.hitTestSourceRequested||(a.hitTestSource=yield i.requestHitTestSource({space:a.refSpace}),e.on(i,"end",(()=>{a.hitTestSourceRequested=!1,a.hitTestSource=null})),a.hitTestSourceRequested=!0);var n=t.getHitTestResults(a.hitTestSource);if(n.length){if(a.lastHit=n[0],!a.modelSpawned){a.reticle.visible=!0;var o=a.renderer.xr.getReferenceSpace();a.reticle.matrix.fromArray(a.lastHit.getPose(o).transform.matrix)}a.hud.hideHitSearch()}else a.reticle.visible=!1,a.modelSpawned||a.hud.showHitSearch(),a.lastHit=void 0}}))()}renderAnalyseAudio(e){var t,{delta:a,timestamp:i,frame:n}=e,{audioAnalyserAnimation:o,audioAnalyserAnimations:r=[],audioAnalyserLights:l}=this.artifact,{audioAnalyserEmissionConfigs:d}=this,c=0,h=this.audioAnalysers.map((e=>{var{name:t,analyser:a,array:i}=e;a.getByteFrequencyData(i);var n=i.reduce(((e,t)=>e+t))/i.length;return this.audioRamps[t]={array:i,average:c},c+=n,i})),m=c/255;if(O.fn(null===(t=this.sceneInstance)||void 0===t?void 0:t.renderAudioAnalyser)&&this.sceneInstance.renderAudioAnalyser({average:c,values:h,delta:a,timestamp:i,frame:n,engine:this}),o||r.length){var u=x(this.artifact,{audioAnalyserIntensity:1}),p=Math.min(1,c*u.audioAnalyserIntensity/220);if(o){var f=this.actions.find((e=>e._clip.name===o));f.weight=p,f.time=f._clip.duration}r.length&&this.actions.forEach((e=>{var t=e._clip.name,a=r.find((e=>e===t||e.action===t));if(a){if(O.obj(a)){var{useAverage:i=!0}=a;if(i)e.weight=p;else{var{index:n=6,divisor:o=220}=a,s=h.map((e=>e[n])).reduce(((e,t)=>e+t)),l=Math.min(1,s/o);e.weight=l}}else e.weight=p;e.time=e._clip.duration}}))}if(l){var v=x(this.artifact,{lightIntensity:1,levelMultiplier:2}),g=v.lightIntensity*(m*v.levelMultiplier),{ambientLight:y}=this;y.intensity=g}null!=d&&d.length&&d.forEach((e=>{var t=e.intensity*m;e.targets.forEach((a=>{var i;t>e.minIntensity?a.emissiveIntensity=t:a.emissiveIntensity=0,null!==(i=e.color)&&void 0!==i&&i.length&&(a.emissive=new s(...e.color))}))}))}renderCirclingLights(e){var{timestamp:t}=e,a=5e-4*t;this.circlingLights.forEach((e=>{var{light:t,config:i}=e,{lightDistance:n=1,timeOffset:o=20,offset:{x:r=0,y:s=0,z:l=0}={}}=i;a+=1e3*o;var d=Math.sin(a)*n+r,c=Math.sin(1.1*a)*n+s,h=Math.sin(1.2*a)*n+l;t.position.set(d,c,h)}))}renderSpatial(){this.spatialObjects.forEach((e=>{var{node:t,distanceTarget:a,exclusive:i=!1,restart:n,actions:o,audio:r,off:s,fn:l,yDistanceTest:c=!0}=e,{distance:h={max:2,min:0}}=e,m=a||t,u=new d;m.getWorldPosition(u);var p=c?u.y:this.camera.position.y,f=new d(u.x,p,u.z),v=this.camera.position.distanceTo(f);if(O.num(h)?h={min:0,max:h}:h.hasOwnProperty("min")||(h.min=0),r){var g=O.fn(r.getVolume)?r.getVolume():r.volume,y=Math.max(0,Math.min(1,1-v/h.max+h.min/h.max));Math.abs(g-y)>.02&&(y>0&&r.paused&&r.play(),O.fn(r.setVolume)?r.setVolume(y):r.volume=y),n&&(v>h.max||v<h.min)&&(r.currentTime=0,r.pause())}o&&o.length&&o.forEach((e=>{v<=h.max&&v>=h.min?s?e.paused||(e.paused=!0):e.paused&&(i?this.actions.forEach((t=>{t!==e?t.paused||(t.paused=!0):t.paused&&(t.paused=!1)})):e.paused=!1):s?e.paused&&(e.paused=!1):e.paused||(e.paused=!0)})),l&&O.fn(this.sceneInstance[l])&&this.sceneInstance[l]({node:t,config:{distance:h},distance:v})}))}renderMaterialFades(e){}renderUnderwater(e){var{delta:t}=e;this.cameraPlane.tick(t)}renderOcean(e){var{delta:t}=e,{animationSpeed:a=1}=this.artifact.ocean;this.ocean.material.uniforms.time.value+=t*a*.1}}class Be{constructor(t){var{artifact:a,root:i,THREE:n}=t;this.artifact=a,this.root=i,n&&(this.THREE=n);var{android:o,chrome:r}=Ce;this.isAndroidChrome=o&&r,this._warningContainer=e("#timeout-warning"),this._header=e("#timeout-warning-header"),this._headerDone=e("#timeout-warning-header-done"),this._preloadInfo=e("#timeout-warning-info"),this._cancelButton=e("#timeout-warning-cancel"),this._confirmButton=e("#timeout-warning-confirm"),this._tooFarContainer=e("#toofar-warning"),this._tooFarPreviewButton=e("#toofar-warning-load-preview-button"),this._tooFarDistanceInfo=e("#toofar-warning-distance"),this._tooFarCancelButton=e("#toofar-warning-cancel-button"),this._tooFarAbortButton=e("#toofar-warning-abort-button"),this._webglDisabledContainer=e("#timeout-warning-webgl-disabled"),this._webglDisabledOkButton=e("#timeout-warning-webgl-disabled-ok-button"),this.confirmButtonClickHandler=this.confirmButtonClickHandler.bind(this),e.on(this._confirmButton,"click",this.confirmButtonClickHandler),this.onTooFarCancelButtonClick=this.onTooFarCancelButtonClick.bind(this),this.onTooFarPreviewButtonClick=this.onTooFarPreviewButtonClick.bind(this),this.onWebglDisabledOkButtonClick=this.onWebglDisabledOkButtonClick.bind(this),this.textureLoader=new ve,this.gltfLoader=new ge,this.plyLoader=new ye,this.audioLoader=new we,this.fontLoader=new be,this.audioElements=[],this.collectPreloadPromises(),this.startEngine=this.startEngine.bind(this)}collectPreloadPromises(){var e={skybox:this.loadSkybox()},{animateObjects:t,audio:a,audioElements:i,customMaterials:n,customObjects:o,examples:r,fonts:s,glb:l,gui:d,ply:c,textures:h,type:m,video:u}=this.artifact;if(i&&(e.audioElements=this.loadAudioElements()),a&&(e.audioElement=this.loadAudio()),xe(m)||(e.scene=this.loadScene()),!1!==l&&(e.gltf=this.loadGltf()),c&&(e.ply=this.loadPly()),h&&(e.textures=this.loadTextures()),u){var{slug:p,video:f}=this.artifact;e.videoElement=this.loadVideo({slug:p,video:f})}s&&(e.fonts=this.loadFonts()),r&&(e.examples=this.loadExamples()),d&&this.loadGui(),n&&(e.customMaterials=this.loadCustomMaterials()),o&&(e.customObjects=this.loadCustomObjects()),t&&(e.animateObjects=this.loadAnimateObjects()),this.promises=e}init(){var t=arguments,a=this;return n((function*(){var i=t.length>0&&void 0!==t[0]?t[0]:{},{map:n,XR:o}=i;a._isWorking=!0,a._isCancelled=!1,a._session=!1,a.map=n,a.XR=o,e.on(a._cancelButton,"click",(()=>{a._isCancelled=!0,a.finished()})),e.show([a._warningContainer,a._header]),a.timeout=y.setTimeout(a.showTimeoutWarning,Te)}))()}loadScene(){var t=this;return n((function*(){var{artifact:a}=t,i=APP_DB.SCENE_TYPES,{type:n=i.Hit}=a,o=Object.entries(i).find((e=>{var[t,a]=e;return a===n})),r="".concat(t.root,"/CustomScene.js");if(O.arr(o)){var s=o[0];r="./scenes/".concat(s,".js")}var{default:l}=yield import(r),d=new l({artifact:a,mergeConfig:x,preload:t,$:e,W:y,is:O});return O.fn(null==d?void 0:d.preload)&&(yield d.preload({artifact:a,preload:t})),d}))()}loadSkybox(){var e=this;return n((function*(){var{city:t,sky:a,slug:i}=e.artifact,n=a||i,o="jpg";y.SUPPORTS.WEBP&&(o="webp");var r=n;return n.startsWith("/")||(r=[y.STATIC_URL,"skybox",t,n].filter((e=>e)).join("/")),r.endsWith(".".concat(o))||(r+=".".concat(o)),yield e.promisifiedLoad({loader:e.textureLoader,file:r})}))()}loadFonts(){var e=this;return n((function*(){var{fonts:t}=e.artifact,a={};return yield Promise.all(t.map(function(){var t=n((function*(t){var i="https://static.artificialmuseum.com/font/json/".concat(t,".typeface.json");a[t]=yield e.promisifiedLoad({loader:e.fontLoader,file:i})}));return function(e){return t.apply(this,arguments)}}())),a}))()}loadAnimateObjects(){var e=this;return n((function*(){var{animateObjects:t,slug:a}=e.artifact,i={},o=e.audioLoader;return yield Promise.all(t.map(function(){var t=n((function*(t){if(t.sound){var{sound:n={}}=t;if(!0===n&&(n={name:a}),n.name||(n.name=a),!i[n.name]){var r=".mp3";y.SUPPORTS.A_MP4?r=".mp4":y.SUPPORTS.A_OGG&&(r=".ogg");var s="https://media.artificialmuseum.com/audio/".concat(n.name).concat(r);i[n.name]=yield e.promisifiedLoad({loader:o,file:s})}}}));return function(e){return t.apply(this,arguments)}}())),i}))()}loadExamples(){var e=this;return n((function*(){var{examples:t}=e.artifact,a={};if(t.TextGeometry){var{TextGeometry:i}=yield import("./vendor.js").then((function(e){return e.bc}));a.TextGeometry=i}return a}))()}loadCustomMaterials(){var e=this;return n((function*(){var{artifact:t}=e,{customMaterials:a}=t;return Promise.all(a.map(function(){var a=n((function*(a){var{default:i}=yield import("./materials/".concat(a.name,".js")),n=new i({artifact:t,config:a,preload:e});return O.fn(n.preload)&&(yield n.preload()),{config:a,material:n}}));return function(e){return a.apply(this,arguments)}}()))}))()}loadCustomObjects(){var e=this;return n((function*(){var{artifact:t}=e,{customObjects:a}=t;return Promise.all(a.map(function(){var a=n((function*(a){var{default:i}=yield import("./objects/".concat(a.name,".js")),n=new i({artifact:t,config:a,preload:e});return O.fn(n.preload)&&(yield n.preload()),n}));return function(e){return a.apply(this,arguments)}}()))}))()}loadVideo(t){var a=this;return n((function*(){var{dir:i,slug:n,video:o,id:r=Me}=t,s=!0===o?n:o,l=e.create("video",{id:r,class:he,loop:!0,playsinline:!0,preload:"auto",crossorigin:"anonymous"});a.videoElement=l;var d=["webm","mp4"],c=O.str(s)?s:n;c.startsWith("/")||(c.endsWith(".mp4")?(d=["mp4"],c=c.slice(0,-4)):c=i?"/video/".concat(i,"/").concat(c):"/video/".concat(c,"/").concat(c)),c.endsWith(".mp4")&&(d=["mp4"],c=c.slice(0,-4));var h="".concat(y.MEDIA_URL).concat(c);d.forEach((t=>{e.create("source",{src:"".concat(h,".").concat(t,"?v=").concat(Ee),type:"video/".concat(t),parent:l})})),e.append(l);var{videoWidth:m}=l;if(m>0)return l;var u="canplaythrough";return Ae&&(u="loadedmetadata"),new Promise((t=>{e.on(l,u,(e=>{Ae?setTimeout((()=>{t(e.target)}),Se):t(e.target)}))}))}))()}loadAudio(){var t=this;return n((function*(){var{slug:a,audio:i}=t.artifact;e.remove("#".concat(ke));var n=e.create("audio",{class:he,crossorigin:"anonymous",id:ke,loop:!0,preload:"auto"});t.audioElement=n;var o=O.str(i)?i:a;o.startsWith("/")||(o="/audio/".concat(o));var r=["ogg","mp4","mp3"];o.endsWith(".mp3")&&(r=["mp3"],o=o.slice(0,-4));var s="".concat(y.MEDIA_URL).concat(o);r.forEach((t=>{e.create("source",{src:"".concat(s,".").concat(t,"?v=").concat(Ee),type:"audio/".concat(t),parent:n})})),e.append(n);var{duration:l}=n;if(O.num(l)&&l>0)return n;var d="canplaythrough";return Ae&&(d="loadedmetadata"),new Promise((t=>{e.on(n,d,(e=>t(e.target)))}))}))()}loadAudioElements(){var t=this;return n((function*(){var{audioElements:a,slug:i}=t.artifact;return yield Promise.all(a.map(function(){var a=n((function*(a,n){var o=a.audio||i,r="".concat(ke,"-").concat(n);e.remove("#".concat(r));var s=e.create("audio",{class:he,crossorigin:"anonymous","data-name":o,preload:"auto",id:r});!1!==a.loop&&(s.loop="true"),t.audioElements.push(s);var l="/audio/".concat(o),d=["mp4","ogg","mp3"];l.endsWith(".mp3")&&(d=["mp3"],l=l.slice(0,-4));var c="".concat(y.MEDIA_URL).concat(l);d.forEach((t=>{e.create("source",{src:"".concat(c,".").concat(t,"?v=").concat(Ee),type:"audio/".concat(t),parent:s})})),e.append(s);var{duration:h}=s;if(O.num(h)&&h>0)return s;var m="canplaythrough";return Ae&&(m="loadedmetadata"),new Promise((t=>{e.on(s,m,(e=>t(e.target)))}))}));return function(e,t){return a.apply(this,arguments)}}()))}))()}loadTextures(){var e=this;return n((function*(){var{textures:t={}}=e.artifact,{dir:a,names:i}=t,n="jpg";y.SUPPORTS.WEBP&&(n="webp"),a&&!a.endsWith("/")&&(a="".concat(a,"/"));var o={};return i.forEach((t=>{var i=t;a.startsWith("/")||(i="https://static.artificialmuseum.com/textures/".concat(a,"/").concat(t)),i.endsWith(".jpg")||(i="".concat(i,".").concat(n));var r=e.promisifiedLoad({loader:e.textureLoader,file:i});o[slugged]=r})),o}))()}loadGltf(){var e=this;return n((function*(){var{artifact:t,XR:a}=e,{file:i,version:n=1}=t,o=a?"&xr=1":"",r="".concat(y.GLB_URL,"/").concat(i,".glb?v=").concat(n).concat(o);return yield e.promisifiedLoad({loader:e.gltfLoader,file:r})}))()}loadPly(){var e=this;return n((function*(){var t,{artifact:a,XR:i}=e,{file:o,ply:r={},version:s=1}=a,l=i?"&xr=1":"";if(null!==(t=r.files)&&void 0!==t&&t.length)return yield Promise.all(r.files.map(function(){var t=n((function*(t){return t=t.startsWith("/")?"".concat(t,".ply?v=").concat(s).concat(l):"".concat(y.STATIC_URL,"/ply").concat(t,".ply?v=").concat(s).concat(l),yield e.promisifiedLoad({loader:e.plyLoader,file:t})}));return function(e){return t.apply(this,arguments)}}()));var d="".concat(y.STATIC_URL,"/ply/").concat(o,".ply?v=").concat(s).concat(l);return yield e.promisifiedLoad({loader:e.plyLoader,file:d})}))()}loadGui(){var{title:t,button:a,body:i}=this.artifact.gui.afterSpawnModel,n=[];t&&n.push(e.create("h3",{innerText:t})),i&&n.push(e.create("div",{innerText:i})),n.length&&(a&&n.push(e.create("button",{id:"afterSpawnModelButton",class:"styled margin inverse",innerText:a,on:{click:e=>{var t=e.target.parentNode;t.parentNode.removeChild(t)}}})),this.gui={afterSpawnModel:e.create("div",{class:"w hudgui",children:n,parent:"#hud"})})}promisifiedLoad(e){var{loader:t,file:a}=e;return new Promise(((e,i)=>{t.load(a,(t=>{e(t)}),(e=>{e.lengthComputable&&(Math.ceil(e.loaded/e.total*100),"".concat(e.loaded,"/").concat(e.total))}),(e=>{this.setError(e,"Error loading artifact.",5e3),i(e)}))}))}startEngine(){var t=this;return n((function*(){var{artifact:a,XR:i}=t,o=Object.entries(t.promises).map(function(){var e=n((function*(e){var[t,a]=e;return[t,yield a]}));return function(t){return e.apply(this,arguments)}}()),r=yield Promise.all(o);t.assets=Object.fromEntries(r);var s=new Re({artifact:a,preload:t,XR:i}),l=yield s.init(t.assets.scene);if(!l)throw new Error("Session undefined.");e.hide(t._header),e.hide(t._preloadInfo),e.show(t._headerDone),t._session=l,t._timeoutShown&&t.isAndroidChrome?e.prop(t._confirmButton,{disabled:!1}):t._isCancelled||(yield t.finishLoad())}))()}showTimeoutWarning(){e.show(this._preloadInfo),this.isAndroidChrome&&(e.show(this._confirmButton),this._confirmButton.setAttribute("disabled",!0),this._timeoutShown=!0)}confirmButtonClickHandler(){var t=this;return n((function*(){t._session&&(e.off(t._confirmButton,"click",t.confirmButtonClickHandler),yield t.finishLoad(),t.finished())}))()}finishLoad(){var t=this;return n((function*(){if(t._session){var{hud:a,initFallbackSession:i,initScene:n}=t._session;try{yield n(),a.show(),e.show("#".concat(C)),t.finished()}catch(n){"InvalidStateError"===n.name||"NotSupportedError"===n.name?(yield i(),a.show(),e.show("#".concat(C)),t.finished()):"SecurityError"===n.name&&(e.show(t._confirmButton),e.prop(t._confirmButton,{disabled:!1}))}}}))()}setError(e,t){y.clearTimeout(this.timeout),this.finished()}showTooFarNotification(t){var{distance:a,artifact:i,map:n}=t,o="meter",r=a;r>=1e3?(o="kilometer",r>=2e3&&(o+="s"),r=Math.round(r/1e3)):r>=2&&(o+="s"),this.artifact=i,this.map=n,this.XR=!1,this._tooFarDistanceInfo.innerText="This artifact is ".concat(r," ").concat(o," away."),e.show(this._tooFarContainer),e.on(this._tooFarPreviewButton,"click",this.onTooFarPreviewButtonClick),e.on(this._tooFarCancelButton,"click",this.onTooFarCancelButtonClick),e.on(this._tooFarAbortButton,"click",this.onTooFarCancelButtonClick)}onTooFarCancelButtonClick(){e.off(this._tooFarPreviewButton,"click",this.onTooFarPreviewButtonClick),this._isCancelled=!0,e.hide(this._tooFarContainer),this.finished()}onTooFarPreviewButtonClick(){var t=this;return n((function*(){e.off(t._tooFarPreviewButton,"click",t.onTooFarPreviewButtonClick),e.off(t._tooFarCancelButton,"click",t.onTooFarCancelButtonClick),e.off(t._tooFarAbortButton,"click",t.onTooFarCancelButtonClick),e.hide(t._tooFarContainer);var{artifact:a,map:i,XR:n}=t;yield t.init({artifact:a,map:i,XR:n}),yield t.startEngine()}))()}showWebglDisabledNotification(){e.show(this._webglDisabledContainer),e.hide([this._header,this._headerDone,this._preloadInfo,this._cancelButton,this._confirmButton]),e.on(this._webglDisabledOkButton,"click",this.onWebglDisabledOkButtonClick)}onWebglDisabledOkButtonClick(){e.off(this._webglDisabledOkButton,"click",this.onWebglDisabledOkButtonClick),this._isCancelled=!0,e.hide(this._webglDisabledContainer),this.finished()}finished(){this._isWorking=!1,this._timeoutShown=!1,e(".start-experience-button").forEach((e=>{e.removeAttribute("disabled")})),e.hide([this._warningContainer,this._confirmButton,this._preloadInfo,this._headerDone]),e.prop(this._confirmButton,{disabled:!0}),e.show(this._header),y.clearTimeout(this.timeout)}}export{Be as Preload};
