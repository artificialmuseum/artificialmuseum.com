import{$ as e,y as t,A as i,B as a,c as n,C as o,M as s,D as r,P as l,V as d,E as c,F as h,G as m,L as u,R as p,H as v,I as f,S as g,W as w,J as y,K as b,N as x,O as E,Q as S,U as T,X as k,Y as A,Z as C,a0 as P,a1 as _,a2 as j,a as O,a3 as B,a4 as R,a5 as L,a6 as I,a7 as F,a8 as D,a9 as W,aa as H,ab as z,w as U,ac as N,ad as X,ae as V,af as q,ag as G,ah as Y,ai as K,aj as Z,ak as J,al as Q,am as $,an as ee,ao as te,_ as ie,ap as ae,aq as ne,ar as oe,as as se,at as re,au as le,av as de,aw as ce,ax as he,ay as me,az as ue,aA as pe,aB as ve,aC as fe,aD as ge,aE as we,aF as ye,aG as be,aH as xe,aI as Ee,aJ as Se,aK as Te,v as ke,aL as Ae}from"./vendor.js";import{ChromaKeyMaterial as Ce}from"./materials/ChromaKeyMaterial.js";class Me{constructor(n){var{scene:o,sceneInstance:s,renderer:r,endSession:l}=n;this.endSession=l,this.engine=n,this.gui=e("#".concat(t)),this.hitSearch=e("#hud-searching-hittest"),this.scene=o,this.renderer=r,this.sceneInstance=s,e.on("#".concat(i),"click",this.onExitButtonClick.bind(this)),a(this),this.animToggler=e("#toggle-animation-button")}setCamera(t){this.cameraAccess=t,t?e.show(this.recordVideoButton):e.hide(this.recordVideoButton)}showAnimToggler(t){this.animToggler&&(this.animToggler.classList.remove("play"),e.show(this.animToggler),this.animTogglerInit||(this.animTogglerInit=!0,this.eventListener=()=>{this.animToggler.classList.toggle("play"),t()},e.on(this.animToggler,"click",this.eventListener)))}hideAnimToggler(){e.hide(this.animToggler)}addSession(e){this.session=e}show(){e.show(this.gui)}hide(){e.hide(this.gui)}onExitButtonClick(){var t=this;return n((function*(){if(t.session)try{yield t.session.end()}catch(e){t.hide()}else yield t.endSession();e.off(t.animToggler,"click",t.eventListener),t.sceneInstance&&t.sceneInstance.exit&&t.sceneInstance.exit(t),o()}))()}showHitSearch(){e.show(this.hitSearch)}hideHitSearch(){e.hide(this.hitSearch)}showElement(t){t.shown||(e.show(t),t.shown=!0)}hideElement(t){t.shown&&(e.hide(t),t.shown=!1)}}class Pe extends s{constructor(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=arguments.length>2?arguments[2]:void 0;super(e),this.type="Reflector",this.XR=i.XR,this.skybox=i.skybox,this.shadowPlane=i.shadowPlane;var a=this,{textureHeight:n=512,textureWidth:o=512,clipBias:s=0,fragmentShader:w=je,vertexShader:y=_e}=t,b=void 0!==t.color?new r(t.color):new r(8355711),x=new l,E=new d,S=new d,T=new d,k=new c,A=new d(0,0,-1),C=new h,M=new d,P=new d,_=new h,j=new c,O=new m,B=new v(o,n,{minFilter:u,magFilter:u,format:p});f.isPowerOfTwo(o)&&f.isPowerOfTwo(n)||(B.texture.generateMipmaps=!1);var R={tDiffuse:{value:B.texture},color:{value:b},textureMatrix:{value:j}},L=new g({uniforms:R,fragmentShader:w,vertexShader:y});this.material=L,this.onBeforeRender=(e,t,i)=>{var n;if(S.setFromMatrixPosition(a.matrixWorld),T.setFromMatrixPosition(i.matrixWorld),k.extractRotation(a.matrixWorld),E.set(0,0,1),E.applyMatrix4(k),M.subVectors(S,T),!(M.dot(E)>0)){M.reflect(E).negate(),M.add(S),k.extractRotation(i.matrixWorld),A.set(0,0,-1),A.applyMatrix4(k),A.add(T),P.subVectors(S,A),P.reflect(E).negate(),P.add(S),O.position.copy(M),O.up.set(0,1,0),O.up.applyMatrix4(k),O.up.reflect(E),O.lookAt(P),O.far=i.far,O.updateMatrixWorld(),O.projectionMatrix.copy(i.projectionMatrix),j.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),j.multiply(O.projectionMatrix),j.multiply(O.matrixWorldInverse),j.multiply(a.matrixWorld),x.setFromNormalAndCoplanarPoint(E,S),x.applyMatrix4(O.matrixWorldInverse),C.set(x.normal.x,x.normal.y,x.normal.z,x.constant);var o=O.projectionMatrix;_.x=(Math.sign(C.x)+o.elements[8])/o.elements[0],_.y=(Math.sign(C.y)+o.elements[9])/o.elements[5],_.z=-1,_.w=(1+o.elements[10])/o.elements[14],C.multiplyScalar(2/C.dot(_)),o.elements[2]=C.x,o.elements[6]=C.y,o.elements[10]=C.z+1-s,o.elements[14]=C.w,B.texture.encoding=e.outputEncoding,a.visible=!1;var r=e.getRenderTarget(),l=e.xr.enabled,d=e.shadowMap.autoUpdate;e.xr.enabled=!1,e.shadowMap.autoUpdate=!1,e.setRenderTarget(B),e.state.buffers.depth.setMask(!0),!1===e.autoClear&&e.clear(),this.XR&&this.skybox&&(this.skybox.visible=!0);var c=!1;null!==(n=this.shadowPlane)&&void 0!==n&&n.visible&&(this.shadowPlane.visible=!1,c=!0),e.render(t,O),e.xr.enabled=l,e.shadowMap.autoUpdate=d,e.setRenderTarget(r),this.XR&&this.skybox&&(this.skybox.visible=!1),c&&(this.shadowPlane.visible=!0);var h=i.viewport;void 0!==h&&e.state.viewport(h),a.visible=!0}},this.getRenderTarget=()=>B}}Pe.prototype.isReflector=!0;var _e="\nuniform mat4 textureMatrix;\nvarying vec4 vUv;\n\n#include <common>\n#include <logdepthbuf_pars_vertex>\n\nvoid main() {\n  vUv = textureMatrix * vec4( position, 1.0 );\n\n  gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n  #include <logdepthbuf_vertex>\n}",je="\nuniform vec3 color;\nuniform sampler2D tDiffuse;\nvarying vec4 vUv;\n\n#include <logdepthbuf_pars_fragment>\n\nfloat blendOverlay( float base, float blend ) {\n  return( base < 0.5 ? ( 2.0 * base * blend ) : ( 1.0 - 2.0 * ( 1.0 - base ) * ( 1.0 - blend ) ) );\n}\n\nvec3 blendOverlay( vec3 base, vec3 blend ) {\n  return vec3( blendOverlay( base.r, blend.r ), blendOverlay( base.g, blend.g ), blendOverlay( base.b, blend.b ) );\n}\n\nvoid main() {\n  #include <logdepthbuf_fragment>\n\n  vec4 base = texture2DProj( tDiffuse, vUv );\n  gl_FragColor = vec4( blendOverlay( base.rgb, color ), 1.0 );\n}\n",Oe=["audio","action","buffer","target","distanceTarget"],Be=w.APP_DB.SCENE_TYPES;class Re{constructor(e){var{artifact:t,preload:i,XR:a}=e;this.XR=a,this.artifact=t,this.preload=i;var{type:n=Be.Hit}=t;this.type=n,this.clock=new y,this.scene=new b,this.customMaterials=[],this.spatialObjects=[],this.spatialAnimations=[],this.lookAtCameraObjects=[],this.animateObjects=[],this.audioAnalysers=[],this.audioAnalyserEmissionConfigs=[],this.circlingLights=[],this.customObjects=[],this.videoTargets=[],this.audioRamps={},this.onResize=this.onResize.bind(this),this.render=this.render.bind(this),this.initFallbackSession=this.initFallbackSession.bind(this),this.toggleAnimations=this.toggleAnimations.bind(this),this.endSession=this.endSession.bind(this)}init(t){var i=this;return n((function*(){var a,{artifact:o,preload:s,scene:r,type:l,XR:d}=i;t&&(i.sceneInstance=t);var{fov:c,near:h,far:u}=x(o.cam,E),p=w.innerWidth/w.innerHeight;i.camera=new m(c,p,h,u),i.camera.updateProjectionMatrix(),r.add(i.camera);var v=new S({antialias:!0,alpha:!0});i.renderer=v,v.setPixelRatio(w.devicePixelRatio),v.domElement.id=T,v.physicallyCorrectLights=!0,v.outputEncoding=k,v.toneMappingExposure=1;var{audio:f,circlingLights:g,clickables:y,customMaterials:b,wireframes:M,customObjects:P,hideLight:_,ocean:j,particles:O,shadow:B,spatialAudio:R,triggerVideo:L,underwater:I}=o;!1!==B&&(v.shadowMap.enabled=!0,v.shadowMap.type=A),i.hud=new Me(i);var F=null===(a=i.artifact.animateObjects)||void 0===a?void 0:a.some((e=>e.sound));if((f||R||F)&&i.addAudio(),i.addSkybox(),_||i.addLights(),i.videoElement=s.assets.videoElement,null!=t&&t.init&&(yield t.init({engine:i,preload:s})),null!=t&&t.beforeLoadModel&&t.beforeLoadModel({engine:i,preload:s}),i.loadModel(),null!=t&&t.afterLoadModel&&t.afterLoadModel({engine:i,preload:s}),null!=g&&g.length&&i.addCirclingLights(),b&&(yield i.addCustomMaterials()),P&&(yield i.addCustomObjects()),M&&M.forEach((e=>{var t=i.model.getObjectByName(e.target);t&&t.material&&(t.material.wireframe=!0,e.transparent&&(t.material.transparent=!0,t.material.opacity=e.opacity))})),L&&i.addVideoTrigger(),I&&(yield i.underwaterPlane()),j&&(yield i.oceanPlane()),O){var{Particles:D}=yield import("./Particles.js");i.particles=new D(i),yield i.particles.init()}if(v.setSize(w.innerWidth,w.innerHeight),e.append(v.domElement,"#".concat(C)),d)try{var W=v.xr.getController(0);i.controller=W;var{clickable:H,shadow:z,shadowPlane:U}=o;if(!1!==z&&!1!==U&&i.addShadowPlane(),!i.isHittestScene())throw new Error("Unknown scene type ".concat(l));l!==Be.Float&&i.spawnReticle(),e.on(W,"select",(()=>{if(!i.justUnspawned){i.spawnModel(!1),H?i.hud.showAnimToggler(i.toggleAnimations):i.hud.hideAnimToggler()}})),H||i.hud.hideAnimToggler(),r.add(W),i.initScene=n((function*(){var t;return e.hide("#Locator"),t=yield w.NAV.xr.requestSession("immersive-ar",{requiredFeatures:["hit-test","dom-overlay"],domOverlay:{root:e("#hud")}}),e.on(t,"end",(()=>{i.endSession()})),i.hud.addSession(t),i.refSpace=yield t.requestReferenceSpace("viewer"),i.renderer.xr.enabled=!0,i.renderer.xr.setReferenceSpaceType("local"),yield i.renderer.xr.setSession(t),t.initFallbackSession=i.initFallbackSession.bind(i),t}))}catch(e){i.initScene=i.initFallbackSession}else i.initScene=i.initFallbackSession;return null!=y&&y.length&&(yield i.addClickables()),e.on(w,"resize",i.onResize),i.onResize(),v.setAnimationLoop(i.render),i}))()}onResize(){var{innerWidth:e,innerHeight:t}=w;this.camera.aspect=e/t,this.camera.updateProjectionMatrix(),this.renderer.setSize(e,t)}addLights(){var{directionalLightPosition:e=_.directionalPosition}=this.artifact,t=new P(_.directionalColor,_.directionalIntensity);t.position.set(...e),t.castShadow=!0,!1!==this.artifact.shadow&&(t.shadow.bias=-1e-4,t.shadow.mapSize.width=512,t.shadow.mapSize.height=512,t.shadow.camera.near=.1,t.shadow.camera.far=300),this.directionalLight=t,this.scene.add(t),this.ambientLight=new j(_.ambientColor,_.ambientIntensity),this.scene.add(this.ambientLight)}addCustomMaterials(){var{preload:e}=this,{customMaterials:t=[]}=e.assets;t.forEach((e=>{var{config:t,material:i}=e,a=this.model.getObjectByName(t.target);a&&(a.material=i,O.fn(i.init)&&i.init({engine:this}),this.customMaterials.push({config:t,material:i}))}))}addCustomObjects(){var{artifact:e}=this,{customObjects:t}=e;t.forEach((e=>{var{config:t,object:i}=e,a=this.model.getObjectByName(t.target);a&&(i.child?a.add(i.child):i.model&&(a.parent.add(i.model),a.parent.remove(a)),this.customObjects.push({config:t,object:i}),O.fn(i.init)&&i.init({engine:this}))}))}addShadowPlane(){var e=new B(150,150,64,64),t=new R;t.opacity=L;var i=new s(e,t);i.receiveShadow=!0,i.lookAt(0,100,0),i.position.set(0,0,0),this.shadowPlane=i}spawnReticle(){var e=new I(.15,.2,32).rotateX(-M.PI/2),t=new F;this.reticle=new s(e,t),this.reticle.matrixAutoUpdate=!1,this.reticle.visible=!1,this.scene.add(this.reticle)}glow(){var{glow:e}=this.artifact;this.model.traverse((t=>{if(D(t.name,"glow")){var i=O.bool(e)?238:e,a=new F({color:i,side:W,blending:H,transparent:!0});t.material=a}}))}addClickables(){var t=this;return n((function*(){var{artifact:i,model:a}=t,{clickables:n=[]}=i,o=[];if(!0===n?o.push(t.model):n.length&&a.traverse((e=>{n.forEach((i=>{if(O.str(i)&&(i={target:i}),z({node:e,search:i.target})){i.node=e;var a=!0===i.audio?e.name:i.audio;i.player=t.preload.assets.audioElements.find((e=>e.dataset.name===a)),o.includes(i)||o.push(i)}}))})),o.length){var{Controls:s}=yield import("./Controls.js");t.controls=new s({clickables:o,engine:t}),t.controller?e.on(t.controller,"select",t.controls.select,!1):e.on(t.renderer.domElement,"mousedown",t.controls.click,!1)}}))()}onTouch(t){var i=this;return n((function*(){var a;null!==(a=i.sceneInstance)&&void 0!==a&&a.onTouch&&(yield i.sceneInstance.onTouch(t)),t.forEach(((t,a)=>{if(!(a+1>i.artifact.maxTouches)){var{emission:n,emissionIntensity:o=.2,link:s,player:l}=t;if(s&&(U?window.location.href=s:window.open(s,"_hacked")),l&&(l.loop?l.paused?l.play():(l.currentTime=0,l.pause()):(l.currentTime=0,l.play())),n){var d=t.node.name.split("_")[0],c=i.model.getObjectByName(d);if(!c)return;("Group"===c.type?c.children:[c]).forEach((t=>{if(t&&(t.userData.origEmissive||(t.userData.origEmissive=t.material.emissive),t.userData.origEmissiveIntensity||(t.userData.origEmissiveIntensity=t.material.emissiveIntensity),l))if(N.same(t.material.emissive,t.userData.origEmissive)){var i=new r(1,1,1);O.bool(n)?t.material.color&&(i=t.material.color):O.arr(n)&&(i=new r(...n)),t.material.emissive=i,t.material.emissiveIntensity=o,l.loop||e.on(l,"ended",(()=>{t.material.emissive=t.userData.origEmissive,t.material.emissiveIntensity=t.userData.origEmissiveIntensity}))}else l.loop&&(t.material.emissive=t.userData.origEmissive,t.material.emissiveIntensity=t.userData.origEmissiveIntensity)}))}}}))}))()}nosort(){this.renderer.sortObjects=!1}clip(){var{model:e,artifact:{clipSide:t}}=this;e.traverse((e=>{if(D(e.name,"clip")){var i=W;"back"===t?i=Z:"front"===t&&(i=he),e.material=new F({color:"green",colorWrite:!1,side:i}),e.castShadow=!1,e.receiveShadow=!1,e.renderOrder=1}else e.renderOrder=2}))}mirror(){var{mirrors:e}=this.artifact,t=w.devicePixelRatio,i=w.innerWidth*t,a=w.innerHeight*t;this.mirrors=e.map((e=>{var t,{clipBias:n=.003,color:o=7829367,type:s,params:r=[4,32],rotation:l={},position:d={}}=e,c=APP_DB.MESH_TYPES;t=s===c.CIRCLE?new X(...r):s===c.PLANE?new B(...r):s===c.RING?new I(...r):s===c.BOX?new V(...r):s===c.SPHERE?new q(...r):new B(...r);var h=new Pe(t,{clipBias:n,textureWidth:i,textureHeight:a,color:o},this),{x:m,y:u,z:p}=l;m&&h.rotateX(f.degToRad(m)),u&&h.rotateY(f.degToRad(u)),p&&h.rotateZ(f.degToRad(p));var{x:v,y:g,z:w}=d;return v&&h.position.setX(v),g&&h.position.setY(g),w&&h.position.setZ(w),this.model.add(h),h}))}addCirclingLights(){this.artifact.circlingLights.forEach((e=>{var{color:t=16711680,intensity:i=1,dim:a=0,decay:n=2,shadows:o=!1,show:r=!1}=e,l=new G(t,i,a,n);if(o&&(l.castShadow=!0,l.shadow.camera.near=.1,l.shadow.camera.far=5),r){var d=new q(.005,6,6),c=new F({color:t}),h=new s(d,c);l.add(h)}this.circlingLights.push({light:l,config:e}),this.model.add(l)}))}analyseAudio(){var e,{audioElement:t,audioElements:i=[]}=this.preload.assets;(t||null!=i&&i.length)&&([t,...i].filter((e=>e)).forEach((e=>{var t=new AudioContext,i=t.createMediaElementSource(e),a=t.createAnalyser();a.fftSize=this.artifact.fftSize||32,i.connect(a),i.connect(t.destination);var n=new Uint8Array(a.frequencyBinCount);a.getByteFrequencyData(n),this.audioAnalysers.push({name:e.id,analyser:a,array:n})})),null===(e=this.artifact.audioAnalyserEmission)||void 0===e||e.forEach((e=>{var t=x(e,{intensity:.004,minIntensity:0,color:[],target:""}),i=[];this.model.traverse((e=>{var a;z({node:e,search:t.target})&&(e.material?i.includes(e.material)||i.push(e.material):null!==(a=e.children)&&void 0!==a&&a.length&&e.children.forEach((e=>{e.material&&i.push(e.material)})))})),t.targets=i,t.targets.length,this.audioAnalyserEmissionConfigs.push(t)})))}underwaterPlane(){var e=this;return n((function*(){var{UnderwaterPlane:t}=yield import("./UnderwaterPlane.js");e.cameraPlane=new t,yield e.cameraPlane.preload(e)}))()}oceanPlane(){var e=this;return n((function*(){var{name:t="ocean",normals:i="oceannormals1"}=e.artifact.ocean,{Water:a}=yield import("./vendor.js").then((function(e){return e.bc})),n=e.model.getObjectByName(t),o=yield e.preload.promisifiedLoad({loader:e.preload.textureLoader,file:"https://static.artificialmuseum.com/textures/ocean/".concat(i,".jpg")});o.wrapS=o.wrapT=Y,e.ocean=new a(n.geometry,{textureWidth:512,textureHeight:512,waterNormals:o,sunDirection:new d,sunColor:16777215,waterColor:1048575,distortionScale:3.7,fog:!1}),e.ocean.position.copy(n.position),e.ocean.rotation.copy(n.rotation),e.model.add(e.ocean),n.visible=!1}))()}addSkybox(){var e=this;return n((function*(){var{artifact:t,preload:i,renderer:a,scene:n,XR:o}=e,r=me,l=null==t?void 0:t.skySphere;O.arr(l)&&l.length&&(r=l);var d=new q(...r),c=i.assets.skybox,h=new K(a);h.compileEquirectangularShader();var m=h.fromEquirectangular(c).texture;h.dispose();var u=new F({map:c,side:Z}),p=new s(d,u);p.rotation.y=f.degToRad(180),p.visible=!o,n.add(p),!1===t.light||t.hideEnvironment||(n.environment=m),e.skybox=p}))()}addAudio(){this.listener=new J,this.camera.add(this.listener)}addVideoTrigger(){this.model.traverse((e=>{this.videoTrigger||["videotarget","videotrigger"].some((t=>D(e.name,t)))&&(this.videoTrigger=e,this.videoTrigger.visible=!1)}))}startMedia(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];if(!this.isMediaPlaying){var{actions:t=[],artifact:i,preload:a}=this,{audioElement:n,videoElement:o,audioElements:s=[]}=a.assets;i.triggerAudio||(n&&(e&&(n.currentTime=0),n.play()),null!=s&&s.length&&s.forEach((t=>{t.autoplay&&(e&&(t.currentTime=0),t.play())}))),o&&!i.triggerVideo&&(e&&(o.currentTime=0),o.play()),t.forEach((e=>e.play())),this.isMediaPlaying=!0}}stopMedia(){var{audioElement:e,videoElement:t,actions:i=[],audioElements:a=[]}=this;e&&e.pause(),t&&t.pause(),i&&i.length&&i.forEach((e=>e.stop())),a.forEach((e=>e.pause())),this.isMediaPlaying=!1}toggleAnimations(){this.actions.forEach((e=>e.paused=!e.paused))}initFallbackSession(){this.XR=!1,w.B.classList.add(Q);var{camera:e,artifact:t,model:i,renderer:a}=this,n=new $(e,a.domElement);this.controller=n,this.skybox.visible=!0,Object.entries(ee).forEach((e=>{var[t,i]=e;n[t]=i}));var{cam:o={},orbit:s={},clickable:r}=t;O.num(s.min)&&(n.minDistance=s.min),O.num(s.max)&&(n.maxDistance=s.max),O.num(o.maxPolar)&&(n.maxPolarAngle=f.degToRad(o.maxPolar)),O.num(o.minPolar)&&(n.minPolarAngle=f.degToRad(o.minPolar)),r?this.hud.showAnimToggler(this.toggleAnimations):this.hud.hideAnimToggler();var{cam:l={}}=t,c=ue,{x:h=c.x,y:m=c.y,z:u=c.z}=l;e.position.set(h,m,u);var{lookat:p={}}=t,{x:v=0,y:g=0,z:y=0}=p;if(n.target=new d(v,g,y),i){var{x:b,y:x,z:E}=i.scale,{scale:S}=t;S&&i.scale.set(b*S,x*S,E*S)}n.update();this.spawnModel(!0),a.domElement.focus()}loadModel(){var e,t,i,{artifact:a,preload:n,sceneInstance:o={}}=this;if(null!=o&&o.model?this.model=o.model:null!==(e=n.assets.gltf)&&void 0!==e&&e.scene&&(this.model=n.assets.gltf.scene),n.assets.ply){var s=x(a.ply,{vertexColors:!0,size:"0.001",sizeAttenuation:0,opacity:"1.0"}),r=new te(ie(ie({},s),{},{transparent:"1.0"!==s.opacity})),l=new ae(n.assets.ply,r);this.model?this.model.add(l):this.model=l}if(null!=o&&o.animations?this.animations=o.animations:null!==(t=n.assets.gltf)&&void 0!==t&&t.animations&&(this.animations=n.assets.gltf.animations),this.actions=[],null!==(i=this.animations)&&void 0!==i&&i.length){this.mixer=new ne(this.model);var{animations:d={}}=a,{loop:c,startOnTouch:h,clampWhenFinished:m=!0,autoplay:u=!0,noLoopAnimations:p=[],pausedAnimations:v=[]}=d;this.animations.forEach((e=>{var t=this.mixer.clipAction(e),i=this.spatialAnimations.find((e=>e._clip.name===t.name)),a=v.includes(e.name),n=h||!u||i||a;(!1===c||p.includes(e.name))&&(t.clampWhenFinished=m,t.loop=oe),n&&(t.paused=!0),this.actions.push(t)}))}if(this.model){var f,g={};this.model.traverse((e=>{var t;if(o.parentName&&o.child&&D(e.name,o.parentName)&&(f=e),this.customObjects.forEach((t=>{var{object:i}=t;i.parentName&&i.child&&D(e.name,i.parentName)&&(g[i.name]=e)})),e.isMesh){var{frustumCulled:i,transparent:n,castShadow:s,receiveShadow:r}=a;!1===i&&(e.frustumCulled=!1),!1===n&&(e.material.transparent=!1),D(e.name,"noshadow")||(e.castShadow=!1!==s,e.receiveShadow=!1!==r),D(e.name,"videotarget")&&this.videoTargets.push(e),e.material.map&&(e.material.map.anisotropy=16,e.material.map.encoding=k),e.material.emissiveMap&&(e.material.emissiveMap.encoding=k),(e.material.map||e.material.emissiveMap)&&(e.material.needsUpdate=!0)}null!==(t=a.lookAtCameraObjects)&&void 0!==t&&t.length&&z({node:e,search:a.lookAtCameraObjects})&&(O.num(this.lookAtAlpha)||(this.lookAtAlpha=0),this.lookAtCameraObjects.push(e));var l=[];a.animateObjects&&a.animateObjects.forEach((t=>{if(D(e.name,t.name)){var i=this.actions.find((t=>t._clip.name===e.name));if(t.sound){!0===t.sound&&(t.sound={name:this.artifact.slug}),t.sound.name||(t.sound.name=this.artifact.slug);var a=this.preload.assets.animateObjects[t.sound.name];if(a){var n=new se(this.listener);n.setBuffer(a);var{loopSound:o=!0}=t;if(n.setLoop(o),t.audio=n,t.sound.distance){var s=!1!==t.sound.yDistanceTest;l.push({buffer:n,distance:t.sound.distance,distanceTarget:e.name,target:e.name,yDistanceTest:s})}}}this.animateObjects.push(ie(ie({},t),{},{action:i,node:e}))}}));var{spatialObjects:d=[],audioElements:c=[]}=a,h=[...d,...c,...l];h.length&&h.forEach((t=>{var{audio:i,action:a,buffer:n,target:o,distanceTarget:s}=t,r=re(t,Oe);if(z({node:e,search:o})){var l=ie(ie({},r),{},{node:e});s&&(l.distanceTarget=this.model.getObjectByName(s)),n?l.audio=n:i&&(l.audio=this.preload.assets.audioElements.find((e=>e.dataset.name===i))),a&&(l.action=this.actions.find((e=>e._clip.name===a)),l.off||this.spatialAnimations.push(l.action)),this.spatialObjects.push(l)}}))})),f&&f.add(o.child),this.customObjects.forEach((e=>{var{object:t}=e;t.child?g[t.name].add(t.child):t.model&&this.model.add(t.model)})),this.videoElement&&this.videoTargets.length&&this.videoTargets.forEach((e=>{var t=new le(this.videoElement),{flipVideo:i,chromaKey:n}=a;!1!==i&&(t.flipY=!1),e.material.map=t,n&&(e.material=new Ce(a.chromaKey,t))}))}var{clip:w,glow:y,mirrors:b,nosort:E}=this.artifact;y&&this.glow(),this.model&&w&&this.clip(),E&&this.nosort(),null!=b&&b.length&&this.mirror(),this.artifact.analyseAudio&&this.analyseAudio(),this.model&&(this.model.position.set(5e3,5e3,5e3),this.scene.add(this.model))}spawnModel(e){var t,{artifact:i,camera:a,controller:n,model:o,reticle:s,scene:r,shadowPlane:l,type:d,XR:c,sceneInstance:h={}}=this,{showSkybox:m}=i;if(!c||e)return o&&(this.applyPositionAndRotation(),o.position.set(0,0,0)),this.modelSpawned=!0,null!=h&&h.spawnModel&&h.spawnModel({engine:this}),null!=h&&h.afterSpawnModel&&h.afterSpawnModel({engine:this}),void this.startMedia();if(this.isHittestScene()){if(!this.modelSpawned&&this.lastHit){s.updateMatrixWorld(),o.position.setFromMatrixPosition(s.matrixWorld),o.updateMatrixWorld();var u=a.position,p=o.position,v=u.x-p.x,f=u.z-p.z,g=Math.atan2(v,f);o.rotation.y=g,l&&(l.position.setFromMatrixPosition(s.matrixWorld),r.add(l)),o.visible=!0,s.visible=!1,this.modelSpawned=!0,null!=h&&h.spawnModel&&h.spawnModel({engine:this}),null!=h&&h.afterSpawnModel&&h.afterSpawnModel({engine:this}),this.startMedia()}this.applyPositionAndRotation()}else if(d===Be.Float){var w=o.clone();w.position.set(0,0,-1).applyMatrix4(n.matrixWorld),this.applyPositionAndRotation(),r.add(w),this.startMedia()}if(m&&(this.skybox.visible=!0),null!==(t=this.preload.gui)&&void 0!==t&&t.afterSpawnModel){var{afterSpawnModel:y}=this.preload.gui;y.style.visibility="visible",y.style.opacity=1,setTimeout((()=>{var e;O.fn(null===(e=y.parentNode)||void 0===e?void 0:e.removeChild)&&y.parentNode.removeChild(y)}),5e3)}}unspawnModel(){this.modelSpawned&&(this.scene.remove(this.model),this.modelSpawned=!1,this.isAnimationRunning=!1,this.stopMedia(),this.exitSceneInstance(),this.justUnspawned=!0,setTimeout((()=>{this.justUnspawned=!1}),200))}exitSceneInstance(){var e;this.customObjects.forEach((e=>{var{object:t}=e;O.fn(t.exit)&&t.exit({engine:this})})),this.customMaterials.forEach((e=>{var{material:t}=e;O.fn(t.exit)&&t.exit({engine:this})})),this.animateObjects.forEach((e=>{var t;null===(t=e.audio)||void 0===t||t.stop()})),null!==(e=this.sceneInstance)&&void 0!==e&&e.exit&&this.sceneInstance.exit({engine:this})}applyPositionAndRotation(){var{artifact:e,model:t}=this;if(t){var{pos:i={},rot:a={}}=e;i.x&&(t.position.x+=i.x),i.y&&(t.position.y+=i.y),i.z&&(t.position.z+=i.z);var n=f.degToRad;a.x&&t.rotateX(n(a.x)),a.y&&t.rotateY(n(a.y)),a.z&&t.rotateZ(n(a.z))}}endSession(){var t=this;return n((function*(){t.hud.hide(),t.renderer.setAnimationLoop(null),e("#".concat(C)).classList.remove("visible"),t.exitSceneInstance(),t.scene&&de(t.scene),e.remove(".".concat(ce));var i=e("#".concat(T));if(i){var a=i.parentNode;a.id===C?e.remove(i):e.remove(a)}w.B.classList.remove(Q),e(".start-experience-button").forEach((e=>{e.removeAttribute("disabled")})),U&&w.location.reload()}))()}isHittestScene(){return![Be.Float].includes(this.type)}render(e,t){var i=this;return n((function*(){var a,n,o,s,r,l,d,c=i.clock.getDelta();i.renderHittest(t),i.mixer&&i.mixer.update(c),i.modelSpawned&&i.artifact.triggerVideo&&i.videoTrigger&&i.renderVideoTrigger(),null!==(a=i.sceneInstance)&&void 0!==a&&a.tick&&i.sceneInstance.tick({delta:c,engine:i,timestamp:e,frame:t}),null!==(n=i.spatialObjects)&&void 0!==n&&n.length&&i.modelSpawned&&i.renderSpatial(),null!==(o=i.audioAnalysers)&&void 0!==o&&o.length&&i.renderAnalyseAudio(),null!==(s=i.circlingLights)&&void 0!==s&&s.length&&i.renderCirclingLights(e),null!==(r=i.lookAtCameraObjects)&&void 0!==r&&r.length&&i.renderLookAtCamera(c),null!==(l=i.animateObjects)&&void 0!==l&&l.length&&i.renderAnimateObjects({delta:c,timestamp:e}),i.cameraPlane&&i.renderUnderwater(c),i.ocean&&i.renderOcean(c),i.particles&&i.particles.update(c),i.customMaterials.length&&i.renderCustomMaterials({delta:c,frame:t,timestamp:e}),i.customObjects.length&&i.renderCustomObjects({delta:c,frame:t,timestamp:e}),null!==(d=i.sceneInstance)&&void 0!==d&&d.render?i.sceneInstance.render({delta:c,frame:t,timestamp:e}):i.renderer.render(i.scene,i.camera)}))()}renderCustomMaterials(e){var{delta:t,frame:i,timestamp:a}=e;this.customMaterials.forEach((e=>{var{config:n,material:o}=e;if(o.uniforms.uTime){var{speed:s=1}=n;o.uniforms.uTime.value+=t*s}O.fn(o.tick)&&o.tick({delta:t,frame:i,timestamp:a})}))}renderCustomObjects(e){var{delta:t,frame:i,timestamp:a}=e;this.customObjects.forEach((e=>{var{object:n}=e;O.fn(n.tick)&&n.tick({delta:t,frame:i,timestamp:a})}))}renderLookAtCamera(e){var{camera:t,lookAtCameraObjects:i=[]}=this;i.forEach((i=>{var a=new d(0,0,i.position.distanceTo(t.position));i.localToWorld(a);var n=a.clone(),o=this.artifact.lookAtSpeed||.001;this.lookAtAlpha+=e*o,n.distanceToSquared(t.position)>.5&&(n.lerp(t.position,Math.min(1,this.lookAtAlpha)),i.lookAt(n))}))}renderAnimateObjects(e){var{timestamp:t}=e;this.animateObjects.forEach((e=>{var{action:i,audio:a,speed:n,minSpeed:o=0,maxDelay:s=2,minDelay:r=1}=e;if(i&&i.paused&&(e.nextAnimation||(e.nextAnimation=t+Math.random()*(1e3*s)+1e3*r),a.isPlaying&&a.stop(),e.nextAnimation<=t)){e.nextAnimation=!1;var l=Math.random()>.5?1:-1,d=Math.max(o,Math.random()*n)*l;i.timeScale=d,i.paused=!1,i.play(),a&&!a.isPlaying&&a.play()}}))}renderVideoTrigger(){var{triggerVideoDistance:e=1.1,triggerAudio:t,triggerVideo:i=!0}=this.artifact,a=e*e,n=this.videoTrigger.position.clone();n.add(this.videoTrigger.parent.position),this.camera.position.distanceToSquared(n)<=a?(i&&this.videoElement&&this.videoElement.paused&&(this.videoElement.play(),this.videoTrigger.visible=!0),t&&this.audioElement&&this.audioElement.paused&&this.audioElement.play()):(!this.videoElement.paused&&i&&(this.videoElement.pause(),this.videoTrigger.visible=!1),t&&this.audioElement&&!this.audioElement.paused&&this.audioElement.pause())}renderHittest(t){var i=this;return n((function*(){if(t&&i.XR){var a=i.renderer.xr.getSession();i.hitTestSourceRequested||(i.hitTestSource=yield a.requestHitTestSource({space:i.refSpace}),e.on(a,"end",(()=>{i.hitTestSourceRequested=!1,i.hitTestSource=null})),i.hitTestSourceRequested=!0);var n=t.getHitTestResults(i.hitTestSource);if(n.length){if(i.lastHit=n[0],!i.modelSpawned){i.reticle.visible=!0;var o=i.renderer.xr.getReferenceSpace();i.reticle.matrix.fromArray(i.lastHit.getPose(o).transform.matrix)}i.hud.hideHitSearch()}else i.reticle.visible=!1,i.modelSpawned||i.hud.showHitSearch(),i.lastHit=void 0}}))()}renderAnalyseAudio(){var e,{audioAnalyserAnimation:t,audioAnalyserLights:i}=this.artifact,{audioAnalyserEmissionConfigs:a}=this,n=this.audioAnalysers.map((e=>{var{name:t,analyser:i,array:a}=e;i.getByteFrequencyData(a);var n=a.reduce(((e,t)=>e+t))/a.length;return this.audioRamps[t]={array:a,average:n},{array:a,average:n}})),o=0;n.map((e=>{o+=e.average}));var s=o/255;if(O.fn(null===(e=this.sceneInstance)||void 0===e?void 0:e.renderAudioAnalyser)&&this.sceneInstance.renderAudioAnalyser(o,this),t){var l=this.actions.find((e=>e._clip.name===t));l.weight=Math.min(1,o/220),l.time=l._clip.duration}if(i){var d=x(this.artifact,{lightIntensity:1,levelMultiplier:2}),c=d.lightIntensity*(s*d.levelMultiplier),{ambientLight:h}=this;h.intensity=c}null!=a&&a.length&&a.forEach((e=>{var t=e.intensity*s;e.targets.forEach((i=>{var a;t>e.minIntensity?i.emissiveIntensity=t:i.emissiveIntensity=0,null!==(a=e.color)&&void 0!==a&&a.length&&(i.emissive=new r(...e.color))}))}))}renderCirclingLights(e){var t=5e-4*e;this.circlingLights.forEach((e=>{var{light:i,config:a}=e,{lightDistance:n=1,timeOffset:o=20,offset:{x:s=0,y:r=0,z:l=0}={}}=a;t+=1e3*o;var d=Math.sin(t)*n+s,c=Math.sin(1.1*t)*n+r,h=Math.sin(1.2*t)*n+l;i.position.set(d,c,h)}))}renderSpatial(){this.spatialObjects.forEach((e=>{var{node:t,distanceTarget:i,action:a,audio:n,off:o,fn:s,yDistanceTest:r=!0}=e,{distance:l={max:2,min:0}}=e,c=i||t,h=new d;c.getWorldPosition(h);var m=r?h.y:this.camera.position.y,u=new d(h.x,m,h.z),p=this.camera.position.distanceTo(u);if(O.num(l)&&(l={min:0,max:l}),n){var v=O.fn(n.getVolume)?n.getVolume():n.volume,f=Math.max(0,Math.min(1,1-p/l.max+l.min/l.max));Math.abs(v-f)>.02&&(O.fn(n.setVolume)?n.setVolume(f):n.volume=f)}a&&(p<=l.max?o?a.paused||(a.paused=!0):a.paused&&(a.paused=!1):o?a.paused&&(a.paused=!1):a.paused||(a.paused=!0)),s&&O.fn(this.sceneInstance[s])&&this.sceneInstance[s]({node:t,config:{distance:l},distance:p})}))}renderUnderwater(e){this.cameraPlane.tick(e)}renderOcean(e){var{animationSpeed:t=1}=this.artifact.ocean;this.ocean.material.uniforms.time.value+=e*t*.1}}class Le{constructor(t){var{artifact:i,root:a,THREE:n}=t;this.artifact=i,this.root=a,n&&(this.THREE=n);var{android:o,chrome:s}=ke;this.isAndroidChrome=o&&s,this._warningContainer=e("#timeout-warning"),this._header=e("#timeout-warning-header"),this._headerDone=e("#timeout-warning-header-done"),this._preloadInfo=e("#timeout-warning-info"),this._cancelButton=e("#timeout-warning-cancel"),this._confirmButton=e("#timeout-warning-confirm"),this._tooFarContainer=e("#toofar-warning"),this._tooFarPreviewButton=e("#toofar-warning-load-preview-button"),this._tooFarDistanceInfo=e("#toofar-warning-distance"),this._tooFarCancelButton=e("#toofar-warning-cancel-button"),this._tooFarAbortButton=e("#toofar-warning-abort-button"),this._webglDisabledContainer=e("#timeout-warning-webgl-disabled"),this._webglDisabledOkButton=e("#timeout-warning-webgl-disabled-ok-button"),this.confirmButtonClickHandler=this.confirmButtonClickHandler.bind(this),e.on(this._confirmButton,"click",this.confirmButtonClickHandler),this.onTooFarCancelButtonClick=this.onTooFarCancelButtonClick.bind(this),this.onTooFarPreviewButtonClick=this.onTooFarPreviewButtonClick.bind(this),this.onWebglDisabledOkButtonClick=this.onWebglDisabledOkButtonClick.bind(this),this.textureLoader=new pe,this.gltfLoader=new ve,this.plyLoader=new fe,this.audioLoader=new ge,this.fontLoader=new we,this.audioElements=[],this.collectPreloadPromises(),this.startEngine=this.startEngine.bind(this)}collectPreloadPromises(){var e={skybox:this.loadSkybox()},{animateObjects:t,audio:i,audioElements:a,customMaterials:n,customObjects:o,examples:s,fonts:r,glb:l,gui:d,ply:c,textures:h,type:m,video:u}=this.artifact;if(a&&(e.audioElements=this.loadAudioElements()),i&&(e.audioElement=this.loadAudio()),ye(m)||(e.scene=this.loadScene()),!1!==l&&(e.gltf=this.loadGltf()),c&&(e.ply=this.loadPly()),h&&(e.textures=this.loadTextures()),u){var{slug:p,video:v}=this.artifact;e.videoElement=this.loadVideo({slug:p,video:v})}r&&(e.fonts=this.loadFonts()),s&&(e.examples=this.loadExamples()),d&&this.loadGui(),n&&(e.customMaterials=this.loadCustomMaterials()),o&&(e.customObjects=this.loadCustomObjects()),t&&(e.animateObjects=this.loadAnimateObjects()),this.promises=e}init(){var t=arguments,i=this;return n((function*(){var a=t.length>0&&void 0!==t[0]?t[0]:{},{map:n,XR:o}=a;i._isWorking=!0,i._isCancelled=!1,i._session=!1,i.map=n,i.XR=o,e.on(i._cancelButton,"click",(()=>{i._isCancelled=!0,i.finished()})),e.show([i._warningContainer,i._header]),i.timeout=w.setTimeout(i.showTimeoutWarning,be)}))()}loadScene(){var t=this;return n((function*(){var{artifact:i}=t,a=APP_DB.SCENE_TYPES,{type:n=a.Hit}=i,o=Object.entries(a).find((e=>{var[t,i]=e;return i===n})),s="".concat(t.root,"/CustomScene.js");if(O.arr(o)){var r=o[0];s="./scenes/".concat(r,".js")}var{default:l}=yield import(s),d=new l({artifact:i,mergeConfig:x,preload:t,$:e,W:w,is:O});return O.fn(null==d?void 0:d.preload)&&(yield d.preload({artifact:i,preload:t})),d}))()}loadSkybox(){var e=this;return n((function*(){var{city:t,sky:i,slug:a}=e.artifact,n=i||a,o="jpg";w.SUPPORTS.WEBP&&(o="webp");var s=n;return n.startsWith("/")||(s=[w.STATIC_URL,"skybox",t,n].filter((e=>e)).join("/")),s.endsWith(".".concat(o))||(s+=".".concat(o)),yield e.promisifiedLoad({loader:e.textureLoader,file:s})}))()}loadFonts(){var e=this;return n((function*(){var{fonts:t}=e.artifact,i={};return yield Promise.all(t.map(function(){var t=n((function*(t){var a="https://static.artificialmuseum.com/font/json/".concat(t,".typeface.json");i[t]=yield e.promisifiedLoad({loader:e.fontLoader,file:a})}));return function(e){return t.apply(this,arguments)}}())),i}))()}loadAnimateObjects(){var e=this;return n((function*(){var{animateObjects:t,slug:i}=e.artifact,a={},o=e.audioLoader;return yield Promise.all(t.map(function(){var t=n((function*(t){if(t.sound){var{sound:n={}}=t;if(!0===n&&(n={name:i}),n.name||(n.name=i),!a[n.name]){var s=".mp3";w.SUPPORTS.A_MP4?s=".mp4":w.SUPPORTS.A_OGG&&(s=".ogg");var r="https://media.artificialmuseum.com/audio/".concat(n.name).concat(s);a[n.name]=yield e.promisifiedLoad({loader:o,file:r})}}}));return function(e){return t.apply(this,arguments)}}())),a}))()}loadExamples(){var e=this;return n((function*(){var{examples:t}=e.artifact,i={};if(t.TextGeometry){var{TextGeometry:a}=yield import("./vendor.js").then((function(e){return e.bd}));i.TextGeometry=a}return i}))()}loadCustomMaterials(){var e=this;return n((function*(){var{artifact:t}=e,{customMaterials:i}=t;return Promise.all(i.map(function(){var i=n((function*(i){var{default:a}=yield import("./materials/".concat(i.name,".js")),n=new a({artifact:t,config:i,preload:e});return O.fn(n.preload)&&(yield n.preload()),{config:i,material:n}}));return function(e){return i.apply(this,arguments)}}()))}))()}loadCustomObjects(){var e=this;return n((function*(){var{artifact:t}=e,{customObjects:i}=t;return Promise.all(i.map(function(){var i=n((function*(i){var{default:a}=yield import("./objects/".concat(i.name,".js")),n=new a({artifact:t,config:i,preload:e});return O.fn(n.preload)&&(yield n.preload()),n}));return function(e){return i.apply(this,arguments)}}()))}))()}loadVideo(t){var i=this;return n((function*(){var{dir:a,slug:n,video:o,id:s=Ae}=t,r=!0===o?n:o,l=e.create("video",{id:s,class:ce,loop:!0,playsinline:!0,preload:"auto",crossorigin:"anonymous"});i.videoElement=l;var d=["webm","mp4"],c=O.str(r)?r:n;c.startsWith("/")||(c.endsWith(".mp4")?(d=["mp4"],c=c.slice(0,-4)):c=a?"/video/".concat(a,"/").concat(c):"/video/".concat(c,"/").concat(c)),c.endsWith(".mp4")&&(d=["mp4"],c=c.slice(0,-4));var h="".concat(w.MEDIA_URL).concat(c);d.forEach((t=>{e.create("source",{src:"".concat(h,".").concat(t,"?v=").concat(xe),type:"video/".concat(t),parent:l})})),e.append(l);var{videoWidth:m}=l;if(m>0)return l;var u="canplaythrough";return Ee&&(u="loadedmetadata"),new Promise((t=>{e.on(l,u,(e=>{Ee?setTimeout((()=>{t(e.target)}),Se):t(e.target)}))}))}))()}loadAudio(){var t=this;return n((function*(){var{slug:i,audio:a}=t.artifact;e.remove("#".concat(Te));var n=e.create("audio",{class:ce,crossorigin:"anonymous",id:Te,loop:!0,preload:"auto"});t.audioElement=n;var o=O.str(a)?a:i;o.startsWith("/")||(o="/audio/".concat(o));var s=["ogg","mp4","mp3"];o.endsWith(".mp3")&&(s=["mp3"],o=o.slice(0,-4));var r="".concat(w.MEDIA_URL).concat(o);s.forEach((t=>{e.create("source",{src:"".concat(r,".").concat(t,"?v=").concat(xe),type:"audio/".concat(t),parent:n})})),e.append(n);var{duration:l}=n;if(O.num(l)&&l>0)return n;var d="canplaythrough";return Ee&&(d="loadedmetadata"),new Promise((t=>{e.on(n,d,(e=>t(e.target)))}))}))()}loadAudioElements(){var t=this;return n((function*(){var{audioElements:i,slug:a}=t.artifact;return yield Promise.all(i.map(function(){var i=n((function*(i,n){var o=i.audio||a,s="".concat(Te,"-").concat(n);e.remove("#".concat(s));var r=e.create("audio",{class:ce,crossorigin:"anonymous","data-name":o,preload:"auto",id:s});!1!==i.loop&&(r.loop="true"),t.audioElements.push(r);var l="/audio/".concat(o),d=["mp4","ogg","mp3"];l.endsWith(".mp3")&&(d=["mp3"],l=l.slice(0,-4));var c="".concat(w.MEDIA_URL).concat(l);d.forEach((t=>{e.create("source",{src:"".concat(c,".").concat(t,"?v=").concat(xe),type:"audio/".concat(t),parent:r})})),e.append(r);var{duration:h}=r;if(O.num(h)&&h>0)return r;var m="canplaythrough";return Ee&&(m="loadedmetadata"),new Promise((t=>{e.on(r,m,(e=>t(e.target)))}))}));return function(e,t){return i.apply(this,arguments)}}()))}))()}loadTextures(){var e=this;return n((function*(){var{textures:t={}}=e.artifact,{dir:i,names:a}=t,n="jpg";w.SUPPORTS.WEBP&&(n="webp"),i&&!i.endsWith("/")&&(i="".concat(i,"/"));var o={};return a.forEach((t=>{var a=t;i.startsWith("/")||(a="https://static.artificialmuseum.com/textures/".concat(i,"/").concat(t)),a.endsWith(".jpg")||(a="".concat(a,".").concat(n));var s=e.promisifiedLoad({loader:e.textureLoader,file:a});o[slugged]=s})),o}))()}loadGltf(){var e=this;return n((function*(){var{artifact:t,XR:i}=e,{file:a,version:n=1}=t,o=i?"&xr=1":"",s="".concat(w.GLB_URL,"/").concat(a,".glb?v=").concat(n).concat(o);return yield e.promisifiedLoad({loader:e.gltfLoader,file:s})}))()}loadPly(){var e=this;return n((function*(){var{artifact:t,XR:i}=e,{file:a,version:n=1}=t,o=i?"&xr=1":"",s="".concat(w.STATIC_URL,"/ply/").concat(a,".ply?v=").concat(n).concat(o);return yield e.promisifiedLoad({loader:e.plyLoader,file:s})}))()}loadGui(){var{title:t,button:i,body:a}=this.artifact.gui.afterSpawnModel,n=[];t&&n.push(e.create("h3",{innerText:t})),a&&n.push(e.create("div",{innerText:a})),n.length&&(i&&n.push(e.create("button",{id:"afterSpawnModelButton",class:"styled margin inverse",innerText:i,on:{click:e=>{var t=e.target.parentNode;t.parentNode.removeChild(t)}}})),this.gui={afterSpawnModel:e.create("div",{class:"w",children:n,parent:"#hud"})})}promisifiedLoad(e){var{loader:t,file:i}=e;return new Promise(((e,a)=>{t.load(i,(t=>{e(t)}),(e=>{e.lengthComputable&&(Math.ceil(e.loaded/e.total*100),"".concat(e.loaded,"/").concat(e.total))}),(e=>{this.setError(e,"Error loading artifact.",5e3),a(e)}))}))}startEngine(){var t=this;return n((function*(){var{artifact:i,XR:a}=t,o=Object.entries(t.promises).map(function(){var e=n((function*(e){var[t,i]=e;return[t,yield i]}));return function(t){return e.apply(this,arguments)}}()),s=yield Promise.all(o);t.assets=Object.fromEntries(s);var r=new Re({artifact:i,preload:t,XR:a}),l=yield r.init(t.assets.scene);if(!l)throw new Error("Session undefined.");e.hide(t._header),e.hide(t._preloadInfo),e.show(t._headerDone),t._session=l,t._timeoutShown&&t.isAndroidChrome?e.prop(t._confirmButton,{disabled:!1}):t._isCancelled||(yield t.finishLoad())}))()}showTimeoutWarning(){e.show(this._preloadInfo),this.isAndroidChrome&&(e.show(this._confirmButton),this._confirmButton.setAttribute("disabled",!0),this._timeoutShown=!0)}confirmButtonClickHandler(){var t=this;return n((function*(){t._session&&(e.off(t._confirmButton,"click",t.confirmButtonClickHandler),yield t.finishLoad(),t.finished())}))()}finishLoad(){var t=this;return n((function*(){if(t._session){var{hud:i,initFallbackSession:a,initScene:n}=t._session;try{yield n(),i.show(),e.show("#".concat(C)),t.finished()}catch(n){"InvalidStateError"===n.name||"NotSupportedError"===n.name?(yield a(),i.show(),e.show("#".concat(C)),t.finished()):"SecurityError"===n.name&&(e.show(t._confirmButton),e.prop(t._confirmButton,{disabled:!1}))}}}))()}setError(e,t){w.clearTimeout(this.timeout),this.finished()}showTooFarNotification(t){var{distance:i,artifact:a,map:n}=t,o="meter",s=i;s>=1e3?(o="kilometer",s>=2e3&&(o+="s"),s=Math.round(s/1e3)):s>=2&&(o+="s"),this.artifact=a,this.map=n,this.XR=!1,this._tooFarDistanceInfo.innerText="This artifact is ".concat(s," ").concat(o," away."),e.show(this._tooFarContainer),e.on(this._tooFarPreviewButton,"click",this.onTooFarPreviewButtonClick),e.on(this._tooFarCancelButton,"click",this.onTooFarCancelButtonClick),e.on(this._tooFarAbortButton,"click",this.onTooFarCancelButtonClick)}onTooFarCancelButtonClick(){e.off(this._tooFarPreviewButton,"click",this.onTooFarPreviewButtonClick),this._isCancelled=!0,e.hide(this._tooFarContainer),this.finished()}onTooFarPreviewButtonClick(){var t=this;return n((function*(){e.off(t._tooFarPreviewButton,"click",t.onTooFarPreviewButtonClick),e.off(t._tooFarCancelButton,"click",t.onTooFarCancelButtonClick),e.off(t._tooFarAbortButton,"click",t.onTooFarCancelButtonClick),e.hide(t._tooFarContainer);var{artifact:i,map:a,XR:n}=t;yield t.init({artifact:i,map:a,XR:n}),yield t.startEngine()}))()}showWebglDisabledNotification(){e.show(this._webglDisabledContainer),e.hide([this._header,this._headerDone,this._preloadInfo,this._cancelButton,this._confirmButton]),e.on(this._webglDisabledOkButton,"click",this.onWebglDisabledOkButtonClick)}onWebglDisabledOkButtonClick(){e.off(this._webglDisabledOkButton,"click",this.onWebglDisabledOkButtonClick),this._isCancelled=!0,e.hide(this._webglDisabledContainer),this.finished()}finished(){this._isWorking=!1,this._timeoutShown=!1,e(".start-experience-button").forEach((e=>{e.removeAttribute("disabled")})),e.hide([this._warningContainer,this._confirmButton,this._preloadInfo,this._headerDone]),e.prop(this._confirmButton,{disabled:!0}),e.show(this._header),w.clearTimeout(this.timeout)}}export{Le as Preload};
