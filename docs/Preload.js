import{$ as e,ah as t,ai as a,aj as i,_ as n,ak as r,al as o,am as s,J as l,an as d,ao as c,ap as h,W as m,aq as u,ar as p,as as f,at as v,au as g,av as y,t as w,p as b,c as T,aw as S,ax as E,d as C,ay as x,f as P,a as j,ae as k,D as A,A as R,az as O,w as _,aA as L,n as I,e as B,aB as F,Z as D,aC as W,q as N,aD as H,aE as U,aF as V,aG as z,aH as X,r as q,V as G,H as K,E as Y,z as Z,aI as J,aJ as Q,aK as $,aL as ee,aM as te,aN as ae,h as ie,aO as ne,aP as re,o as oe,aQ as se,aR as le,aS as de,aT as ce,U as he,aU as me,aV as ue,aW as pe,aX as fe,aY as ve}from"./vendor.js";class ge{constructor(n){var{scene:r,sceneInstance:o,renderer:s,endSession:l}=n;this.endSession=l,this.engine=n,this.gui=e("#".concat(t)),this.hitSearch=e("#hud-searching-hittest"),this.scene=r,this.renderer=s,this.sceneInstance=o,e.on("#".concat(a),"click",this.onExitButtonClick.bind(this)),i(this),this.animToggler=e("#toggle-animation-button")}setCamera(t){this.cameraAccess=t,t?e.show(this.recordVideoButton):e.hide(this.recordVideoButton)}showAnimToggler(t){this.animToggler&&(this.animToggler.classList.remove("play"),e.show(this.animToggler),this.animTogglerInit||(this.animTogglerInit=!0,this.eventListener=()=>{this.animToggler.classList.toggle("play"),t()},e.on(this.animToggler,"click",this.eventListener)))}hideAnimToggler(){e.hide(this.animToggler)}show(){e.show(this.gui)}hide(){e.hide(this.gui)}onExitButtonClick(){var t=this;return n((function*(){t.engine.endSession(),e.off(t.animToggler,"click",t.eventListener),r()}))()}showHitSearch(){e.show(this.hitSearch)}hideHitSearch(){e.hide(this.hitSearch)}showElement(t){t.shown||(e.show(t),t.shown=!0)}hideElement(t){t.shown&&(e.hide(t),t.shown=!1)}}var{SCENE_TYPES:ye}=m.APP_DB;class we{constructor(e){var{artifact:t,preload:a,XR:i}=e;this.XR=i,this.artifact=t,this.preload=a;var{type:n=ye.Hit}=t;this.type=n,this.clock=new o,this.scene=new s,this.customMaterials=[],this.spatials=[],this.spatialObjects=[],this.lookAtCameraObjects=[],this.animateObjects=[],this.audioAnalysers=[],this.audioAnalyserEmissionConfigs=[],this.objects={},this.circlingLights=[],this.customObjects=[],this.videoTargets=[],this.animationListeners=[],this.materialFadeAnimations=[],this.eventsToRemove=[],this.renderSteps=[],this.unspawnObjects=[],this.animations=[],this.randomAudioElements=[],this.onResize=this.onResize.bind(this),this.render=this.render.bind(this),this.initFallbackSession=this.initFallbackSession.bind(this),this.toggleAnimations=this.toggleAnimations.bind(this),this.endSession=this.endSession.bind(this)}init(t){var a=this;return n((function*(){var i,{artifact:r,preload:o,scene:s,type:g,XR:y}=a;t&&(a.sceneInstance=t);var{fov:w,near:b,far:T}=l(r.cam,d),S=m.innerWidth/m.innerHeight;a.camera=new c(w,S,b,T),a.camera.updateProjectionMatrix(),s.add(a.camera);var E=new h({antialias:!0,alpha:!0});a.renderer=E,E.setPixelRatio(m.devicePixelRatio),E.setSize(m.innerWidth,m.innerHeight),E.domElement.id=u,E.useLegacyLights=!1,E.toneMapping=p;var{audio:C,audioElements:x,circlingLights:P,clickables:j,customMaterials:k,customObjects:A,fog:R,fogexp2:O,hideLight:_,ocean:L,particles:M,shadow:I,triggerVideo:B,underwater:F,wireframes:D,record3d:W,record3DImages:N,renderTargets:H,noShadowObjects:U,receiveNoShadowObjects:V,castNoShadowObjects:z,ws:X}=r;!1!==I&&(E.shadowMap.enabled=!0,E.shadowMap.type=f),a.hud=new ge(a);var q=null===(i=a.artifact.animateObjects)||void 0===i?void 0:i.some((e=>e.sound));if((C||null!=x&&x.length||q)&&a.addAudio(),a.addSkybox(),_||a.addLights(),(R||O)&&a.addFog(),X&&a.sceneInstance){var{host:G,port:K,protocol:Y}=X,Z={host:G,port:K,protocol:Y,scene:t};a.ws=new o.assets.WS(Z)}if(a.videoElement=o.assets.videoElement,null!=t&&t.init&&(yield t.init({engine:a,preload:o})),W&&r.type!==ye.FakeMirror&&!W.doNotInit){var J=a.videoElement,Q={artifact:r,engine:a,preload:o,videoElement:J},$=new o.assets.Record3D(Q);a.record3d=$,$.model&&(a.model=$.model),$.child&&(a.child=$.child),a.parentName=$.config.parentName,a.renderSteps.push($.tick)}if(N){var{Class:ee,images:te}=o.assets.Record3DImages,ae=new ee({engine:a,images:te,config:N});a.record3DImages=ae}if(null!=t&&t.beforeLoadModel&&t.beforeLoadModel({engine:a,preload:o}),yield a.loadModel(),null!=t&&t.afterLoadModel&&t.afterLoadModel({engine:a,preload:o}),a.artifact.showVideoTime&&(a.frameRateIndicator=e.create("div",{style:{position:"fixed",top:0,left:0,backgroundColor:"black",color:"white"},parent:"#hud"})),U&&U.forEach((e=>{var t=a.model.getObjectByName(e);t&&(t.receiveShadow=!1,t.castShadow=!1)})),V&&V.forEach((e=>{var t=a.model.getObjectByName(e);t&&(t.receiveShadow=!1)})),z&&z.forEach((e=>{var t=a.model.getObjectByName(e);t&&(t.castShadow=!1)})),H&&a.addRenderTargets(),null!=P&&P.length){var{CirclingLights:ie}=yield import("./vendor.js").then((function(e){return e.bj}));new ie(a)}if(k&&new o.assets.CustomMaterials(a),A&&(yield a.addCustomObjects()),D&&D.forEach((e=>{var t=a.model.getObjectByName(e.target);t&&t.material&&(t.material.wireframe=!0,e.transparent&&(t.material.transparent=!0,t.material.opacity=e.opacity))})),B&&(a.objects.videoTrigger=new o.assets.VideoTrigger(a)),F&&(yield a.addUnderwaterPlane()),L&&(a.objects.oceanPlane=new o.assets.OceanPlane({artifact:r,engine:a,preload:a.preload})),M&&(a.particles=new o.assets.Particles(a),yield a.particles.init()),E.setSize(m.innerWidth,m.innerHeight),e.append(E.domElement,"#".concat(v)),y)try{var ne=E.xr.getController(0);a.controller=ne;var{clickable:re,shadow:oe,shadowPlane:se}=r;if(!1!==oe&&!1!==se&&a.addShadowPlane(),!a.isHittestScene())throw new Error("Unknown scene type ".concat(g));g!==ye.Float&&a.spawnReticle(),e.on(ne,"select",(()=>{if(!a.justUnspawned){if(!a.modelSpawned){a.spawnModel(!1)}re?a.hud.showAnimToggler(a.toggleAnimations):a.hud.hideAnimToggler()}})),re||a.hud.hideAnimToggler(),s.add(ne),a.initScene=n((function*(){e.hide("#Locator");var t=yield m.NAV.xr.requestSession("immersive-ar",{requiredFeatures:["hit-test","dom-overlay"],domOverlay:{root:e("#hud")}});return a.refSpace=yield t.requestReferenceSpace("viewer"),a.renderer.xr.enabled=!0,a.renderer.xr.setReferenceSpaceType("local"),yield a.renderer.xr.setSession(t),t.initFallbackSession=a.initFallbackSession.bind(a),a.session=t,t}))}catch(e){a.initScene=a.initFallbackSession}else a.initScene=a.initFallbackSession;return null!=j&&j.length&&a.addClickables(),e.on(m,"resize",a.onResize),a.onResize(),E.setAnimationLoop(a.render),a}))()}onResize(){var{innerWidth:e,innerHeight:t}=m;this.camera.aspect=e/t,this.camera.updateProjectionMatrix(),this.renderer.setSize(e,t)}addRenderTargets(){var{renderTargets:e}=this.artifact;this.renderTargets=[],e.forEach((e=>{var t=l(e,{height:512,width:512,options:{depthBuffer:!1,stencilBuffer:!1},off:[]}),a=[];t.off.length&&t.off.forEach((e=>{var t=this.model.getObjectByName(e);t&&a.push(t)})),this.renderTargets.push({height:t.height,width:t.width,off:a,object:new g(t.width,t.height,t.options)})}))}addLights(){var{directionalLightPosition:e=ee.directionalPosition,directionalColor:t=ee.directionalColor,directionalIntensity:a=ee.directionalIntensity,ambientColor:i=ee.ambientColor,ambientIntensity:n=ee.ambientIntensity}=this.artifact,r=new y(t,a);r.position.set(...e),r.castShadow=!0,!1!==this.artifact.shadow&&(r.shadow.bias=-1e-4,r.shadow.mapSize.width=4096,r.shadow.mapSize.height=4096,r.shadow.camera.left=-70,r.shadow.camera.right=70,r.shadow.camera.top=70,r.shadow.camera.bottom=-70,r.shadow.camera.near=.1,r.shadow.camera.far=300),this.directionalLight=r,this.scene.add(r),this.ambientLight=new w(i,n),this.scene.add(this.ambientLight)}addCustomObjects(){var{artifact:e}=this,{customObjects:t}=e;t.forEach((e=>{var{config:t,object:a}=e,i=this.model.getObjectByName(t.target);i&&(a.child?i.add(a.child):a.model&&(i.parent.add(a.model),i.parent.remove(i)),this.customObjects.push({config:t,object:a}),b.fn(a.init)&&a.init({engine:this}))}))}addShadowPlane(){var e=new T(150,150,64,64),t=new S;t.opacity=E;var a=new C(e,t);a.receiveShadow=!0,a.lookAt(0,100,0),a.position.set(0,.01,0),this.shadowPlane=a}addPortal(){this.objects.portal=new this.preload.assets.Portal.Factory({engine:this,mergeConfig:l})}spawnReticle(){var e=new x(.15,.2,32).rotateX(-M.PI/2),t=new P;this.reticle=new C(e,t),this.reticle.matrixAutoUpdate=!1,this.reticle.visible=!1,this.scene.add(this.reticle)}onAnimationLoop(e,t){var a=e.action._clip.name;t.forEach((e=>{if(!this.materialFadeAnimations.includes((e=>e.action._clip.name===a))){var t=this.findEventTargets(e);this.materialFadeAnimations.push(j(j({},e),{},{targets:t}))}}))}onAnimationFinished(e,t){var a=e.action._clip.name;t.forEach((e=>{if(!this.materialFadeAnimations.includes((e=>e.action._clip.name===a))){var t=this.findEventTargets(e);this.materialFadeAnimations.push(j(j({},e),{},{targets:t}))}}))}glow(){var{glow:e}=this.artifact;this.model.traverse((t=>{if(k(t.name,"glow")){var a=b.bool(e)?238:e,i=new P({color:a,side:A,blending:R,transparent:!0});t.material=i}}))}addClickables(){var{artifact:t,controller:a,model:i,preload:n,renderer:r,XR:o}=this,{clickables:s=[],clickableChildren:l=!1}=t,d=[];if(!0===s?d.push(i):s.length&&i.traverse((e=>{s.forEach((t=>{if(b.str(t)&&(t={target:t}),O({node:e,search:t.target})){var a;t.node=e,t.hide&&(e.material.transparent=!0,e.material.opacity=0);var i=!0===t.audio?e.name:t.audio;if(null!==(a=n.assets.audioElements)&&void 0!==a&&a.length){var r=n.assets.audioElements.find((e=>{var{ele:t}=e;return t.dataset.name===i}));r&&(t.player=r.ele)}d.includes(t)||d.push(t)}}))})),d.length){var{Controls:c}=n.assets;this.controls=new c({clickableChildren:l,clickables:d,engine:this}),o?e.on(a,"select",this.controls.select,!1):e.on(r.domElement,"mousedown",this.controls.click,!1)}}onTouch(t){var a;null!==(a=this.sceneInstance)&&void 0!==a&&a.onTouch&&this.sceneInstance.onTouch(t),t.forEach(((t,a)=>{if(!(a+1>this.artifact.maxTouches)){var{emission:i,emissionIntensity:n=.2,link:r,player:o}=t;if(r&&(_?window.location.href=r:window.open(r,"_hacked")),o&&(o.loop?o.paused?o.play():(o.currentTime=0,o.pause()):(o.currentTime=0,o.play())),i){var s=t.node.name.split("_")[0],l=this.model.getObjectByName(s);if(!l)return;("Group"===l.type?l.children:[l]).forEach((t=>{if(t&&(t.userData.origEmissive||(t.userData.origEmissive=t.material.emissive),t.userData.origEmissiveIntensity||(t.userData.origEmissiveIntensity=t.material.emissiveIntensity),o))if(L.same(t.material.emissive,t.userData.origEmissive)){var a=new I(1,1,1);b.bool(i)?t.material.color&&(a=t.material.color):b.arr(i)&&(a=new I(...i)),t.material.emissive=a,t.material.emissiveIntensity=n,o.loop||e.on(o,"ended",(()=>{t.material.emissive=t.userData.origEmissive,t.material.emissiveIntensity=t.userData.origEmissiveIntensity}))}else o.loop&&(t.material.emissive=t.userData.origEmissive,t.material.emissiveIntensity=t.userData.origEmissiveIntensity)}))}}}))}nosort(){this.renderer.sortObjects=!1}clip(){var{artifact:e,model:t}=this,{clipSide:a,clipInFallback:i}=e;t.traverse((e=>{if(k(e.name,"clip"))if(this.XR||!1!==i){var t=a||e.material.side;e.material=new P({color:"green",colorWrite:!1,side:t}),e.castShadow=!1,e.receiveShadow=!1,e.renderOrder=1}else e.visible=!1;else e.renderOrder=2}))}addUnderwaterPlane(){var e=this;return n((function*(){e.cameraPlane=new e.preload.assets.UnderwaterPlane({engine:e}),yield e.cameraPlane.preload(e)}))()}addSkybox(){var e=this;return n((function*(){var{artifact:t,preload:a,renderer:i,scene:n,XR:r}=e,o=te,s=null==t?void 0:t.skySphere;b.arr(s)&&s.length&&(o=s);var l=new B(...o),d=a.assets.skybox,c=new P({map:d,side:F}),h=new C(l,c);if(h.rotation.y=D.degToRad(180),h.visible=!r,n.add(h),!1!==t.light&&!t.hideEnvironment){var m=new W(i);m.compileEquirectangularShader();var u=m.fromEquirectangular(d).texture;n.environment=u,u.dispose(),m.dispose()}e.skybox=h}))()}addAudio(){this.listener=new N,this.camera.add(this.listener)}addFog(){var{artifact:e,scene:t}=this,{fog:a,fogexp2:i}=e;if(a){var{color:n,near:r,far:o}=a;t.fog=new H(n,r,o)}if(i){var{color:s,density:l}=i;t.fog=new U(s,l)}}startMedia(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];if(!this.isMediaPlaying){this.isMediaPlaying=!0;var{actions:t=[],artifact:a,preload:i}=this,{videoElement:n,audioElements:r=[]}=i.assets;a.triggerAudio||null!=r&&r.length&&r.forEach((t=>{var{config:a,ele:i}=t;a.autoplay?(e&&(i.currentTime=0),a.volume&&(b.fn(i.setVolume)?i.setVolume(a.volume):i.volume=a.volume),i.play()):a.random&&(a.interval=V(a.interval),this.randomAudioElements.push({ele:i,config:a}))})),n&&!a.triggerVideo&&(e&&(n.currentTime=0),n.play()),t.forEach((e=>e.play()))}}stopMedia(){var{preload:e,videoElement:t,actions:a=[],audioElements:i=[]}=this;t&&t.pause(),e.hls&&e.hls.destroy(),a&&a.length&&a.forEach((e=>e.stop())),i.forEach((e=>{var{ele:t}=e;return t.pause()})),this.isMediaPlaying=!1}toggleAnimations(){this.actions.forEach((e=>e.paused=!e.paused))}initFallbackSession(){var e=this;return n((function*(){var t;e.XR=!1,m.B.classList.add(z);var{camera:a,artifact:i,model:n,renderer:r}=e,{clickable:o}=i,{Controller:s}=e.preload.assets;s&&(e.controller=new s(a,r.domElement,i),e.controller.unspawn&&e.unspawnObjects.push(e.controller)),e.skybox.visible=!0,o?e.hud.showAnimToggler(e.toggleAnimations):e.hud.hideAnimToggler();var{cam:l={}}=i,d=ae,{x:c=d.x,y:h=d.y,z:u=d.z}=l;a.position.set(c,h,u);var{scale:p}=i;if(p&&n){var{x:f,y:v,z:g}=n.scale;b.num(p)&&n.scale.set(f*p,v*p,g*p)}null===(t=e.controller)||void 0===t||t.update();e.spawnModel(!0),r.domElement.focus()}))()}loadModel(){var e=this;return n((function*(){var t,a,i,{artifact:n,preload:r,sceneInstance:o={}}=e,{spatialObjects:s=[],audioElements:l=[]}=n;(e.spatials=[...s,...l],null!=o&&o.model&&(e.model&&e.model!==o.model?e.model.add(o.model):e.model||(e.model=o.model)),null!==(t=r.assets.gltf)&&void 0!==t&&t.scene)&&(e.model?e.model.add(null===(a=r.assets.gltf)||void 0===a?void 0:a.scene):e.model=null===(i=r.assets.gltf)||void 0===i?void 0:i.scene);if(n.ply&&r.assets.addPly(e),e.addAnimations(),e.model){var d,c,h={},{parentName:m=o.parentName,child:u=o.child}=e;if(m&&u&&(c=e.model.getObjectByName(m),e.modelParent=c),e.model.traverse((t=>{if(e.customObjects.forEach((e=>{var{object:a}=e;a.parentName&&a.child&&k(t.name,a.parentName)&&(h[a.name]=t)})),t.isMesh){var{frustumCulled:a,transparent:i,castShadow:r,receiveShadow:o,noShadowObjects:s=[],noShadowCastObjects:l=[],noShadowReceiveObjects:d=[]}=n;(!1===a||null!=a&&a.includes(t.name))&&(t.frustumCulled=!1),!1===i&&(t.material.transparent=!1),k(t.name,"noshadow")||s.includes(t.name)||(k(t.name,"noshadowcast")||l.includes(t.name)||(t.castShadow=!1!==r),k(t.name,"noshadowreceive")||d.includes(t.name)||(t.receiveShadow=!1!==o)),k(t.name,"videotarget")&&e.videoTargets.push(t),t.material.map&&(t.material.map.anisotropy=16,t.material.map.colorSpace=X),t.material.emissiveMap&&(t.material.emissiveMap.colorSpace=X),(t.material.map||t.material.emissiveMap)&&(t.material.needsUpdate=!0)}var c=[];n.animateObjects&&n.animateObjects.forEach((a=>{if(k(t.name,a.name)){var i=e.actions.find((e=>e._clip.name===t.name));if(a.sound){!0===a.sound&&(a.sound={name:e.artifact.slug}),a.sound.name||(a.sound.name=e.artifact.slug);var n=e.preload.assets.animateObjects[a.sound.name];if(n){var r=new q(e.listener);r.setBuffer(n);var{loopSound:o=!0}=a;if(r.setLoop(o),a.audio=r,a.sound.distance){var s=!1!==a.sound.yDistanceTest;c.push({buffer:r,distance:a.sound.distance,distanceTarget:t.name,target:t.name,yDistanceTest:s})}}}e.animateObjects.push(j(j({},a),{},{action:i,node:t}))}})),e.spatials=[...e.spatials,...c]})),e.spatials.length){var{SpatialObjects:p}=yield import("./vendor.js").then((function(e){return e.bk}));e.objects.spatialObjects=new p(e)}if(null!==(d=n.lookAtCameraObjects)&&void 0!==d&&d.length){var f=new r.assets.LookAtCamera(e);e.addRenderStep(f.render.bind(f))}if(c&&(o.child?c.add(o.child):e.child&&c.add(e.child)),e.customObjects.forEach((t=>{var{object:a}=t;a.child?h[a.name].add(a.child):a.model&&e.model.add(a.model)})),e.videoElement&&e.videoTargets.length){var v,{flipVideo:g,chromaKey:y}=n,w=new G(e.videoElement);!1!==g&&(w.flipY=!1);var{examples:b={}}=null===(v=e.preload)||void 0===v?void 0:v.assets,{ChromaKeyMaterial:T=!1}=b;e.videoTargets.forEach((e=>{y?T&&(e.material=new T(y,w)):e.material.map=w}))}}var{clip:S,glow:E,portal:C,nosort:x,clones:P,clonesOnMeshes:A}=e.artifact;if(E&&e.glow(),C&&e.addPortal(),e.model&&S&&e.clip(),x&&e.nosort(),r.assets.Mirrors&&new r.assets.Mirrors(e),e.artifact.analyseAudio){var{AnalyseAudio:R}=yield import("./vendor.js").then((function(e){return e.bl})),O=new R(e);e.addRenderStep(O.render)}if(e.model){if(e.model.position.set(5e3,5e3,5e3),P){var{Clones:_}=yield import("./vendor.js").then((function(e){return e.bm}));e.clones=new _(e)}if(A){var{ClonesOnMeshes:L}=yield import("./vendor.js").then((function(e){return e.bn}));e.meshClones=new L(e)}e.scene.add(e.model)}}))()}addAnimations(){var t,a,i;if(null!==(t=this.sceneInstance)&&void 0!==t&&null!==(t=t.animations)&&void 0!==t&&t.length&&this.animations.push(...this.sceneInstance.animations),null!==(a=this.preload.assets.gltf)&&void 0!==a&&null!==(a=a.animations)&&void 0!==a&&a.length&&this.animations.push(...this.preload.assets.gltf.animations),this.actions=[],null!==(i=this.animations)&&void 0!==i&&i.length){var n;this.mixer=new K(this.model);var{animations:r={}}=this.artifact,{loop:o,startOnTouch:s,clampWhenFinished:l=!0,autoplay:d=!0,noLoopAnimations:c=[],pausedAnimations:h=[],timeScale:m=1}=r;if(this.animations.forEach((e=>{var t=this.mixer.clipAction(e),a=h.includes(e.name),i=s||!d||a;(!1===o||c.includes(e.name))&&(t.clampWhenFinished=l,t.loop=Y),i&&(t.paused=!0),b.num(m)?t.timeScale=m:b.obj(m)&&m.hasOwnProperty(t.name)&&(t.timeScale=m[t.name]),this.actions.push(t)})),null!==(n=this.artifact.events)&&void 0!==n&&n.animation){var{events:u}=this.artifact,{times:p=[],loop:f=[],finished:v=[]}=null==u?void 0:u.animation;if(f.length){var g=[this.mixer,"loop",e=>this.onAnimationLoop(e,f)];e.on(...g),g.targets=this.findEventTargets(f),this.eventsToRemove.push(g)}if(v.length){var y=[this.mixer,"finished",e=>this.onAnimationFinished(e,v)];e.on(...y),y.targets=this.findEventTargets(v),this.eventsToRemove.push(y)}if(p.length){var{times:w}=this.artifact.events.animation;w.length&&w.forEach((e=>{var{action:t,once:a=!1}=e,i=Z.findByName(this.animations,t),n=this.findEventTargets(e);this.animationListeners.push(j(j({},e),{},{once:a,action:i,targets:n}))}))}}}}findEventTargets(e){var t=[];return this.model.traverse((a=>{O({node:a,search:e.targets})&&(a.material&&(t.includes(a.material)||t.push(a.material)))})),t}spawnModel(e){var t,{artifact:a,camera:i,controller:n,model:r,reticle:o,scene:s,sceneInstance:l={},shadowPlane:d,type:c,XR:h}=this,{showSkybox:m,skyboxTransparency:u,floatSpawnAtZeroY:p=!1}=a;if(!h||e)r&&r.position.set(0,0,0),this.modelSpawned=!0;else if(this.isHittestScene()){if(!this.modelSpawned&&this.lastHit){o.updateMatrixWorld(),r.position.setFromMatrixPosition(o.matrixWorld),r.updateMatrixWorld();var f=i.position,v=r.position,g=f.x-v.x,y=f.z-v.z,w=Math.atan2(g,y);r.rotation.y=w,d&&(d.position.setFromMatrixPosition(o.matrixWorld),s.add(d)),r.visible=!0,o.visible=!1,this.modelSpawned=!0}}else if(c===ye.Float){var T=r.clone();T.position.set(0,0,-1).applyMatrix4(n.matrixWorld),p&&(T.position.y=0),s.add(T)}if(this.applyPositionAndRotation(),null!=l&&l.spawnModel&&l.spawnModel({engine:this}),null!=l&&l.afterSpawnModel&&l.afterSpawnModel({engine:this}),this.startMedia(),m&&(this.skybox.visible=!0,u&&(this.skybox.material.transparent=!0,this.skybox.material.opacity=u),this.skybox.receiveShadow=!1),null!==(t=this.preload.gui)&&void 0!==t&&t.afterSpawnModel){var{afterSpawnModel:S}=this.preload.gui;S.style.visibility="visible",S.style.opacity=1,setTimeout((()=>{var e;b.fn(null===(e=S.parentNode)||void 0===e?void 0:e.removeChild)&&S.parentNode.removeChild(S)}),8e3)}}unspawnModel(){var t;this.modelSpawned&&(this.scene.remove(this.model),this.modelSpawned=!1,this.isAnimationRunning=!1,this.stopMedia(),this.exitSceneInstance(),this.justUnspawned=!0,null!==(t=this.eventsToRemove)&&void 0!==t&&t.length&&this.eventsToRemove.forEach((t=>{e.off(...t)})),this.unspawnObjects.forEach((e=>{null==e||e.unspawn(this)})),setTimeout((()=>{this.justUnspawned=!1}),200))}exitSceneInstance(){var t;this.customObjects.forEach((e=>{var{object:t}=e;b.fn(t.exit)&&t.exit({engine:this})})),this.customMaterials.forEach((e=>{var{material:t}=e;b.fn(t.exit)&&t.exit({engine:this})})),this.animateObjects.forEach((e=>{var t;null===(t=e.audio)||void 0===t||t.stop()})),null!==(t=this.sceneInstance)&&void 0!==t&&t.exit&&this.sceneInstance.exit({engine:this}),this.frameRateIndicator&&e.remove(this.frameRateIndicator)}applyPositionAndRotation(){var{artifact:e,model:t}=this;if(t){var{pos:a={},rot:i={}}=e,{x:n,y:r,z:o}=a;n&&(t.position.x+=n),r&&(t.position.y+=r),o&&(t.position.z+=o);var{x:s,y:l,z:d}=i,c=D.degToRad;s&&t.rotateX(c(s)),l&&t.rotateY(c(l)),d&&t.rotateZ(c(d))}}endSession(){var t,a;if(null===(t=this.session)||void 0===t||!t.ended){this.session&&(this.session.end(),this.session.ended=!0),this.hud.hide(),this.renderer.setAnimationLoop(null),e("#".concat(v)).classList.remove("visible"),this.exitSceneInstance(),this.scene&&J(this.scene),e.remove(".".concat(Q)),null!==(a=this.preload)&&void 0!==a&&a.hls&&(this.preload.hls.destroy(),e.remove(this.preload.hlsScript));var i=e("#".concat(u));if(i){var n=i.parentNode;n.id===v?e.remove(i):e.remove(n)}m.B.classList.remove(z),e(".start-experience-button").forEach((e=>{e.removeAttribute("disabled")})),_&&m.location.reload()}}isHittestScene(){return![ye.Float].includes(this.type)}addRenderStep(e){this.renderSteps.push(e)}render(e,t){var a=this;return n((function*(){var i,n,r,o,s,l,d=a.clock.getDelta();if(a.renderHittest(t),a.mixer)if(a.artifact.videoBoundAnimation&&a.videoElement){a.lastFrameVideoTime||(a.lastFrameVideoTime=a.videoElement.currentTime);var c=a.videoElement.currentTime-a.lastFrameVideoTime;c&&a.mixer.update(c),a.lastFrameVideoTime=a.videoElement.currentTime}else a.mixer.update(d);var h={delta:d,timestamp:e,engine:a,frame:t};a.modelSpawned&&a.renderSteps.forEach((e=>{e(h)})),a.artifact.showVideoTime&&(a.frameRateIndicator.innerText="Videotime: ".concat(a.videoElement.currentTime)),null!==(i=a.sceneInstance)&&void 0!==i&&i.tick&&a.sceneInstance.tick(h),null!==(n=a.artifact.ply)&&void 0!==n&&n.animated&&a.renderPlyMorphTargetInfluences(h),null!==(r=a.animateObjects)&&void 0!==r&&r.length&&a.renderAnimateObjects(h),null!==(o=a.animationListeners)&&void 0!==o&&o.length&&a.renderAnimationTimeEvent(h),a.materialFadeAnimations.length&&a.renderMaterialAnimTick(h),null!==(s=a.randomAudioElements)&&void 0!==s&&s.length&&a.renderRandomAudio(h),a.particles&&a.particles.update(h),a.customObjects.length&&a.renderCustomObjects(h),null!==(l=a.sceneInstance)&&void 0!==l&&l.render?a.sceneInstance.render(h):a.renderer.render(a.scene,a.camera),a.controller&&(a.controller.update&&a.controller.update(d),a.controller.render&&a.controller.render(d))}))()}renderRenderTargets(e){var{renderTargets:t}=this;t.forEach((e=>{e.off.length&&e.off.forEach((e=>{e.visible=!1})),this.renderer.setRenderTarget(e.object),this.renderer.render(scene,camera),this.renderer.setRenderTarget(null),e.off.length&&e.off.forEach((e=>{e.visible=!0}))}))}renderPlyMorphTargetInfluences(e){var{delta:t,timestamp:a}=e;this.nextMorphTargetStep||(this.nextMorphTargetStep=a+this.morphTargetInfluenceConfig.delay);var i=this.animatedPoints,n=i.morphTargetInfluences.length-1,r=t*this.morphTargetInfluenceConfig.speed;i.morphTargetInfluences=i.morphTargetInfluences.map(((e,t)=>{if(t===this.morphTargetTargetIndex){var i=Math.min(e+r,1);return i>=1&&a>this.nextMorphTargetStep&&(this.nextMorphTargetStep=a+this.morphTargetInfluenceConfig.delay,this.hasRun=!this.hasRun,this.hasRun||(this.morphTargetTargetIndex+=1,this.morphTargetTargetIndex>n&&(this.morphTargetTargetIndex=0))),i}return Math.max(e-r,0)}))}renderCustomObjects(e){this.customObjects.forEach((t=>{var{object:a}=t;b.fn(a.tick)&&a.tick(e)}))}renderAnimateObjects(e){var{timestamp:t}=e;this.animateObjects.forEach((e=>{var{action:a,audio:i,speed:n,minSpeed:r=0,maxDelay:o=2,minDelay:s=1}=e;if(a&&a.paused&&(e.nextAnimation||(e.nextAnimation=t+Math.random()*(1e3*o)+1e3*s),i.isPlaying&&i.stop(),e.nextAnimation<=t)){e.nextAnimation=!1;var l=Math.random()>.5?1:-1,d=Math.max(r,Math.random()*n)*l;a.timeScale=d,a.paused=!1,a.play(),i&&!i.isPlaying&&i.play()}}))}renderHittest(t){var a=this;return n((function*(){if(t&&a.XR){var i=a.renderer.xr.getSession();a.hitTestSourceRequested||(a.hitTestSource=yield i.requestHitTestSource({space:a.refSpace}),e.on(i,"end",(()=>{a.hitTestSourceRequested=!1,a.hitTestSource=null})),a.hitTestSourceRequested=!0);var n=t.getHitTestResults(a.hitTestSource);if(n.length){if(a.lastHit=n[0],!a.modelSpawned){a.reticle.visible=!0;var r=a.renderer.xr.getReferenceSpace();a.reticle.matrix.fromArray(a.lastHit.getPose(r).transform.matrix)}a.hud.hideHitSearch()}else a.reticle.visible=!1,a.modelSpawned||a.hud.showHitSearch(),a.lastHit=void 0}}))()}renderAnimationTimeEvent(){this.animationListeners.forEach((e=>{var{time:t,action:a,once:i}=e,{time:n}=a;!e.hasTriggered&&n>=t?(e.hasTriggered=!0,this.materialFadeAnimations.push(e)):n<=t&&(i||(e.hasTriggered=!1))}))}renderRandomAudio(e){var{timestamp:t}=e;this.modelSpawned&&this.randomAudioElements.forEach((e=>{var{ele:a,config:i}=e;if(a.paused&&(i.nextPlayTime||(i.nextPlayTime=t+$(i.interval)),i.nextPlayTime<=t)){a.time=0,a.play();var n=$(i.interval);i.nextPlayTime=t+n+1e3*a.duration}}))}renderMaterialAnimTick(e){var{delta:t}=e;this.materialFadeAnimations.forEach(((e,a)=>{if(e){var{targets:i=[],speed:n=1,to:r=0,props:o}=e;i.forEach((e=>{var i=b.arr(o)?o:[o],s=!0;i.map((a=>{var i=e[a]+n*t;n<0?i<=r?i=r:s=!1:n>0&&(i>=r?i=r:s=!1),e[a]=i})),s&&this.materialFadeAnimations.splice(a,1)}))}}))}}var be=(e,t)=>b.arr(t)||b.str(t)?t.includes(e)||t===e:null==t?void 0:t.hasOwnProperty(e);class Te{constructor(t){var{artifact:a,root:i,THREE:n,XR:r=!0}=t;this.artifact=a,this.root=i,this.XR=!1===r?r:m.SUPPORTS.XR,n&&(this.THREE=n);var{android:o,chrome:s}=ue;this.isAndroidChrome=o&&s,this._warningContainer=e("#timeout-warning"),this._header=e("#timeout-warning-header"),this._headerDone=e("#timeout-warning-header-done"),this._preloadInfo=e("#timeout-warning-info"),this._cancelButton=e("#timeout-warning-cancel"),this._confirmButton=e("#timeout-warning-confirm"),this._tooFarContainer=e("#toofar-warning"),this._tooFarPreviewButton=e("#toofar-warning-load-preview-button"),this._tooFarDistanceInfo=e("#toofar-warning-distance"),this._tooFarCancelButton=e("#toofar-warning-cancel-button"),this._tooFarAbortButton=e("#toofar-warning-abort-button"),this._webglDisabledContainer=e("#timeout-warning-webgl-disabled"),this._webglDisabledOkButton=e("#timeout-warning-webgl-disabled-ok-button"),this.confirmButtonClickHandler=this.confirmButtonClickHandler.bind(this),e.on(this._confirmButton,"click",this.confirmButtonClickHandler),this.onTooFarCancelButtonClick=this.onTooFarCancelButtonClick.bind(this),this.onTooFarPreviewButtonClick=this.onTooFarPreviewButtonClick.bind(this),this.onWebglDisabledOkButtonClick=this.onWebglDisabledOkButtonClick.bind(this),this.promisifiedLoad=this.promisifiedLoad.bind(this),this.textureLoader=new ie,this.gltfLoader=new ne,this.plyLoader=new re,this.audioLoader=new oe,this.fontLoader=new se,this.audioElements=[],this.collectPreloadPromises(),this.startEngine=this.startEngine.bind(this),this.onVideoCanPlayThrough=this.onVideoCanPlayThrough.bind(this)}collectPreloadPromises(){var{animateObjects:e,audio:t,audioElements:a,chromaKey:i,clickables:n=[],customMaterials:r,customObjects:o,fonts:s,glb:l,gui:d,mirrors:c,ply:h,textures:m,type:u,video:p,lookAtCameraObjects:f,ocean:v,particles:g,portal:y,record3d:w,record3DImages:T,triggerVideo:S,underwater:E,ws:C}=this.artifact,x={};if(x.skybox=this.loadSkybox(),(t||a)&&(x.audioElements=this.loadAudioElements()),S&&(x.VideoTrigger=this.loadVideoTrigger()),E&&(x.UnderwaterPlane=this.loadUnderwaterPlane()),g&&(x.Particles=this.loadParticles()),null!=c&&c.length&&(x.Mirrors=this.loadMirrors()),n.length&&(x.Controls=this.loadControls()),v&&(x.OceanPlane=this.loadOceanPlane(),x.waterNormals=this.loadWaterNormals()),le(u,APP_DB.SCENE_TYPES)||(x.scene=this.loadScene()),!1!==l&&(x.gltf=this.loadGltf()),h&&(x.ply=this.loadPly(),x.addPly=this.loadAddPly()),m&&(x.textures=this.loadTextures()),i){var P=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return b.str(t)&&(t=str.split(" ")),b.arr(t)?t.push(e):b.obj(t)&&(t[e]=!0),t}("ChromaKeyMaterial",this.artifact.examples);this.artifact.examples=P}if(y&&(x.Portal=this.loadPortal()),w&&(x.Record3D=this.loadRecord3D(),w.images&&(x.textures=this.loadRecord3DTextures(x.textures))),T&&(x.Record3DImages=this.loadRecord3DImages(T.images)),C&&(x.WS=this.loadWS()),p){var{slug:j,video:k}=this.artifact;x.videoElement=this.loadVideo({slug:j,video:k})}null!=f&&f.length&&(x.LookAtCamera=this.loadLookAtCamera()),s&&(x.fonts=this.loadFonts()),this.artifact.examples&&(x.examples=this.loadExamples()),d&&this.loadGui(),r&&(x.customMaterials=this.loadCustomMaterials(),x.CustomMaterials=this.loadCustomMaterialClasses()),o&&(x.customObjects=this.loadCustomObjects()),e&&(x.animateObjects=this.loadAnimateObjects()),this.XR||this.artifact.noControls||(x.Controller=this.loadController()),this.promises=x}init(){var t=this;return n((function*(){t._isWorking=!0,t._isCancelled=!1,t._session=!1,e.on(t._cancelButton,"click",(()=>{t._isCancelled=!0,t.finished()})),e.show([t._warningContainer,t._header]),t.timeout=m.setTimeout(t.showTimeoutWarning,de),yield t.startEngine()}))()}loadScene(){var t=this;return n((function*(){var{artifact:a}=t,i=APP_DB.SCENE_TYPES,{type:n=i.Hit}=a,r=Object.entries(i).find((e=>{var[t,a]=e;return a===n})),o="".concat(t.root,"/CustomScene.js");if(b.arr(r)){var s=r[0];o="./scenes/".concat(s,".js")}var{default:d}=yield import(o),c=new d({artifact:a,mergeConfig:l,nodeNameIncludes:k,nodeNameMatchesWildcard:O,preload:t,$:e,W:m,is:b});return b.fn(null==c?void 0:c.preload)?yield c.preload({artifact:a,preload:t}):b.fn(null==c?void 0:c.load)&&(yield c.load({artifact:a,preload:t})),c}))()}loadWS(){return n((function*(){var{WS:e}=yield import("./WS.js");return e}))()}loadMirrors(){return n((function*(){var{Mirrors:e}=yield import("./vendor.js").then((function(e){return e.bo}));return e}))()}loadAddPly(){return n((function*(){var{addPly:e}=yield import("./vendor.js").then((function(e){return e.bp}));return e}))()}loadParticles(){return n((function*(){var{Particles:e}=yield import("./vendor.js").then((function(e){return e.bq}));return e}))()}loadLookAtCamera(){return n((function*(){var{LookAtCamera:e}=yield import("./vendor.js").then((function(e){return e.br}));return e}))()}loadSkybox(){var e=this;return n((function*(){var{city:t,sky:a,slug:i}=e.artifact,n=a||i;ce(n)||(n=[m.STATIC_URL,"skybox",t,n].filter((e=>e)).join("/"));var r="jpg";return m.SUPPORTS.WEBP&&(r="webp"),n.endsWith(".".concat(r))||(n+=".".concat(r)),yield e.promisifiedLoad({loader:e.textureLoader,file:n})}))()}loadFonts(){var e=this;return n((function*(){var{fonts:t}=e.artifact,a={};return yield Promise.all(t.map(function(){var t=n((function*(t){var i="https://static.artificialmuseum.com/font/json/".concat(t,".typeface.json");a[t]=yield e.promisifiedLoad({loader:e.fontLoader,file:i})}));return function(e){return t.apply(this,arguments)}}())),a}))()}loadAnimateObjects(){var e=this;return n((function*(){var{animateObjects:t,slug:a}=e.artifact,i={},r=e.audioLoader;return yield Promise.all(t.map(function(){var t=n((function*(t){if(t.sound){var{sound:n={}}=t;if(!0===n&&(n={name:a}),n.name||(n.name=a),!i[n.name]){var o=".mp3";m.SUPPORTS.A_MP4?o=".mp4":m.SUPPORTS.A_OGG&&(o=".ogg");var s="https://media.artificialmuseum.com/audio/".concat(n.name).concat(o);i[n.name]=yield e.promisifiedLoad({loader:r,file:s})}}}));return function(e){return t.apply(this,arguments)}}())),i}))()}loadExamples(){var e=this;return n((function*(){var{examples:t}=e.artifact,a=[];be("TextGeometry",t)&&a.push(["TextGeometry",import("./vendor.js").then((function(e){return e.bs}))]),be("ChromaKeyMaterial",t)&&a.push(["ChromaKeyMaterial",import("./materials/ChromaKeyMaterial.js")]);var i=yield Promise.all(a.map(function(){var e=n((function*(e){var[t,a]=e,i=yield a;return[t,i[t]?i[t]:i.default]}));return function(t){return e.apply(this,arguments)}}()));return Object.fromEntries(i)}))()}loadCustomMaterials(){var e=this;return n((function*(){var{artifact:t}=e,{customMaterials:a}=t;return Promise.all(a.map(function(){var a=n((function*(a){var i=a.name.endsWith("Material")?a.name:"".concat(a.name,"Material"),{default:n}=yield import("./materials/".concat(i,".js")),r=new n({artifact:t,config:a,preload:e});return b.fn(r.preload)?yield r.preload({artifact:t,config:a}):b.fn(r.load)&&(yield r.load({artifact:t,config:a})),{config:a,material:r}}));return function(e){return a.apply(this,arguments)}}()))}))()}loadCustomMaterialClasses(){return n((function*(){var{CustomMaterials:e}=yield import("./vendor.js").then((function(e){return e.bt}));return e}))()}loadCustomObjects(){var e=this;return n((function*(){var{artifact:t}=e,{customObjects:a}=t;return Promise.all(a.map(function(){var a=n((function*(a){var{default:i}=yield import("./objects/".concat(a.name,".js")),n=new i({artifact:t,config:a,preload:e});return b.fn(n.preload)&&(yield n.preload()),n}));return function(e){return a.apply(this,arguments)}}()))}))()}loadRecord3D(){return n((function*(){var{Record3D:e}=yield import("./vendor.js").then((function(e){return e.bi}));return e}))()}loadRecord3DImages(){var e=arguments,t=this;return n((function*(){var a=e.length>0&&void 0!==e[0]?e[0]:[],i=t.textureLoader,{Record3DImages:r}=yield import("./vendor.js").then((function(e){return e.bu})),o=yield Promise.all(a.map(function(){var e=n((function*(e){var a="".concat(m.STATIC_URL,"/").concat(e.src,"?v=").concat(t.artifact.version),{position:n,quaternion:r,intrMat:o}=e;return{object:yield t.promisifiedLoad({loader:i,file:a}),position:n,quaternion:r,intrMat:o}}));return function(t){return e.apply(this,arguments)}}()));return{Class:r,images:o}}))()}loadRecord3DTextures(){var e=arguments,t=this;return n((function*(){var a=e.length>0&&void 0!==e[0]?e[0]:{},i=t.textureLoader;return yield Promise.all(t.artifact.record3d.images.map(function(){var e=n((function*(e){var n=e.file?e.file:e,r=n;ce(r)||(r=[m.STATIC_URL,"livedata",t.artifact.livedataCategory,r].filter((e=>e)).join("/"));var o=yield t.promisifiedLoad({loader:i,file:r});a[n]=o}));return function(t){return e.apply(this,arguments)}}())),a}))()}handlePlacardName(e){var{name:t,ext:a=".jpg",type:i,slug:n}=e;return(t=b.str(t)?t:n).endsWith("/")&&(t+=n),t.endsWith(".png")?(a=".png",t.slice(0,-4)):t.endsWith(".jpg")&&(a=".jpg",t.slice(0,-4)),a.startsWith(".")||(a=".".concat(a)),ce(t)||(t="".concat(m.STATIC_URL,"/placards/").concat(t,"_").concat(i).concat(a)),t}loadPortal(){var e=this;return n((function*(){var{placardImage:t=!1,placardExtension:a=".jpg",load:i}=e.artifact.portal,{Portal:r}=yield import("./vendor.js").then((function(e){return e.bv})),o=[["Factory",r]];if(!1!==t){var{slug:s}=e.artifact,l=e.handlePlacardName({name:t,ext:a,type:"color",slug:s}),d=e.handlePlacardName({name:t,ext:a,type:"normal",slug:s});o.push(["placardColor",e.promisifiedLoad({loader:e.textureLoader,file:l})]),o.push(["placardNormal",e.promisifiedLoad({loader:e.textureLoader,file:d})])}if(!1!==i){var{file:c=1,inside:h=1}=e.artifact.portal;!b.int(c)&&ce(c)||(b.int(c)||b.str(c))&&(c=b.int(c)?"portal-".concat(c):c,c="".concat(m.GLB_URL,"/portals/").concat(c,".glb")),o.push(["glb",e.promisifiedLoad({loader:e.gltfLoader,file:c})])}var u=yield Promise.all(o.map(function(){var e=n((function*(e){var[t,a]=e;return[t,yield a]}));return function(t){return e.apply(this,arguments)}}()));return Object.fromEntries(u)}))()}loadVideo(t){var a=this;return n((function*(){var{dir:i,slug:n,video:r,id:o=pe}=t,s=!0===r?n:r,l=e.create("video",{id:o,class:Q,loop:!0,playsinline:!0,preload:"auto",crossorigin:"anonymous"});a.videoElement=l;var d=["webm","mp4"],c=b.str(s)?s:n,[h,u=""]=c.split("?"),p=h.endsWith("m3u8")||h.startsWith("blob:")||a.artifact.hlsVideo;if(p){if(""!==l.canPlayType("application/vnd.apple.mpegurl"))return l.src=h,e.append(l),l;var f=e.create("script",{src:"".concat(m.ROOT_URL,"/hls.js"),parent:m.B});return a.hlsScript=f,new Promise((t=>{e.on(f,"load",(()=>{Hls.isSupported()&&(a.hls=new m.Hls,a.hls.loadSource(h),e.append(l),a.hls.attachMedia(l),a.hls.once(Hls.Events.FRAG_LOADED,(()=>{t(l)})))}))}))}if(h.endsWith(".mp4")?(d=["mp4"],h=h.slice(0,-4)):h.endsWith(".webm")&&(d=["webm"],h=h.slice(0,-5)),ce(h)||(h=i?"video/".concat(i,"/").concat(h):"video/".concat(h,"/").concat(h),h="".concat(m.MEDIA_URL,"/").concat(h)),u||(u="v=".concat(fe)),d.forEach((t=>{e.create("source",{src:"".concat(h,".").concat(t,"?").concat(u),type:"video/".concat(t),parent:l})})),e.append(l),!p){var{videoWidth:v}=l;return v>0?l:new Promise((t=>{if(he){var a=e=>{l.videoWidth>0?e(l):setTimeout((()=>a(e)),50)};a(t)}else e.on(l,"canplaythrough",(e=>t(e.target)))}))}}))()}onVideoCanPlayThrough(e){var{e:t,resolve:a}=e;he?setTimeout((()=>{a(t.target)}),me):a(t.target)}loadAudioSourceRoot(e){var[t,a]=e.split("?"),i=["ogg","mp4","mp3"];t.endsWith(".mp3")?(i=["mp3"],t=t.slice(0,-4)):t.endsWith(".mp4")&&(i=["mp4"],t=t.slice(0,-4));var n=t.startsWith("http")?t:"".concat(m.MEDIA_URL,"/audio/").concat(t);return a||(a="v=".concat(fe)),{audioFileTypes:i,audioSourceRoot:n,request:a}}loadControls(){return n((function*(){var{Controls:e}=yield import("./Controls.js");return e}))()}loadOceanPlane(){return n((function*(){var{OceanPlane:e}=yield import("./vendor.js").then((function(e){return e.bw}));return e}))()}loadWaterNormals(){var e=this;return n((function*(){var t,{normals:a="oceannormals1"}=null===(t=e.artifact)||void 0===t?void 0:t.ocean;return yield e.promisifiedLoad({loader:e.textureLoader,file:"https://static.artificialmuseum.com/textures/ocean/".concat(a,".jpg")})}))()}loadVideoTrigger(){return n((function*(){var{VideoTrigger:e}=yield import("./vendor.js").then((function(e){return e.bx}));return e}))()}loadUnderwaterPlane(){return n((function*(){var{UnderwaterPlane:e}=yield import("./vendor.js").then((function(e){return e.by}));return e}))()}loadAudioElements(){var t=this;return n((function*(){var{audioElements:a=[],slug:i}=t.artifact;if(t.artifact.audio){var{audio:r=t.artifact.slug}=t.artifact;!0===r&&(r=t.artifact.slug),a.push({autoplay:!0,audio:r})}return yield Promise.all(a.map(function(){var a=n((function*(a,r){var o=b.str(a.audio)?a.audio:i,s="".concat(ve,"-").concat(r);e.remove("#".concat(s));var l=e.create("audio",{class:Q,crossorigin:"anonymous","data-name":o,preload:"auto",id:s});!1!==a.loop&&(l.loop="true"),t.audioElements[r]={ele:l,config:a};var{audioSourceRoot:d,audioFileTypes:c,request:h}=t.loadAudioSourceRoot(o);c.forEach((t=>{var a=".".concat(t),i=d;i.endsWith(a)||(i+=a),e.create("source",{src:"".concat(i,"?").concat(h),type:"audio/".concat(t),parent:l})})),e.append(l);var{duration:m}=l;return b.num(m)&&m>0?{ele:l,config:a}:new Promise((t=>{if(he){var i=e=>{b.num(l.duration)&&l.duration>0?e({ele:l,config:a}):setTimeout((()=>i(e)),50)};i(t)}else e.on(l,"canplaythrough",function(){var e=n((function*(e){t({ele:e.target,config:a})}));return function(t){return e.apply(this,arguments)}}())}))}));return function(e,t){return a.apply(this,arguments)}}()))}))()}loadTextures(){var e=this;return n((function*(){var{textures:t={}}=e.artifact,{dir:a,names:i}=t,r="jpg";m.SUPPORTS.WEBP&&(r="webp"),a&&!a.endsWith("/")&&(a="".concat(a,"/"));var o={};return yield Promise.all(i.map(function(){var t=n((function*(t){var i=t;ce(a)||(i="https://static.artificialmuseum.com/textures/".concat(a,"/").concat(t)),i.endsWith(r)||(i="".concat(i,".").concat(r));var n=yield e.promisifiedLoad({loader:e.textureLoader,file:i});o[i]=n}));return function(e){return t.apply(this,arguments)}}())),o}))()}loadController(){var e=this;return n((function*(){if(e.artifact.pointerLockControls){var{ArmPointerLockControls:t}=yield import("./controls/ArmPointerLockControls.js");return t}var{ArmOrbitControls:a}=yield import("./controls/ArmOrbitControls.js");return a}))()}loadGltf(){var e=this;return n((function*(){var{artifact:t,XR:a}=e,{file:i,version:n=1}=t,r=a?"&xr=1":"",o=ce(i)?i:"".concat(m.GLB_URL,"/").concat(i,".glb?v=").concat(n).concat(r);return yield e.promisifiedLoad({loader:e.gltfLoader,file:o})}))()}loadPly(){var e=this;return n((function*(){var t,{artifact:a,XR:i}=e,{file:r,ply:o={},version:s=1}=a,l=i?"&xr=1":"",d=o.files;if(d&&!b.arr(d)&&(d=[d]),null!==(t=d)&&void 0!==t&&t.length)return yield Promise.all(d.map(function(){var t=n((function*(t){var a=t;if(a){ce(a)||(a="".concat(m.STATIC_URL,"/ply/").concat(a)),a.endsWith(".ply")||(a+=".ply"),a+="?v=".concat(s).concat(l);var i=yield e.promisifiedLoad({loader:e.plyLoader,file:a});return i.name=t.replace(".ply","").split("/").pop(),i}}));return function(e){return t.apply(this,arguments)}}()));var c="string"==typeof o?o:r;null!=o&&o.file&&(c=o.file);var h="?v=".concat(s).concat(l),u=c.endsWith(".ply")?c:"".concat(c,".ply");return ce(c)||(u="".concat(m.STATIC_URL,"/ply/").concat(u)),u+=h,yield e.promisifiedLoad({loader:e.plyLoader,file:u})}))()}loadGui(){var{title:t,button:a,body:i}=this.artifact.gui.afterSpawnModel,n=[];t&&n.push(e.create("h3",{innerText:t})),i&&n.push(e.create("div",{innerText:i})),n.length&&(a&&n.push(e.create("button",{id:"afterSpawnModelButton",class:"styled margin inverse",innerText:a,on:{click:e=>{var t=e.target.parentNode;t.parentNode.removeChild(t)}}})),this.gui={afterSpawnModel:e.create("div",{class:"w hudgui",children:n,parent:"#hud"})})}promisifiedLoad(e){var{loader:t,file:a}=e;return a.file&&(a=a.file),new Promise(((e,i)=>{t.load(a,(t=>{e(t)}),(()=>{}),(e=>{this.setError(e,"Error loading artifact.",5e3),i(e)}))}))}startEngine(){var t=this;return n((function*(){var{artifact:a,XR:i}=t,r=Object.entries(t.promises).map(function(){var e=n((function*(e){var[t,a]=e;return[t,yield a]}));return function(t){return e.apply(this,arguments)}}()),o=yield Promise.all(r);t.assets=Object.fromEntries(o);var s=new we({artifact:a,preload:t,XR:i}),l=yield s.init(t.assets.scene);if(!l)throw new Error("Session undefined.");e.hide(t._header),e.hide(t._preloadInfo),e.show(t._headerDone),t._session=l,t._timeoutShown&&t.isAndroidChrome?e.prop(t._confirmButton,{disabled:!1}):t._isCancelled||(yield t.finishLoad())}))()}showTimeoutWarning(){e.show(this._preloadInfo),this.isAndroidChrome&&(e.show(this._confirmButton),this._confirmButton.setAttribute("disabled",!0),this._timeoutShown=!0)}confirmButtonClickHandler(){var t=this;return n((function*(){t._session&&(e.off(t._confirmButton,"click",t.confirmButtonClickHandler),yield t.finishLoad(),t.finished())}))()}finishLoad(){var t=this;return n((function*(){if(t._session){var{hud:a,initFallbackSession:i,initScene:n}=t._session;try{yield n(),a.show(),e.show("#".concat(v)),t.finished()}catch(n){"InvalidStateError"===n.name||"NotSupportedError"===n.name?(yield i(),a.show(),e.show("#".concat(v)),t.finished()):"SecurityError"===n.name&&(e.show(t._confirmButton),e.prop(t._confirmButton,{disabled:!1}))}}}))()}setError(e,t){m.clearTimeout(this.timeout),this.finished()}showTooFarNotification(t){var{distance:a,artifact:i,map:n}=t,r="meter",o=a;o>=1e3?(r="kilometer",o>=2e3&&(r+="s"),o=Math.round(o/1e3)):o>=2&&(r+="s"),this.artifact=i,this.map=n,this.XR=!1,this._tooFarDistanceInfo.innerText="This artifact is ".concat(o," ").concat(r," away."),e.show(this._tooFarContainer),e.on(this._tooFarPreviewButton,"click",this.onTooFarPreviewButtonClick),e.on(this._tooFarCancelButton,"click",this.onTooFarCancelButtonClick),e.on(this._tooFarAbortButton,"click",this.onTooFarCancelButtonClick)}onTooFarCancelButtonClick(){e.off(this._tooFarPreviewButton,"click",this.onTooFarPreviewButtonClick),this._isCancelled=!0,e.hide(this._tooFarContainer),this.finished()}onTooFarPreviewButtonClick(){var t=this;return n((function*(){e.off(t._tooFarPreviewButton,"click",t.onTooFarPreviewButtonClick),e.off(t._tooFarCancelButton,"click",t.onTooFarCancelButtonClick),e.off(t._tooFarAbortButton,"click",t.onTooFarCancelButtonClick),e.hide(t._tooFarContainer),yield t.init()}))()}showWebglDisabledNotification(){e.show(this._webglDisabledContainer),e.hide([this._header,this._headerDone,this._preloadInfo,this._cancelButton,this._confirmButton]),e.on(this._webglDisabledOkButton,"click",this.onWebglDisabledOkButtonClick)}onWebglDisabledOkButtonClick(){e.off(this._webglDisabledOkButton,"click",this.onWebglDisabledOkButtonClick),this._isCancelled=!0,e.hide(this._webglDisabledContainer),this.finished()}finished(){this._isWorking=!1,this._timeoutShown=!1,e(".start-experience-button").forEach((e=>{e.removeAttribute("disabled")})),e.hide([this._warningContainer,this._confirmButton,this._preloadInfo,this._headerDone]),e.prop(this._confirmButton,{disabled:!0}),e.show(this._header),m.clearTimeout(this.timeout)}}export{Te as Preload};
