import{$ as e,az as t,aA as a,aB as i,c as n,aC as r,W as o,aD as s,aE as l,al as d,aF as c,aG as h,aH as u,aI as m,aJ as p,aK as f,aL as v,aM as g,aN as y,a6 as b,a as w,v as T,aO as S,aP as E,x as C,aQ as x,C as k,_ as P,ac as j,D as A,A as _,aR as L,w as O,aS as R,a2 as B,y as F,aT as I,aU as W,ag as D,a4 as H,aV as N,H as U,aW as X,af as z,ae as V,ad as q,a5 as G,V as K,aX as Y,aY as Z,aZ as $,a_ as J,a$ as Q,K as ee,b0 as te,b1 as ae,a3 as ie,b2 as ne,b3 as re,b4 as oe,b5 as se,b6 as le,b7 as de,r as ce,b8 as he,b9 as ue}from"./vendor.js";class me{constructor(n){var{scene:r,sceneInstance:o,renderer:s,endSession:l}=n;this.endSession=l,this.engine=n,this.gui=e("#".concat(t)),this.hitSearch=e("#hud-searching-hittest"),this.scene=r,this.renderer=s,this.sceneInstance=o,e.on("#".concat(a),"click",this.onExitButtonClick.bind(this)),i(this),this.animToggler=e("#toggle-animation-button")}setCamera(t){this.cameraAccess=t,t?e.show(this.recordVideoButton):e.hide(this.recordVideoButton)}showAnimToggler(t){this.animToggler&&(this.animToggler.classList.remove("play"),e.show(this.animToggler),this.animTogglerInit||(this.animTogglerInit=!0,this.eventListener=()=>{this.animToggler.classList.toggle("play"),t()},e.on(this.animToggler,"click",this.eventListener)))}hideAnimToggler(){e.hide(this.animToggler)}show(){e.show(this.gui)}hide(){e.hide(this.gui)}onExitButtonClick(){var t=this;return n((function*(){t.engine.endSession(),e.off(t.animToggler,"click",t.eventListener),r()}))()}showHitSearch(){e.show(this.hitSearch)}hideHitSearch(){e.hide(this.hitSearch)}showElement(t){t.shown||(e.show(t),t.shown=!0)}hideElement(t){t.shown&&(e.hide(t),t.shown=!1)}}var pe=o.APP_DB.SCENE_TYPES;class fe{constructor(e){var{artifact:t,preload:a,XR:i}=e;this.XR=i,this.artifact=t,this.preload=a;var{type:n=pe.Hit}=t;this.type=n,this.clock=new s,this.scene=new l,this.customMaterials=[],this.spatialObjects=[],this.lookAtCameraObjects=[],this.animateObjects=[],this.audioAnalysers=[],this.audioAnalyserEmissionConfigs=[],this.circlingLights=[],this.customObjects=[],this.videoTargets=[],this.audioRamps={},this.animationListeners=[],this.materialFadeAnimations=[],this.eventsToRemove=[],this.renderSteps=[],this.unspawnObjects=[],this.animations=[],this.onResize=this.onResize.bind(this),this.render=this.render.bind(this),this.initFallbackSession=this.initFallbackSession.bind(this),this.toggleAnimations=this.toggleAnimations.bind(this),this.endSession=this.endSession.bind(this)}init(t){var a=this;return n((function*(){var i,{artifact:r,preload:s,scene:l,type:g,XR:y}=a;t&&(a.sceneInstance=t);var{fov:b,near:w,far:T}=d(r.cam,c),S=o.innerWidth/o.innerHeight;a.camera=new h(b,S,w,T),a.camera.updateProjectionMatrix(),l.add(a.camera);var E=new u({antialias:!0,alpha:!0});a.renderer=E,E.setPixelRatio(o.devicePixelRatio),E.setSize(o.innerWidth,o.innerHeight),E.domElement.id=m,E.useLegacyLights=!1,E.outputEncoding=p,E.toneMappingExposure=.5;var{audio:C,circlingLights:x,clickables:k,customMaterials:P,customObjects:j,fog:A,fogexp2:_,hideLight:L,ocean:O,particles:R,shadow:M,spatialAudio:B,triggerVideo:F,underwater:I,wireframes:W,renderTargets:D}=r;!1!==M&&(E.shadowMap.enabled=!0,E.shadowMap.type=f),a.hud=new me(a);var H=null===(i=a.artifact.animateObjects)||void 0===i?void 0:i.some((e=>e.sound));if((C||B||H)&&a.addAudio(),a.addSkybox(),L||a.addLights(),(A||_)&&a.addFog(),a.videoElement=s.assets.videoElement,null!=t&&t.init&&(yield t.init({engine:a,preload:s})),null!=t&&t.beforeLoadModel&&t.beforeLoadModel({engine:a,preload:s}),yield a.loadModel(),null!=t&&t.afterLoadModel&&t.afterLoadModel({engine:a,preload:s}),D&&a.addRenderTargets(),null!=x&&x.length){var{CirclingLights:N}=yield import("./vendor.js").then((function(e){return e.bc})),U=new N(a);a.renderSteps.push(U.render.bind(U))}if(P){var{addCustomMaterials:X,renderCustomMaterials:z}=yield import("./vendor.js").then((function(e){return e.bd}));yield X(a),a.renderSteps.push(z)}if(j&&(yield a.addCustomObjects()),W&&W.forEach((e=>{var t=a.model.getObjectByName(e.target);t&&t.material&&(t.material.wireframe=!0,e.transparent&&(t.material.transparent=!0,t.material.opacity=e.opacity))})),F){var{addVideoTrigger:V,renderVideoTrigger:q}=yield import("./vendor.js").then((function(e){return e.be}));V(a),a.renderSteps.push(q)}if(I&&(yield a.underwaterPlane()),O){var{OceanPlane:G}=yield import("./vendor.js").then((function(e){return e.bf})),K=new G(a);yield K.init(a),a.renderSteps.push(K.render)}if(R){var{Particles:Y}=yield import("./vendor.js").then((function(e){return e.bg}));a.particles=new Y(a),yield a.particles.init()}if(E.setSize(o.innerWidth,o.innerHeight),e.append(E.domElement,"#".concat(v)),y)try{var Z=E.xr.getController(0);a.controller=Z;var{clickable:$,shadow:J,shadowPlane:Q}=r;if(!1!==J&&!1!==Q&&a.addShadowPlane(),!a.isHittestScene())throw new Error("Unknown scene type ".concat(g));g!==pe.Float&&a.spawnReticle(),e.on(Z,"select",(()=>{if(!a.justUnspawned){a.spawnModel(!1),$?a.hud.showAnimToggler(a.toggleAnimations):a.hud.hideAnimToggler()}})),$||a.hud.hideAnimToggler(),l.add(Z),a.initScene=n((function*(){e.hide("#Locator");var t=yield o.NAV.xr.requestSession("immersive-ar",{requiredFeatures:["hit-test","dom-overlay"],domOverlay:{root:e("#hud")}});return a.refSpace=yield t.requestReferenceSpace("viewer"),a.renderer.xr.enabled=!0,a.renderer.xr.setReferenceSpaceType("local"),yield a.renderer.xr.setSession(t),t.initFallbackSession=a.initFallbackSession.bind(a),a.session=t,t}))}catch(e){a.initScene=a.initFallbackSession}else a.initScene=a.initFallbackSession;return null!=k&&k.length&&(yield a.addClickables()),e.on(o,"resize",a.onResize),a.onResize(),E.setAnimationLoop(a.render),a}))()}onResize(){var{innerWidth:e,innerHeight:t}=o;this.camera.aspect=e/t,this.camera.updateProjectionMatrix(),this.renderer.setSize(e,t)}addRenderTargets(){var{renderTargets:e}=this.artifact;this.renderTargets=[],e.forEach((e=>{var t=d(e,{height:512,width:512,options:{depthBuffer:!1,stencilBuffer:!1},off:[]}),a=[];t.off.length&&t.off.forEach((e=>{var t=this.model.getObjectByName(e);t&&a.push(t)})),this.renderTargets.push({height:t.height,width:t.width,off:a,object:new g(t.width,t.height,t.options)})}))}addLights(){var{directionalLightPosition:e=$.directionalPosition,directionalColor:t=$.directionalColor,directionalIntensity:a=$.directionalIntensity,ambientColor:i=$.ambientColor,ambientIntensity:n=$.ambientIntensity}=this.artifact,r=new y(t,a);r.position.set(...e),r.castShadow=!0,!1!==this.artifact.shadow&&(r.shadow.bias=-1e-4,r.shadow.mapSize.width=512,r.shadow.mapSize.height=512,r.shadow.camera.near=.1,r.shadow.camera.far=300),this.directionalLight=r,this.scene.add(r),this.ambientLight=new b(i,n),this.scene.add(this.ambientLight)}addCustomObjects(){var{artifact:e}=this,{customObjects:t}=e;t.forEach((e=>{var{config:t,object:a}=e,i=this.model.getObjectByName(t.target);i&&(a.child?i.add(a.child):a.model&&(i.parent.add(a.model),i.parent.remove(i)),this.customObjects.push({config:t,object:a}),w.fn(a.init)&&a.init({engine:this}))}))}addShadowPlane(){var e=new T(150,150,64,64),t=new S;t.opacity=E;var a=new C(e,t);a.receiveShadow=!0,a.lookAt(0,100,0),a.position.set(0,.01,0),this.shadowPlane=a}addPortal(){var{Portal:e}=this.preload.assets.examples,t=new e({engine:this,mergeConfig:d});this.renderSteps.push(t.render)}spawnReticle(){var e=new x(.15,.2,32).rotateX(-M.PI/2),t=new k;this.reticle=new C(e,t),this.reticle.matrixAutoUpdate=!1,this.reticle.visible=!1,this.scene.add(this.reticle)}onAnimationLoop(e,t){var a=e.action._clip.name;t.forEach((e=>{if(!this.materialFadeAnimations.includes((e=>e.action._clip.name===a))){var t=this.findEventTargets(e);this.materialFadeAnimations.push(P(P({},e),{},{targets:t}))}}))}onAnimationFinished(e,t){var a=e.action._clip.name;t.forEach((e=>{if(!this.materialFadeAnimations.includes((e=>e.action._clip.name===a))){var t=this.findEventTargets(e);this.materialFadeAnimations.push(P(P({},e),{},{targets:t}))}}))}glow(){var{glow:e}=this.artifact;this.model.traverse((t=>{if(j(t.name,"glow")){var a=w.bool(e)?238:e,i=new k({color:a,side:A,blending:_,transparent:!0});t.material=i}}))}addClickables(){var t=this;return n((function*(){var{artifact:a,controller:i,model:n,preload:r,renderer:o,XR:s}=t,{clickables:l=[]}=a,d=[];if(!0===l?d.push(n):l.length&&n.traverse((e=>{l.forEach((t=>{if(w.str(t)&&(t={target:t}),L({node:e,search:t.target})){var a;t.node=e,t.hide&&(e.material.transparent=!0,e.material.opacity=0);var i=!0===t.audio?e.name:t.audio;null!==(a=r.assets.audioElements)&&void 0!==a&&a.length&&(t.player=r.assets.audioElements.find((e=>{var{ele:t}=e;return t.dataset.name===i}))),d.includes(t)||d.push(t)}}))})),d.length){var{Controls:c}=yield import("./Controls.js");t.controls=new c({clickables:d,engine:t}),s?e.on(i,"select",t.controls.select,!1):e.on(o.domElement,"mousedown",t.controls.click,!1)}}))()}onTouch(t){var a=this;return n((function*(){var i;null!==(i=a.sceneInstance)&&void 0!==i&&i.onTouch&&(yield a.sceneInstance.onTouch(t)),t.forEach(((t,i)=>{if(!(i+1>a.artifact.maxTouches)){var{emission:n,emissionIntensity:r=.2,link:o,player:s}=t;if(o&&(O?window.location.href=o:window.open(o,"_hacked")),s&&(s.loop?s.paused?s.play():(s.currentTime=0,s.pause()):(s.currentTime=0,s.play())),n){var l=t.node.name.split("_")[0],d=a.model.getObjectByName(l);if(!d)return;("Group"===d.type?d.children:[d]).forEach((t=>{if(t&&(t.userData.origEmissive||(t.userData.origEmissive=t.material.emissive),t.userData.origEmissiveIntensity||(t.userData.origEmissiveIntensity=t.material.emissiveIntensity),s))if(R.same(t.material.emissive,t.userData.origEmissive)){var a=new B(1,1,1);w.bool(n)?t.material.color&&(a=t.material.color):w.arr(n)&&(a=new B(...n)),t.material.emissive=a,t.material.emissiveIntensity=r,s.loop||e.on(s,"ended",(()=>{t.material.emissive=t.userData.origEmissive,t.material.emissiveIntensity=t.userData.origEmissiveIntensity}))}else s.loop&&(t.material.emissive=t.userData.origEmissive,t.material.emissiveIntensity=t.userData.origEmissiveIntensity)}))}}}))}))()}nosort(){this.renderer.sortObjects=!1}clip(){var{artifact:e,model:t}=this,{clipSide:a,clipInFallback:i}=e;t.traverse((e=>{if(j(e.name,"clip"))if(this.XR||!1!==i){var{side:t}=e.material;e.material=new k({color:"green",colorWrite:!1,side:t}),e.castShadow=!1,e.receiveShadow=!1,e.renderOrder=1}else e.visible=!1;else e.renderOrder=2}))}underwaterPlane(){var e=this;return n((function*(){var{UnderwaterPlane:t}=yield import("./vendor.js").then((function(e){return e.bh}));e.cameraPlane=new t,yield e.cameraPlane.preload(e)}))()}addSkybox(){var e=this;return n((function*(){var{artifact:t,preload:a,renderer:i,scene:n,XR:r}=e,o=J,s=null==t?void 0:t.skySphere;w.arr(s)&&s.length&&(o=s);var l=new F(...o),d=a.assets.skybox,c=new I(i);c.compileEquirectangularShader();var h=c.fromEquirectangular(d).texture;c.dispose();var u=new k({map:d,side:W}),m=new C(l,u);m.rotation.y=D.degToRad(180),m.visible=!r,n.add(m),!1===t.light||t.hideEnvironment||(n.environment=h),e.skybox=m}))()}addAudio(){this.listener=new H,this.camera.add(this.listener)}addFog(){var{artifact:e,scene:t}=this,{fog:a,fogexp2:i}=e;if(a){var{color:n,near:r,far:o}=a;t.fog=new N(n,r,o)}if(i){var{color:s,density:l}=i;t.fog=new U(s,l)}}startMedia(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];if(!this.isMediaPlaying){var{actions:t=[],artifact:a,preload:i}=this,{audioElement:n,videoElement:r,audioElements:o=[]}=i.assets;a.triggerAudio||(n&&(e&&(n.currentTime=0),n.play()),null!=o&&o.length&&o.forEach((t=>{var{config:a,ele:i}=t;a.autoplay&&(e&&(i.currentTime=0),i.play())}))),r&&!a.triggerVideo&&(e&&(r.currentTime=0),r.play()),t.forEach((e=>e.play())),this.isMediaPlaying=!0}}stopMedia(){var{audioElement:e,preload:t,videoElement:a,actions:i=[],audioElements:n=[]}=this;e&&e.pause(),a&&a.pause(),t.hls&&t.hls.destroy(),i&&i.length&&i.forEach((e=>e.stop())),n.forEach((e=>{var{ele:t}=e;return t.pause()})),this.isMediaPlaying=!1}toggleAnimations(){this.actions.forEach((e=>e.paused=!e.paused))}initFallbackSession(){var e=this;return n((function*(){var t;e.XR=!1,o.B.classList.add(X);var{camera:a,artifact:i,model:n,renderer:r}=e,{clickable:s}=i,{Controller:l}=e.preload.assets;e.controller=new l(a,r.domElement,i),e.controller.unspawn&&e.unspawnObjects.push(e.controller),e.skybox.visible=!0,s?e.hud.showAnimToggler(e.toggleAnimations):e.hud.hideAnimToggler();var{cam:d={}}=i,c=Q,{x:h=c.x,y:u=c.y,z:m=c.z}=d;a.position.set(h,u,m);var{scale:p}=i;if(p&&n){var{x:f,y:v,z:g}=n.scale;w.num(p)&&n.scale.set(f*p,v*p,g*p)}null===(t=e.controller)||void 0===t||t.update();e.spawnModel(!0),r.domElement.focus()}))()}loadModel(){var t=this;return n((function*(){var a,i,n,r,o,s,l,{artifact:d,preload:c,sceneInstance:h={}}=t,{spatialObjects:u=[],audioElements:m=[]}=d;(t.spatials=[...u,...m],null!=h&&h.model&&(t.model&&t.model!==h.model?t.model.add(h.model):t.model=h.model),null!==(a=c.assets.gltf)&&void 0!==a&&a.scene)&&(t.model?t.model.add(null===(s=c.assets.gltf)||void 0===s?void 0:s.scene):t.model=null===(l=c.assets.gltf)||void 0===l?void 0:l.scene);if(d.ply&&c.assets.addPly(t),null!=h&&null!==(i=h.animations)&&void 0!==i&&i.length&&t.animations.push(...h.animations),null!==(n=c.assets.gltf)&&void 0!==n&&null!==(r=n.animations)&&void 0!==r&&r.length&&t.animations.push(...c.assets.gltf.animations),t.actions=[],null!==(o=t.animations)&&void 0!==o&&o.length){var f;t.mixer=new z(t.model);var{animations:v={}}=d,{loop:g,startOnTouch:y,clampWhenFinished:b=!0,autoplay:w=!0,noLoopAnimations:T=[],pausedAnimations:S=[]}=v;if(t.animations.forEach((e=>{var a=t.mixer.clipAction(e),i=S.includes(e.name),n=y||!w||i;(!1===g||T.includes(e.name))&&(a.clampWhenFinished=b,a.loop=V),n&&(a.paused=!0),t.actions.push(a)})),null!==(f=t.artifact.events)&&void 0!==f&&f.animation){var{events:E}=t.artifact,{times:C=[],loop:x=[],finished:k=[]}=null==E?void 0:E.animation;if(x.length){var A=[t.mixer,"loop",e=>t.onAnimationLoop(e,x)];e.on(...A),A.targets=t.findEventTargets(x),t.eventsToRemove.push(A)}if(k.length){var _=[t.mixer,"finished",e=>t.onAnimationFinished(e,k)];e.on(..._),_.targets=t.findEventTargets(k),t.eventsToRemove.push(_)}if(C.length){var{times:L}=t.artifact.events.animation;L.length&&L.forEach((e=>{var{action:a,once:i=!1,targets:n}=e,r=q.findByName(t.animations,a),o=t.findEventTargets(e);t.animationListeners.push(P(P({},e),{},{once:i,action:r,targets:o}))}))}}}if(t.model){var O,R,M={};if(h.parentName&&h.child&&(R=t.model.getObjectByName(h.parentName)),t.model.traverse((e=>{if(t.customObjects.forEach((t=>{var{object:a}=t;a.parentName&&a.child&&j(e.name,a.parentName)&&(M[a.name]=e)})),e.isMesh){var{frustumCulled:a,transparent:i,castShadow:n,receiveShadow:r,noShadowObjects:o=[],noShadowCastObjects:s=[],noShadowReceiveObjects:l=[]}=d;(!1===a||null!=a&&a.includes(e.name))&&(e.frustumCulled=!1),!1===i&&(e.material.transparent=!1),j(e.name,"noshadow")||o.includes(e.name)||(j(e.name,"noshadowcast")||s.includes(e.name)||(e.castShadow=!1!==n),j(e.name,"noshadowreceive")||l.includes(e.name)||(e.receiveShadow=!1!==r)),j(e.name,"videotarget")&&t.videoTargets.push(e),e.material.map&&(e.material.map.anisotropy=16,e.material.map.encoding=p),e.material.emissiveMap&&(e.material.emissiveMap.encoding=p),(e.material.map||e.material.emissiveMap)&&(e.material.needsUpdate=!0)}var c=[];d.animateObjects&&d.animateObjects.forEach((a=>{if(j(e.name,a.name)){var i=q.findByName(t.animations,e.name);if(a.sound){!0===a.sound&&(a.sound={name:t.artifact.slug}),a.sound.name||(a.sound.name=t.artifact.slug);var n=t.preload.assets.animateObjects[a.sound.name];if(n){var r=new G(t.listener);r.setBuffer(n);var{loopSound:o=!0}=a;if(r.setLoop(o),a.audio=r,a.sound.distance){var s=!1!==a.sound.yDistanceTest;c.push({buffer:r,distance:a.sound.distance,distanceTarget:e.name,target:e.name,yDistanceTest:s})}}}t.animateObjects.push(P(P({},a),{},{action:i,node:e}))}})),t.spatials=[...t.spatials,...c]})),t.spatials.length){var{SpatialObjects:B}=yield import("./vendor.js").then((function(e){return e.bi})),F=new B(t);t.renderSteps.push(F.render.bind(F))}if(null!==(O=d.lookAtCameraObjects)&&void 0!==O&&O.length){var I=new c.assets.LookAtCamera(t);t.renderSteps.push(I.render.bind(I))}if(R&&R.add(h.child),t.customObjects.forEach((e=>{var{object:a}=e;a.child?M[a.name].add(a.child):a.model&&t.model.add(a.model)})),t.videoElement&&t.videoTargets.length){var W,{flipVideo:D,chromaKey:H}=d,N=new K(t.videoElement);!1!==D&&(N.flipY=!1);var{examples:U={}}=null===(W=t.preload)||void 0===W?void 0:W.assets,{ChromaKeyMaterial:X=!1}=U;t.videoTargets.forEach((e=>{H&&X?e.material=new X(H,N):e.material.map=N}))}}var{clip:Y,glow:Z,mirrors:$,portal:J,nosort:Q,clones:ee}=t.artifact;if(Z&&t.glow(),J&&t.addPortal(),t.model&&Y&&t.clip(),Q&&t.nosort(),null!=$&&$.length){var{mirror:te}=yield import("./vendor.js").then((function(e){return e.bj}));te(t)}if(t.artifact.analyseAudio){var{AnalyseAudio:ae}=yield import("./vendor.js").then((function(e){return e.bk})),ie=new ae(t);t.renderSteps.push(ie.render)}if(t.model)if(ee){var{Clones:ne}=yield import("./vendor.js").then((function(e){return e.bl}));t.clones=new ne(t),t.renderSteps.push(t.clones.render.bind(t.clones))}else t.model.position.set(5e3,5e3,5e3),t.scene.add(t.model)}))()}findEventTargets(e){var t=[];return this.model.traverse((a=>{L({node:a,search:e.targets})&&(a.material&&(t.includes(a.material)||t.push(a.material)))})),t}spawnModel(e){var t,{artifact:a,camera:i,controller:n,model:r,reticle:o,scene:s,sceneInstance:l={},shadowPlane:d,type:c,XR:h}=this,{showSkybox:u,floatSpawnAtZeroY:m=!1}=a;if(!h||e)r&&(this.clones||r.position.set(0,0,0)),this.modelSpawned=!0;else if(this.isHittestScene()){if(!this.modelSpawned&&this.lastHit){o.updateMatrixWorld(),r.position.setFromMatrixPosition(o.matrixWorld),r.updateMatrixWorld();var p=i.position,f=r.position,v=p.x-f.x,g=p.z-f.z,y=Math.atan2(v,g);r.rotation.y=y,d&&(d.position.setFromMatrixPosition(o.matrixWorld),s.add(d)),this.clones||(r.visible=!0),o.visible=!1,this.modelSpawned=!0}}else if(c===pe.Float){var b=r.clone();b.position.set(0,0,-1).applyMatrix4(n.matrixWorld),m&&(b.position.y=0),s.add(b)}if(this.applyPositionAndRotation(),null!=l&&l.spawnModel&&l.spawnModel({engine:this}),null!=l&&l.afterSpawnModel&&l.afterSpawnModel({engine:this}),this.startMedia(),u&&(this.skybox.visible=!0),null!==(t=this.preload.gui)&&void 0!==t&&t.afterSpawnModel){var{afterSpawnModel:T}=this.preload.gui;T.style.visibility="visible",T.style.opacity=1,setTimeout((()=>{var e;w.fn(null===(e=T.parentNode)||void 0===e?void 0:e.removeChild)&&T.parentNode.removeChild(T)}),8e3)}}unspawnModel(){var t;this.modelSpawned&&(this.scene.remove(this.model),this.modelSpawned=!1,this.isAnimationRunning=!1,this.stopMedia(),this.exitSceneInstance(),this.justUnspawned=!0,null!==(t=this.eventsToRemove)&&void 0!==t&&t.length&&this.eventsToRemove.forEach((t=>{e.off(...t)})),this.unspawnObjects.forEach((e=>{null==e||e.unspawn(this)})),setTimeout((()=>{this.justUnspawned=!1}),200))}exitSceneInstance(){var e;this.customObjects.forEach((e=>{var{object:t}=e;w.fn(t.exit)&&t.exit({engine:this})})),this.customMaterials.forEach((e=>{var{material:t}=e;w.fn(t.exit)&&t.exit({engine:this})})),this.animateObjects.forEach((e=>{var t;null===(t=e.audio)||void 0===t||t.stop()})),null!==(e=this.sceneInstance)&&void 0!==e&&e.exit&&this.sceneInstance.exit({engine:this})}applyPositionAndRotation(){var{artifact:e,model:t}=this;if(t){var{pos:a={},rot:i={}}=e,{x:n,y:r,z:o}=a;n&&(t.position.x+=n),r&&(t.position.y+=r),o&&(t.position.z+=o);var{x:s,y:l,z:d}=i,c=D.degToRad;s&&t.rotateX(c(s)),l&&t.rotateY(c(l)),d&&t.rotateZ(c(d))}}endSession(){var t,a;null===(t=this.session)||void 0===t||t.end(),this.hud.hide(),this.renderer.setAnimationLoop(null),e("#".concat(v)).classList.remove("visible"),this.exitSceneInstance(),this.scene&&Y(this.scene),e.remove(".".concat(Z)),null!==(a=this.preload)&&void 0!==a&&a.hls&&(this.preload.hls.destroy(),e.remove(this.preload.hlsScript));var i=e("#".concat(m));if(i){var n=i.parentNode;n.id===v?e.remove(i):e.remove(n)}o.B.classList.remove(X),e(".start-experience-button").forEach((e=>{e.removeAttribute("disabled")})),O&&o.location.reload()}isHittestScene(){return![pe.Float].includes(this.type)}render(e,t){var a=this;return n((function*(){var i,n,r,o,s,l=a.clock.getDelta();a.renderHittest(t),a.mixer&&a.mixer.update(l);var d={delta:l,timestamp:e,engine:a,frame:t};a.modelSpawned&&a.renderSteps.forEach((e=>{e(d)})),null!==(i=a.sceneInstance)&&void 0!==i&&i.tick&&a.sceneInstance.tick(d),null!==(n=a.artifact.ply)&&void 0!==n&&n.animated&&a.renderPlyMorphTargetInfluences(d),null!==(r=a.animateObjects)&&void 0!==r&&r.length&&a.renderAnimateObjects(d),a.cameraPlane&&a.renderUnderwater(d),null!==(o=a.animationListeners)&&void 0!==o&&o.length&&a.renderAnimationTimeEvent(d),a.materialFadeAnimations.length&&a.renderMaterialAnimTick(d),a.particles&&a.particles.update(d),a.customObjects.length&&a.renderCustomObjects(d),null!==(s=a.sceneInstance)&&void 0!==s&&s.render?a.sceneInstance.render(d):a.renderer.render(a.scene,a.camera),a.controller&&(a.controller.update&&a.controller.update(l),a.controller.render&&a.controller.render(l))}))()}renderRenderTargets(e){var{renderTargets:t}=this;t.forEach((e=>{e.off.length&&e.off.forEach((e=>{e.visible=!1})),this.renderer.setRenderTarget(e.object),this.renderer.render(scene,camera),this.renderer.setRenderTarget(null),e.off.length&&e.off.forEach((e=>{e.visible=!0}))}))}renderPlyMorphTargetInfluences(e){var{delta:t,timestamp:a}=e;this.nextMorphTargetStep||(this.nextMorphTargetStep=a+this.morphTargetInfluenceConfig.delay);var i=this.animatedPoints,n=i.morphTargetInfluences.length-1,r=t*this.morphTargetInfluenceConfig.speed;i.morphTargetInfluences=i.morphTargetInfluences.map(((e,t)=>{if(t===this.morphTargetTargetIndex){var i=Math.min(e+r,1);return i>=1&&a>this.nextMorphTargetStep&&(this.nextMorphTargetStep=a+this.morphTargetInfluenceConfig.delay,this.hasRun=!this.hasRun,this.hasRun||(this.morphTargetTargetIndex+=1,this.morphTargetTargetIndex>n&&(this.morphTargetTargetIndex=0))),i}return Math.max(e-r,0)}))}renderCustomObjects(e){this.customObjects.forEach((t=>{var{object:a}=t;w.fn(a.tick)&&a.tick(e)}))}renderAnimateObjects(e){var{timestamp:t}=e;this.animateObjects.forEach((e=>{var{action:a,audio:i,speed:n,minSpeed:r=0,maxDelay:o=2,minDelay:s=1}=e;if(a&&a.paused&&(e.nextAnimation||(e.nextAnimation=t+Math.random()*(1e3*o)+1e3*s),i.isPlaying&&i.stop(),e.nextAnimation<=t)){e.nextAnimation=!1;var l=Math.random()>.5?1:-1,d=Math.max(r,Math.random()*n)*l;a.timeScale=d,a.paused=!1,a.play(),i&&!i.isPlaying&&i.play()}}))}renderHittest(t){var a=this;return n((function*(){if(t&&a.XR){var i=a.renderer.xr.getSession();a.hitTestSourceRequested||(a.hitTestSource=yield i.requestHitTestSource({space:a.refSpace}),e.on(i,"end",(()=>{a.hitTestSourceRequested=!1,a.hitTestSource=null})),a.hitTestSourceRequested=!0);var n=t.getHitTestResults(a.hitTestSource);if(n.length){if(a.lastHit=n[0],!a.modelSpawned){a.reticle.visible=!0;var r=a.renderer.xr.getReferenceSpace();a.reticle.matrix.fromArray(a.lastHit.getPose(r).transform.matrix)}a.hud.hideHitSearch()}else a.reticle.visible=!1,a.modelSpawned||a.hud.showHitSearch(),a.lastHit=void 0}}))()}renderAnimationTimeEvent(){this.animationListeners.forEach((e=>{var{time:t,action:a,once:i}=e,{time:n}=a;!e.hasTriggered&&n>=t?(e.hasTriggered=!0,this.materialFadeAnimations.push(e)):n<=t&&(i||(e.hasTriggered=!1))}))}renderMaterialAnimTick(e){var{delta:t}=e;this.materialFadeAnimations.forEach(((e,a)=>{if(e){var{targets:i=[],speed:n=1,to:r=0,props:o}=e;i.forEach((e=>{var i=w.arr(o)?o:[o],s=!0;i.map((a=>{var i=e[a]+n*t;n<0?i<=r?i=r:s=!1:n>0&&(i>=r?i=r:s=!1),e[a]=i})),s&&this.materialFadeAnimations.splice(a,1)}))}}))}renderUnderwater(e){var{delta:t}=e;this.cameraPlane.tick(t)}}var ve=(e,t)=>w.arr(t)||w.str(t)?t.includes(e)||t===e:null==t?void 0:t.hasOwnProperty(e),ge=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return w.str(t)?t+=" ".concat(e):w.arr(t)?t.push(e):w.obj(t)&&(t[e]=!0),t};class ye{constructor(t){var{artifact:a,root:i,THREE:n}=t;this.artifact=a,this.root=i,n&&(this.THREE=n);var{android:r,chrome:o}=ce;this.isAndroidChrome=r&&o,this._warningContainer=e("#timeout-warning"),this._header=e("#timeout-warning-header"),this._headerDone=e("#timeout-warning-header-done"),this._preloadInfo=e("#timeout-warning-info"),this._cancelButton=e("#timeout-warning-cancel"),this._confirmButton=e("#timeout-warning-confirm"),this._tooFarContainer=e("#toofar-warning"),this._tooFarPreviewButton=e("#toofar-warning-load-preview-button"),this._tooFarDistanceInfo=e("#toofar-warning-distance"),this._tooFarCancelButton=e("#toofar-warning-cancel-button"),this._tooFarAbortButton=e("#toofar-warning-abort-button"),this._webglDisabledContainer=e("#timeout-warning-webgl-disabled"),this._webglDisabledOkButton=e("#timeout-warning-webgl-disabled-ok-button"),this.confirmButtonClickHandler=this.confirmButtonClickHandler.bind(this),e.on(this._confirmButton,"click",this.confirmButtonClickHandler),this.onTooFarCancelButtonClick=this.onTooFarCancelButtonClick.bind(this),this.onTooFarPreviewButtonClick=this.onTooFarPreviewButtonClick.bind(this),this.onWebglDisabledOkButtonClick=this.onWebglDisabledOkButtonClick.bind(this),this.promisifiedLoad=this.promisifiedLoad.bind(this),this.textureLoader=new ee,this.gltfLoader=new te,this.plyLoader=new ae,this.audioLoader=new ie,this.fontLoader=new ne,this.audioElements=[],this.collectPreloadPromises(),this.startEngine=this.startEngine.bind(this),this.onVideoCanPlayThrough=this.onVideoCanPlayThrough.bind(this)}collectPreloadPromises(){var{animateObjects:e,audio:t,audioElements:a,chromaKey:i,customMaterials:n,customObjects:r,examples:o,fonts:s,glb:l,gui:d,ply:c,textures:h,type:u,video:m,lookAtCameraObjects:p,portal:f}=this.artifact,v={};if(v.skybox=this.loadSkybox(),(t||a)&&(v.audioElements=this.loadAudioElements()),re(u,APP_DB.SCENE_TYPES)||(v.scene=this.loadScene()),!1!==l&&(v.gltf=this.loadGltf()),c&&(v.ply=this.loadPly(),v.addPly=this.loadAddPly()),h&&(v.textures=this.loadTextures()),i&&(this.artifact.examples=ge("ChromaKeyMaterial",o)),f&&(v.portal=this.loadPortal(),this.artifact.examples=ge("Portal",o)),m){var{slug:g,video:y}=this.artifact;v.videoElement=this.loadVideo({slug:g,video:y})}null!=p&&p.length&&(v.LookAtCamera=this.loadLookAtCamera()),s&&(v.fonts=this.loadFonts()),this.artifact.examples&&(v.examples=this.loadExamples()),d&&this.loadGui(),n&&(v.customMaterials=this.loadCustomMaterials()),r&&(v.customObjects=this.loadCustomObjects()),e&&(v.animateObjects=this.loadAnimateObjects()),this.XR||(v.Controller=this.loadController()),this.promises=v}init(){var t=arguments,a=this;return n((function*(){var i=t.length>0&&void 0!==t[0]?t[0]:{},{map:n,XR:r}=i;a._isWorking=!0,a._isCancelled=!1,a._session=!1,a.map=n,a.XR=r,e.on(a._cancelButton,"click",(()=>{a._isCancelled=!0,a.finished()})),e.show([a._warningContainer,a._header]),a.timeout=o.setTimeout(a.showTimeoutWarning,oe)}))()}loadScene(){var t=this;return n((function*(){var{artifact:a}=t,i=APP_DB.SCENE_TYPES,{type:n=i.Hit}=a,r=Object.entries(i).find((e=>{var[t,a]=e;return a===n})),s="".concat(t.root,"/CustomScene.js");if(w.arr(r)){var l=r[0];s="./scenes/".concat(l,".js")}var{default:c}=yield import(s),h=new c({artifact:a,mergeConfig:d,nodeNameIncludes:j,nodeNameMatchesWildcard:L,preload:t,$:e,W:o,is:w});return w.fn(null==h?void 0:h.preload)?yield h.preload({artifact:a,preload:t}):w.fn(null==h?void 0:h.load)&&(yield h.load({artifact:a,preload:t})),h}))()}loadAddPly(){return n((function*(){var{addPly:e}=yield import("./vendor.js").then((function(e){return e.bm}));return e}))()}loadLookAtCamera(){return n((function*(){var{LookAtCamera:e}=yield import("./vendor.js").then((function(e){return e.bn}));return e}))()}loadSkybox(){var e=this;return n((function*(){var{city:t,sky:a,slug:i}=e.artifact,n=a||i,r=n;if(!r.startsWith("http")){var s="jpg";o.SUPPORTS.WEBP&&(s="webp"),n.startsWith("/")||n.startsWith("http")||(r=[o.STATIC_URL,"skybox",t,n].filter((e=>e)).join("/")),r.endsWith(".".concat(s))||(r+=".".concat(s))}return yield e.promisifiedLoad({loader:e.textureLoader,file:r})}))()}loadFonts(){var e=this;return n((function*(){var{fonts:t}=e.artifact,a={};return yield Promise.all(t.map(function(){var t=n((function*(t){var i="https://static.artificialmuseum.com/font/json/".concat(t,".typeface.json");a[t]=yield e.promisifiedLoad({loader:e.fontLoader,file:i})}));return function(e){return t.apply(this,arguments)}}())),a}))()}loadAnimateObjects(){var e=this;return n((function*(){var{animateObjects:t,slug:a}=e.artifact,i={},r=e.audioLoader;return yield Promise.all(t.map(function(){var t=n((function*(t){if(t.sound){var{sound:n={}}=t;if(!0===n&&(n={name:a}),n.name||(n.name=a),!i[n.name]){var s=".mp3";o.SUPPORTS.A_MP4?s=".mp4":o.SUPPORTS.A_OGG&&(s=".ogg");var l="https://media.artificialmuseum.com/audio/".concat(n.name).concat(s);i[n.name]=yield e.promisifiedLoad({loader:r,file:l})}}}));return function(e){return t.apply(this,arguments)}}())),i}))()}loadExamples(){var e=this;return n((function*(){var{examples:t}=e.artifact,a=[];ve("TextGeometry",t)&&a.push(["TextGeometry",import("./vendor.js").then((function(e){return e.bo}))]),ve("Record3D",t)&&a.push(["Record3D",import("./vendor.js").then((function(e){return e.bp}))]),ve("WS",t)&&a.push(["WS",import("./WS.js")]),ve("Portal",t)&&a.push(["Portal",import("./vendor.js").then((function(e){return e.bq}))]),ve("ChromaKeyMaterial",t)&&a.push(["ChromaKeyMaterial",import("./materials/ChromaKeyMaterial.js")]);var i=yield Promise.all(a.map(function(){var e=n((function*(e){var[t,a]=e,i=yield a;return[t,i[t]?i[t]:i.default]}));return function(t){return e.apply(this,arguments)}}()));return Object.fromEntries(i)}))()}loadCustomMaterials(){var e=this;return n((function*(){var{artifact:t}=e,{customMaterials:a}=t;return Promise.all(a.map(function(){var a=n((function*(a){var{default:i}=yield import("./materials/".concat(a.name,".js")),n=new i({artifact:t,config:a,preload:e});return w.fn(n.preload)&&(yield n.preload()),{config:a,material:n}}));return function(e){return a.apply(this,arguments)}}()))}))()}loadCustomObjects(){var e=this;return n((function*(){var{artifact:t}=e,{customObjects:a}=t;return Promise.all(a.map(function(){var a=n((function*(a){var{default:i}=yield import("./objects/".concat(a.name,".js")),n=new i({artifact:t,config:a,preload:e});return w.fn(n.preload)&&(yield n.preload()),n}));return function(e){return a.apply(this,arguments)}}()))}))()}loadPortal(){var e=this;return n((function*(){var t=[],{placardImage:a=!1,load:i}=e.artifact.portal;if(!1!==a){var r="".concat(o.STATIC_URL,"/placards/").concat(e.artifact.slug,".png");t.push(["placard",e.promisifiedLoad({loader:e.textureLoader,file:r})])}if(!1!==i){var{file:s=1}=e.artifact.portal;!w.int(s)&&s.startsWith("http")||(w.int(s)||w.str(s))&&(s=w.int(s)?"portal-".concat(s):s,s="".concat(o.GLB_URL,"/portals/").concat(s,".glb")),t.push(["glb",e.promisifiedLoad({loader:e.gltfLoader,file:s})])}var l=yield Promise.all(t.map(function(){var e=n((function*(e){var[t,a]=e;return[t,yield a]}));return function(t){return e.apply(this,arguments)}}()));return Object.fromEntries(l)}))()}loadVideo(t){var a=this;return n((function*(){var{dir:i,slug:n,video:r,id:s=he}=t,l=!0===r?n:r,d=e.create("video",{id:s,class:Z,loop:!0,playsinline:!0,preload:"auto",crossorigin:"anonymous"});a.videoElement=d;var c=["webm","mp4"],h=w.str(l)?l:n,[u,m=""]=h.split("?"),p=u.endsWith("m3u8")||u.startsWith("blob:")||a.artifact.hlsVideo;if(p){if(""!==d.canPlayType("application/vnd.apple.mpegurl"))return d.src=u,e.append(d),d;var f=e.create("script",{src:"".concat(o.ROOT_URL,"/hls.js"),parent:o.B});return a.hlsScript=f,new Promise((t=>{e.on(f,"load",(()=>{Hls.isSupported()&&(a.hls=new o.Hls,a.hls.loadSource(u),e.append(d),a.hls.attachMedia(d),a.hls.once(Hls.Events.FRAG_LOADED,(()=>{t(d)})))}))}))}if(u.startsWith("/")||u.startsWith("http")||(u.endsWith(".mp4")?(c=["mp4"],u=u.slice(0,-4)):u.endsWith(".webm")?(c=["webm"],u=u.slice(0,-5)):u=i?"/video/".concat(i,"/").concat(u):"/video/".concat(u,"/").concat(u)),u.endsWith(".mp4")?(c=["mp4"],u=u.slice(0,-4)):u.endsWith(".webm")&&(c=["webm"],u=u.slice(0,-5)),u.startsWith("http")||(u="".concat(o.MEDIA_URL).concat(u)),m||(m="v=".concat(ue)),c.forEach((t=>{e.create("source",{src:"".concat(u,".").concat(t,"?").concat(m),type:"video/".concat(t),parent:d})})),e.append(d),!p){var{videoWidth:v}=d;if(v>0)return d;var g="canplaythrough";return se&&(g="loadedmetadata"),new Promise((t=>{e.on(d,g,(e=>a.onVideoCanPlayThrough({e:e,resolve:t})))}))}}))()}onVideoCanPlayThrough(e){var{e:t,resolve:a}=e;se?setTimeout((()=>{a(t.target)}),le):a(t.target)}loadAudioSourceRoot(e){var[t,a]=e.split("?");t.startsWith("/")||t.startsWith("http")||(t="/audio/".concat(t));var i=["ogg","mp4","mp3"];t.endsWith(".mp3")?(i=["mp3"],t=t.slice(0,-4)):t.endsWith(".mp4")&&(i=["mp4"],t=t.slice(0,-4));var n=t.startsWith("http")?t:"".concat(o.MEDIA_URL).concat(t);return a||(a="v=".concat(ue)),{audioFileTypes:i,audioSourceRoot:n,request:a}}loadAudio(){var t=this;return n((function*(){var{slug:a,audio:i}=t.artifact;e.remove("#".concat(de));var n=e.create("audio",{class:Z,crossorigin:"anonymous",id:de,loop:!0,preload:"auto"});t.audioElement=n;var r=w.str(i)?i:a,{audioSourceRoot:o,audioFileTypes:s,request:l}=t.loadAudioSourceRoot(r);s.forEach((t=>{var a=".".concat(t);o.endsWith(a)||(o+=a),e.create("source",{src:"".concat(o,"?").concat(l),type:"audio/".concat(t),parent:n})})),e.append(n);var{duration:d}=n;if(w.num(d)&&d>0)return n;var c="canplaythrough";return se&&(c="loadedmetadata"),new Promise((t=>{e.on(n,c,(e=>t(e.target)))}))}))()}loadAudioElements(){var t=this;return n((function*(){var{audioElements:a=[],slug:i}=t.artifact;if(t.artifact.audio){var{audio:r=t.artifact.slug}=t.artifact;!0===r&&(r=t.artifact.slug),a.push({autoplay:!0,audio:r})}return yield Promise.all(a.map(function(){var a=n((function*(a,r){var o=a.audio||i,s="".concat(de,"-").concat(r);e.remove("#".concat(s));var l=e.create("audio",{class:Z,crossorigin:"anonymous","data-name":o,preload:"auto",id:s});!1!==a.loop&&(l.loop="true"),t.audioElements[r]={ele:l,config:a};var{audioSourceRoot:d,audioFileTypes:c,request:h}=t.loadAudioSourceRoot(o);c.forEach((t=>{var a=".".concat(t),i=d;i.endsWith(a)||(i+=a),e.create("source",{src:"".concat(i,"?").concat(h),type:"audio/".concat(t),parent:l})})),e.append(l);var{duration:u}=l;if(w.num(u)&&u>0)return{ele:l,config:a};var m="canplaythrough";return se&&(m="loadedmetadata"),new Promise((t=>{e.on(l,m,function(){var e=n((function*(e){se&&(yield new Promise((e=>setTimeout(e,3e3)))),t({ele:e.target,config:a})}));return function(t){return e.apply(this,arguments)}}())}))}));return function(e,t){return a.apply(this,arguments)}}()))}))()}loadTextures(){var e=this;return n((function*(){var{textures:t={}}=e.artifact,{dir:a,names:i}=t,n="jpg";o.SUPPORTS.WEBP&&(n="webp"),a&&!a.endsWith("/")&&(a="".concat(a,"/"));var r={};return i.forEach((t=>{var i=t;a.startsWith("/")||(i="https://static.artificialmuseum.com/textures/".concat(a,"/").concat(t)),i.endsWith(".jpg")||(i="".concat(i,".").concat(n));var o=e.promisifiedLoad({loader:e.textureLoader,file:i});r[slugged]=o})),r}))()}loadController(){var e=this;return n((function*(){if(e.artifact.pointerLockControls){var{ArmPointerLockControls:t}=yield import("./controls/ArmPointerLockControls.js");return t}var{ArmOrbitControls:a}=yield import("./controls/ArmOrbitControls.js");return a}))()}loadGltf(){var e=this;return n((function*(){var{artifact:t,XR:a}=e,{file:i,version:n=1}=t,r=a?"&xr=1":"",s=i.startsWith("http")?i:"".concat(o.GLB_URL,"/").concat(i,".glb?v=").concat(n).concat(r);return yield e.promisifiedLoad({loader:e.gltfLoader,file:s})}))()}loadPly(){var e=this;return n((function*(){var t,{artifact:a,XR:i}=e,{file:r,ply:s={},version:l=1}=a,d=i?"&xr=1":"",c=s.files;if(c&&!w.arr(c)&&(c=[c]),null!==(t=c)&&void 0!==t&&t.length)return yield Promise.all(c.map(function(){var t=n((function*(t,a){if(t)return t=t.startsWith("/")?"".concat(t,".ply?v=").concat(l).concat(d):"".concat(o.STATIC_URL,"/ply/").concat(t,".ply?v=").concat(l).concat(d),yield e.promisifiedLoad({loader:e.plyLoader,file:t})}));return function(e,a){return t.apply(this,arguments)}}()));var h=r;s.file&&(h=s.file);var u="?v=".concat(l).concat(d),m=h.endsWith(".ply")?h:"".concat(h,".ply");return h.startsWith("/")||(m="".concat(o.STATIC_URL,"/ply/").concat(h,".ply")),m+=u,yield e.promisifiedLoad({loader:e.plyLoader,file:m})}))()}loadGui(){var{title:t,button:a,body:i}=this.artifact.gui.afterSpawnModel,n=[];t&&n.push(e.create("h3",{innerText:t})),i&&n.push(e.create("div",{innerText:i})),n.length&&(a&&n.push(e.create("button",{id:"afterSpawnModelButton",class:"styled margin inverse",innerText:a,on:{click:e=>{var t=e.target.parentNode;t.parentNode.removeChild(t)}}})),this.gui={afterSpawnModel:e.create("div",{class:"w hudgui",children:n,parent:"#hud"})})}promisifiedLoad(e){var{loader:t,file:a}=e;return new Promise(((e,i)=>{t.load(a,(t=>{e(t)}),(e=>{e.lengthComputable&&(Math.ceil(e.loaded/e.total*100),"".concat(e.loaded,"/").concat(e.total))}),(e=>{this.setError(e,"Error loading artifact.",5e3),i(e)}))}))}startEngine(){var t=this;return n((function*(){var{artifact:a,XR:i}=t,r=Object.entries(t.promises).map(function(){var e=n((function*(e){var[t,a]=e;return[t,yield a]}));return function(t){return e.apply(this,arguments)}}()),o=yield Promise.all(r);t.assets=Object.fromEntries(o);var s=new fe({artifact:a,preload:t,XR:i}),l=yield s.init(t.assets.scene);if(!l)throw new Error("Session undefined.");e.hide(t._header),e.hide(t._preloadInfo),e.show(t._headerDone),t._session=l,t._timeoutShown&&t.isAndroidChrome?e.prop(t._confirmButton,{disabled:!1}):t._isCancelled||(yield t.finishLoad())}))()}showTimeoutWarning(){e.show(this._preloadInfo),this.isAndroidChrome&&(e.show(this._confirmButton),this._confirmButton.setAttribute("disabled",!0),this._timeoutShown=!0)}confirmButtonClickHandler(){var t=this;return n((function*(){t._session&&(e.off(t._confirmButton,"click",t.confirmButtonClickHandler),yield t.finishLoad(),t.finished())}))()}finishLoad(){var t=this;return n((function*(){if(t._session){var{hud:a,initFallbackSession:i,initScene:n}=t._session;try{yield n(),a.show(),e.show("#".concat(v)),t.finished()}catch(n){"InvalidStateError"===n.name||"NotSupportedError"===n.name?(yield i(),a.show(),e.show("#".concat(v)),t.finished()):"SecurityError"===n.name&&(e.show(t._confirmButton),e.prop(t._confirmButton,{disabled:!1}))}}}))()}setError(e,t){o.clearTimeout(this.timeout),this.finished()}showTooFarNotification(t){var{distance:a,artifact:i,map:n}=t,r="meter",o=a;o>=1e3?(r="kilometer",o>=2e3&&(r+="s"),o=Math.round(o/1e3)):o>=2&&(r+="s"),this.artifact=i,this.map=n,this.XR=!1,this._tooFarDistanceInfo.innerText="This artifact is ".concat(o," ").concat(r," away."),e.show(this._tooFarContainer),e.on(this._tooFarPreviewButton,"click",this.onTooFarPreviewButtonClick),e.on(this._tooFarCancelButton,"click",this.onTooFarCancelButtonClick),e.on(this._tooFarAbortButton,"click",this.onTooFarCancelButtonClick)}onTooFarCancelButtonClick(){e.off(this._tooFarPreviewButton,"click",this.onTooFarPreviewButtonClick),this._isCancelled=!0,e.hide(this._tooFarContainer),this.finished()}onTooFarPreviewButtonClick(){var t=this;return n((function*(){e.off(t._tooFarPreviewButton,"click",t.onTooFarPreviewButtonClick),e.off(t._tooFarCancelButton,"click",t.onTooFarCancelButtonClick),e.off(t._tooFarAbortButton,"click",t.onTooFarCancelButtonClick),e.hide(t._tooFarContainer);var{artifact:a,map:i,XR:n}=t;yield t.init({artifact:a,map:i,XR:n}),yield t.startEngine()}))()}showWebglDisabledNotification(){e.show(this._webglDisabledContainer),e.hide([this._header,this._headerDone,this._preloadInfo,this._cancelButton,this._confirmButton]),e.on(this._webglDisabledOkButton,"click",this.onWebglDisabledOkButtonClick)}onWebglDisabledOkButtonClick(){e.off(this._webglDisabledOkButton,"click",this.onWebglDisabledOkButtonClick),this._isCancelled=!0,e.hide(this._webglDisabledContainer),this.finished()}finished(){this._isWorking=!1,this._timeoutShown=!1,e(".start-experience-button").forEach((e=>{e.removeAttribute("disabled")})),e.hide([this._warningContainer,this._confirmButton,this._preloadInfo,this._headerDone]),e.prop(this._confirmButton,{disabled:!0}),e.show(this._header),o.clearTimeout(this.timeout)}}export{ye as Preload};
