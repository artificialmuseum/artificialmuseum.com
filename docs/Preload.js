import{a as e,$ as t,x as i,y as a,A as n,c as o,B as r,M as s,C as l,P as d,V as c,D as h,E as m,F as u,L as p,R as v,G as f,H as g,S as w,W as y,I as b,J as x,K as S,N as k,O as C,Q as A,U as P,X as T,Y as E,Z as _,a0 as B,a1 as R,a2 as F,a3 as W,a4 as L,a5 as I,a6 as j,a7 as O,a8 as D,a9 as H,aa as z,ab as X,ac as U,ad as V,ae as N,af as q,ag as Y,ah as G,ai as K,aj as Z,ak as J,al as Q,w as $,am as ee,an as te,ao as ie,ap as ae,aq as ne,ar as oe,as as re,at as se,au as le,av as de,aw as ce,u as he}from"./vendor.js";import{m as me}from"./mergeConfig.js";import{n as ue}from"./nodeNameIncludes.js";var pe=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};t&&t.dispose&&e.fn(t.dispose)&&t.dispose()},ve=function t(){var i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(e.arr(i)&&i.forEach((e=>t(e))),"Audio"===i.type&&i.isPlaying&&i.stop(),pe(i.geometry),i.material){var a=e.arr(i.material)?i.material:[i.material];a.forEach((e=>{Object.values(e).forEach(pe),pe(e)}))}i.children.length&&i.children.forEach(t),!i.isScene&&i.dispose&&e.fn(i.dispose)&&i.dispose(),i.parent&&i.parent.remove(i)},fe=t=>{var{node:i,search:a}=t;return!(!a||!a.length)&&(e.arr(a)||(a=[a]),a.some((e=>{var t=!1,a=!1,n=!1;return e.startsWith("*")&&(e=e.slice(1),t=!0,a=!0),e.endsWith("*")&&(e=e.slice(0,-1),t=!0,n=!0),t?a&&n?ue(i.name,e):a?i.name.endsWith(e):n?i.name.startsWith(e):void 0:i.name===e})))};class ge{constructor(e){var{scene:o,sceneInstance:r,renderer:s,endSession:l}=e;this.endSession=l,this.engine=e,this.gui=t("#".concat(i)),this.hitSearch=t("#hud-searching-hittest"),this.scene=o,this.renderer=s,this.sceneInstance=r,t.on("#".concat(a),"click",this.onExitButtonClick.bind(this)),n(this),this.animToggler=t("#toggle-animation-button")}setCamera(e){this.cameraAccess=e,e?t.show(this.recordVideoButton):t.hide(this.recordVideoButton)}showAnimToggler(e){this.animToggler&&(this.animToggler.classList.remove("play"),t.show(this.animToggler),this.animTogglerInit||(this.animTogglerInit=!0,this.eventListener=()=>{this.animToggler.classList.toggle("play"),e()},t.on(this.animToggler,"click",this.eventListener)))}hideAnimToggler(){t.hide(this.animToggler)}addSession(e){this.session=e}show(){t.show(this.gui)}hide(){t.hide(this.gui)}onExitButtonClick(){var e=this;return o((function*(){if(e.session)try{yield e.session.end()}catch(t){e.hide()}else yield e.endSession();t.off(e.animToggler,"click",e.eventListener),e.sceneInstance&&e.sceneInstance.exit&&e.sceneInstance.exit(e),r()}))()}showHitSearch(){t.show(this.hitSearch)}hideHitSearch(){t.hide(this.hitSearch)}showElement(e){e.shown||(t.show(e),e.shown=!0)}hideElement(e){e.shown&&(t.hide(e),e.shown=!1)}}class we extends s{constructor(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=arguments.length>2?arguments[2]:void 0;super(e),this.type="Reflector",this.XR=i.XR,this.skybox=i.skybox,this.shadowPlane=i.shadowPlane;var a=this,{textureHeight:n=512,textureWidth:o=512,clipBias:r=0,fragmentShader:s=be,vertexShader:y=ye}=t,b=void 0!==t.color?new l(t.color):new l(8355711),x=new d,S=new c,k=new c,C=new c,A=new h,P=new c(0,0,-1),T=new m,E=new c,_=new c,M=new m,B=new h,R=new u,F=new f(o,n,{minFilter:p,magFilter:p,format:v});g.isPowerOfTwo(o)&&g.isPowerOfTwo(n)||(F.texture.generateMipmaps=!1);var W={tDiffuse:{value:F.texture},color:{value:b},textureMatrix:{value:B}},L=new w({uniforms:W,fragmentShader:s,vertexShader:y});this.material=L,this.onBeforeRender=(e,t,i)=>{var n;if(k.setFromMatrixPosition(a.matrixWorld),C.setFromMatrixPosition(i.matrixWorld),A.extractRotation(a.matrixWorld),S.set(0,0,1),S.applyMatrix4(A),E.subVectors(k,C),!(E.dot(S)>0)){E.reflect(S).negate(),E.add(k),A.extractRotation(i.matrixWorld),P.set(0,0,-1),P.applyMatrix4(A),P.add(C),_.subVectors(k,P),_.reflect(S).negate(),_.add(k),R.position.copy(E),R.up.set(0,1,0),R.up.applyMatrix4(A),R.up.reflect(S),R.lookAt(_),R.far=i.far,R.updateMatrixWorld(),R.projectionMatrix.copy(i.projectionMatrix),B.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),B.multiply(R.projectionMatrix),B.multiply(R.matrixWorldInverse),B.multiply(a.matrixWorld),x.setFromNormalAndCoplanarPoint(S,k),x.applyMatrix4(R.matrixWorldInverse),T.set(x.normal.x,x.normal.y,x.normal.z,x.constant);var o=R.projectionMatrix;M.x=(Math.sign(T.x)+o.elements[8])/o.elements[0],M.y=(Math.sign(T.y)+o.elements[9])/o.elements[5],M.z=-1,M.w=(1+o.elements[10])/o.elements[14],T.multiplyScalar(2/T.dot(M)),o.elements[2]=T.x,o.elements[6]=T.y,o.elements[10]=T.z+1-r,o.elements[14]=T.w,F.texture.encoding=e.outputEncoding,a.visible=!1;var s=e.getRenderTarget(),l=e.xr.enabled,d=e.shadowMap.autoUpdate;e.xr.enabled=!1,e.shadowMap.autoUpdate=!1,e.setRenderTarget(F),e.state.buffers.depth.setMask(!0),!1===e.autoClear&&e.clear(),this.XR&&this.skybox&&(this.skybox.visible=!0);var c=!1;null!==(n=this.shadowPlane)&&void 0!==n&&n.visible&&(this.shadowPlane.visible=!1,c=!0),e.render(t,R),e.xr.enabled=l,e.shadowMap.autoUpdate=d,e.setRenderTarget(s),this.XR&&this.skybox&&(this.skybox.visible=!1),c&&(this.shadowPlane.visible=!0);var h=i.viewport;void 0!==h&&e.state.viewport(h),a.visible=!0}},this.getRenderTarget=()=>F}}we.prototype.isReflector=!0;var ye="\nuniform mat4 textureMatrix;\nvarying vec4 vUv;\n\n#include <common>\n#include <logdepthbuf_pars_vertex>\n\nvoid main() {\n  vUv = textureMatrix * vec4( position, 1.0 );\n\n  gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n  #include <logdepthbuf_vertex>\n}",be="\nuniform vec3 color;\nuniform sampler2D tDiffuse;\nvarying vec4 vUv;\n\n#include <logdepthbuf_pars_fragment>\n\nfloat blendOverlay( float base, float blend ) {\n  return( base < 0.5 ? ( 2.0 * base * blend ) : ( 1.0 - 2.0 * ( 1.0 - base ) * ( 1.0 - blend ) ) );\n}\n\nvec3 blendOverlay( vec3 base, vec3 blend ) {\n  return vec3( blendOverlay( base.r, blend.r ), blendOverlay( base.g, blend.g ), blendOverlay( base.b, blend.b ) );\n}\n\nvoid main() {\n  #include <logdepthbuf_fragment>\n\n  vec4 base = texture2DProj( tDiffuse, vUv );\n  gl_FragColor = vec4( blendOverlay( base.rgb, color ), 1.0 );\n}\n",xe=y.APP_DB.SCENE_TYPES;class Se{constructor(e){var{artifact:t,preload:i,XR:a}=e;this.XR=a,this.artifact=t,this.preload=i;var{type:n=xe.Hit}=t;this.type=n,this.clock=new b,this.scene=new x,this.onResize=this.onResize.bind(this),this.render=this.render.bind(this),this.initFallbackSession=this.initFallbackSession.bind(this),this.toggleAnimations=this.toggleAnimations.bind(this),this.endSession=this.endSession.bind(this)}init(e){var i=this;return o((function*(){var{artifact:a,preload:n,scene:r,type:s,XR:l}=i;e&&(i.sceneInstance=e);var{fov:d,near:c,far:h}=me(a.cam,S),m=y.innerWidth/y.innerHeight;i.camera=new u(d,m,c,h),i.camera.updateProjectionMatrix(),r.add(i.camera);var p=new k({antialias:!0,alpha:!0});if(i.renderer=p,p.setPixelRatio(y.devicePixelRatio),p.domElement.id=C,p.physicallyCorrectLights=!0,p.outputEncoding=A,p.toneMappingExposure=1,!1!==a.shadow&&(p.shadowMap.enabled=!0,p.shadowMap.type=P),i.addAudio(),i.addSkybox(),a.hideLight||i.addLights(),i.videoElement=n.assets.videoElement,null!=e&&e.init&&(yield e.init({engine:i,preload:n})),null!=e&&e.beforeLoadModel&&(yield e.beforeLoadModel({engine:i,preload:n})),i.loadModel(),null!=e&&e.afterLoadModel&&(yield e.afterLoadModel({engine:i,preload:n})),i.customMaterials=[],a.customMaterials&&(yield Promise.all(a.customMaterials.map(function(){var e=o((function*(e){var t=i.model.getObjectByName(e.target);if(t){var{default:n}=yield import("./materials/".concat(e.name,".js"));t.material=new n({artifact:a,config:e,engine:i}),i.customMaterials.push({config:e,material:t.material})}}));return function(t){return e.apply(this,arguments)}}()))),i.addVideoTrigger(),i.artifact.underwater&&(yield i.underwaterPlane()),i.artifact.ocean&&(yield i.oceanPlane()),i.artifact.particles){var{Particles:v}=yield import("./Particles.js");i.particles=new v(i),yield i.particles.init()}if(p.setSize(y.innerWidth,y.innerHeight),t.append(p.domElement,"#".concat(T)),i.hud=new ge(i),l)try{var f=p.xr.getController(0);if(i.controller=f,!1!==a.shadow&&!1!==a.shadowPlane&&i.addShadowPlane(),!i.isHittestScene())throw new Error("Unknown scene type ".concat(s));s!==xe.Float&&i.spawnReticle(),t.on(f,"select",(()=>{if(!i.justUnspawned){i.spawnModel(!1),a.clickable?i.hud.showAnimToggler(i.toggleAnimations):i.hud.hideAnimToggler()}})),a.clickable||i.hud.hideAnimToggler(),r.add(f),i.initScene=o((function*(){var e;return t.hide("#Locator"),e=yield y.NAV.xr.requestSession("immersive-ar",{requiredFeatures:["hit-test","dom-overlay"],domOverlay:{root:t("#hud")}}),t.on(e,"end",(()=>{i.endSession()})),i.hud.addSession(e),i.refSpace=yield e.requestReferenceSpace("viewer"),i.renderer.xr.enabled=!0,i.renderer.xr.setReferenceSpaceType("local"),yield i.renderer.xr.setSession(e),e.initFallbackSession=i.initFallbackSession.bind(i),e}))}catch(e){i.initScene=i.initFallbackSession}else i.initScene=i.initFallbackSession;return yield i.addClickables(),t.on(y,"resize",i.onResize),i.onResize(),p.setAnimationLoop(i.render),i}))()}onResize(){var{innerWidth:e,innerHeight:t}=y;this.camera.aspect=e/t,this.camera.updateProjectionMatrix(),this.renderer.setSize(e,t)}addLights(){var{directionalLightPosition:e=_.directionalPosition}=this.artifact,t=new E(_.directionalColor,_.directionalIntensity);t.position.set(...e),t.castShadow=!0,!1!==this.artifact.shadow&&(t.shadow.bias=-1e-4,t.shadow.mapSize.width=512,t.shadow.mapSize.height=512,t.shadow.camera.near=.1,t.shadow.camera.far=300),this.directionalLight=t,this.scene.add(t),this.ambientLight=new B(_.ambientColor,_.ambientIntensity),this.scene.add(this.ambientLight)}addShadowPlane(){var e=new R(150,150,64,64),t=new F;t.opacity=W;var i=new s(e,t);i.receiveShadow=!0,i.lookAt(0,100,0),i.position.set(0,0,0),this.shadowPlane=i}spawnReticle(){var e=new L(.15,.2,32).rotateX(-M.PI/2),t=new I;this.reticle=new s(e,t),this.reticle.matrixAutoUpdate=!1,this.reticle.visible=!1,this.scene.add(this.reticle)}glow(){var{glow:t}=this.artifact;t&&this.model.traverse((i=>{if(ue(i.name,"glow")){var a=e.bool(t)?238:t,n=new I({color:a,side:j,blending:O,transparent:!0});i.material=n}}))}addClickables(){var e=this;return o((function*(){var{artifact:i,model:a}=e,{clickables:n=[]}=i;if(n&&n.length){var o=[];if(a.traverse((e=>{fe({node:e,search:n})&&o.push(e)})),o.length){var{Controls:r}=yield import("./Controls.js");e.controls=new r({clickables:o,engine:e}),e.controller?t.on(e.controller,"select",e.controls.select,!1):t.on(e.renderer.domElement,"mousedown",e.controls.click,!1)}}}))()}nosort(){this.renderer.sortObjects=!1}clip(){var{model:e,artifact:{clip:t,clipSide:i}}=this;e&&t&&this.model.traverse((e=>{if(ue(e.name,"clip")){var t=j;"back"===i?t=ee:"front"===i&&(t=te),e.material=new I({color:"green",colorWrite:!1,side:t}),e.castShadow=!1,e.receiveShadow=!1,e.renderOrder=1}else e.renderOrder=2}))}mirror(){var{mirrors:e}=this.artifact;if(e&&e.length){var t=y.devicePixelRatio,i=y.innerWidth*t,a=y.innerHeight*t;this.mirrors=e.map((e=>{var t,{clipBias:n=.003,color:o=7829367,type:r,params:s=[4,32],rotation:l={},position:d={}}=e,c=APP_DB.MESH_TYPES;t=r===c.CIRCLE?new D(...s):r===c.RING?new L(...s):r===c.BOX?new H(...s):r===c.SPHERE?new z(...s):new R(...s);var h=new we(t,{clipBias:n,textureWidth:i,textureHeight:a,color:o},this),{x:m,y:u,z:p}=l;m&&h.rotateX(m),u&&h.rotateY(u),p&&h.rotateZ(p);var{x:v,y:f,z:g}=d;return v&&h.position.setX(v),f&&h.position.setY(f),g&&h.position.setZ(g),this.model.add(h),h}))}}analyseAudio(){if(this.artifact.analyseAudio){this.audioCtx=new AudioContext;var{audioElement:e}=this.preload.assets;this.audioSource=this.audioCtx.createMediaElementSource(e),this.analyser=this.audioCtx.createAnalyser(),this.audioSource.connect(this.analyser),this.audioSource.connect(this.audioCtx.destination),this.analyserArray=new Uint8Array(this.analyser.frequencyBinCount),this.analyser.getByteFrequencyData(this.analyserArray)}}underwaterPlane(){var e=this;return o((function*(){var{UnderwaterPlane:t}=yield import("./UnderwaterPlane.js");e.cameraPlane=new t,yield e.cameraPlane.preload(e)}))()}oceanPlane(){var e=this;return o((function*(){var{name:t="ocean",normals:i="oceannormals1"}=e.artifact.ocean,{Water:a}=yield import("./vendor.js").then((function(e){return e.a_})),n=e.model.getObjectByName(t),o=yield e.preload.promisifiedLoad({loader:e.preload.textureLoader,file:"https://static.artificialmuseum.com/textures/ocean/".concat(i,".jpg")});o.wrapS=o.wrapT=X,e.ocean=new a(n.geometry,{textureWidth:512,textureHeight:512,waterNormals:o,sunDirection:new c,sunColor:16777215,waterColor:1048575,distortionScale:3.7,fog:!1}),e.ocean.position.copy(n.position),e.ocean.rotation.copy(n.rotation),e.model.add(e.ocean),n.visible=!1}))()}addSkybox(){var t=this;return o((function*(){var{artifact:i,preload:a,renderer:n,scene:o,XR:r}=t,l=ie,d=null==i?void 0:i.skySphere;e.arr(d)&&d.length&&(l=d);var c=new z(...l);!1!==i.scaleSky&&c.scale(-1,1,1);var h=a.assets.skybox,m=new U(n);m.compileEquirectangularShader();var u=m.fromEquirectangular(h).texture;m.dispose();var p=new I({map:h}),v=new s(c,p);v.visible=!r,o.add(v),!1===i.light||i.hideEnvironment||(o.environment=u),t.skybox=v}))()}addAudio(){if(!this.artifact.audio)return!1;this.listener=new V,this.camera.add(this.listener)}addVideoTrigger(){this.artifact.triggerVideo&&this.model.traverse((e=>{this.videoTrigger||["videotarget","videotrigger"].some((t=>ue(e.name,t)))&&(this.videoTrigger=e,this.videoTrigger.visible=!1)}))}startMedia(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];if(!this.isMediaPlaying){var{actions:t=[],artifact:i,preload:a}=this,{audioElement:n,videoElement:o}=a.assets;n&&!i.triggerAudio&&(e&&(n.currentTime=0),n.play()),o&&!i.triggerVideo&&(e&&(o.currentTime=0),o.play()),t.forEach((e=>e.play())),this.isMediaPlaying=!0}}stopMedia(){var{audioElement:e,videoElement:t,actions:i=[]}=this;e&&e.pause(),t&&t.pause(),i&&i.length&&i.forEach((e=>e.stop())),this.isMediaPlaying=!1}toggleAnimations(){this.actions.forEach((e=>e.paused=!e.paused))}initFallbackSession(){this.XR=!1,y.B.classList.add(N);var{camera:t,artifact:i,model:a,renderer:n}=this,o=new q(t,n.domElement);this.controller=o,this.skybox.visible=!0,Object.entries(Y).forEach((e=>{var[t,i]=e;o[t]=i}));var{cam:r={},orbit:s={},clickable:l}=i;e.num(s.min)&&(o.minDistance=s.min),e.num(s.max)&&(o.maxDistance=s.max),e.num(r.maxPolar)&&(o.maxPolarAngle=g.degToRad(r.maxPolar)),e.num(r.minPolar)&&(o.minPolarAngle=g.degToRad(r.minPolar)),l?this.hud.showAnimToggler(this.toggleAnimations):this.hud.hideAnimToggler();var{cam:d={}}=i,h=ae,{x:m=h.x,y:u=h.y,z:p=h.z}=d;t.position.set(m,u,p);var{lookat:v={}}=i,{x:f=0,y:w=0,z:b=0}=v;if(o.target=new c(f,w,b),a){var{x:x,y:S,z:k}=a.scale,{scale:C}=i;C&&a.scale.set(x*C,S*C,k*C)}o.update();this.spawnModel(!0),n.domElement.focus()}loadModel(){var t,i,a,n,{artifact:o,preload:r,sceneInstance:s={}}=this;(null!=s&&s.model?this.model=s.model:null!==(t=r.assets.gltf)&&void 0!==t&&t.scene&&(this.model=r.assets.gltf.scene),null!=s&&s.animations?this.animations=s.animations:null!==(i=r.assets.gltf)&&void 0!==i&&i.animations&&(this.animations=r.assets.gltf.animations),this.model)&&(this.model.traverse((t=>{var i;if(s.parentName&&ue(t.name,s.parentName)&&s.child&&(n=t),t.isMesh){var{frustumCulled:a,transparent:r,castShadow:l,receiveShadow:d}=o;!1===a&&(t.frustumCulled=!1),!1===r&&(t.material.transparent=!1),ue(t.name,"noshadow")||(t.castShadow=!1!==l,t.receiveShadow=!1!==d),t.material.map&&(t.material.map.anisotropy=16,t.material.map.encoding=A),t.material.emissiveMap&&(t.material.emissiveMap.encoding=A),(t.material.map||t.material.emissiveMap)&&(t.material.needsUpdate=!0)}else if(t.isLight){var{castShadow:c,shadowBias:h=-1e-4,lightIntensity:m=.01,shadow:u,shadowCam:p={}}=o;if(t.intensity=t.intensity*m,!1!==u){t.castShadow=!1!==c,t.shadow.bias=h;var{near:v=.1,far:f=300}=p;t.shadow.camera.near=v,t.shadow.camera.far=f}}null!==(i=o.lookAtCameraObjects)&&void 0!==i&&i.length&&fe({node:t,search:o.lookAtCameraObjects})&&(this.lookAtCameraObjects||(this.lookAtCameraObjects=[]),e.num(this.lookAtAlpha)||(this.lookAtAlpha=0),this.lookAtCameraObjects.push(t))})),n&&n.add(s.child));if(this.actions=[],null!==(a=this.animations)&&void 0!==a&&a.length){this.mixer=new G(this.model);var{animations:l={}}=o,{loop:d,startOnTouch:c,clampWhenFinished:h=!0,autoplay:m=!0}=l;this.animations.forEach((e=>{var t=this.mixer.clipAction(e);!1===d&&(t.clampWhenFinished=h,t.loop=K),!c&&m||(t.paused=!0),this.actions.push(t)}))}if(this.videoElement&&this.model){var u=[];this.model.traverse((e=>{ue(e.name,"videotarget")&&u.push(e)})),u.length&&u.forEach((e=>{var t=new Z(this.videoElement),{flipVideo:i,chromaKey:a}=o;!1!==i&&(t.flipY=!1),e.material.map=t,a&&(e.material=new ChromaKeyMaterial(o.chromaKey,t))}))}this.glow(),this.clip(),this.artifact.nosort&&this.nosort(),this.mirror(),this.analyseAudio()}spawnModel(e){var{artifact:t,camera:i,controller:a,model:n,reticle:o,scene:r,shadowPlane:s,type:l,XR:d,sceneInstance:c={}}=this,{showSkybox:h}=t;if(!d||e)return n&&(this.applyPositionAndRotation(),r.add(n)),this.modelSpawned=!0,null!=c&&c.spawnModel&&c.spawnModel({engine:this}),null!=c&&c.afterSpawnModel&&c.afterSpawnModel({engine:this}),void this.startMedia();if(this.isHittestScene()){if(!this.modelSpawned&&this.lastHit){o.updateMatrixWorld(),n.position.setFromMatrixPosition(o.matrixWorld),n.updateMatrixWorld();var m=i.position,u=n.position,p=m.x-u.x,v=m.z-u.z,f=Math.atan2(p,v);n.rotation.y=f,s&&(s.position.setFromMatrixPosition(o.matrixWorld),r.add(s)),r.add(n),o.visible=!1,this.modelSpawned=!0,null!=c&&c.spawnModel&&c.spawnModel({engine:this}),null!=c&&c.afterSpawnModel&&c.afterSpawnModel({engine:this}),this.startMedia()}this.applyPositionAndRotation()}else if(l===xe.Float){var g=n.clone();g.position.set(0,0,-1).applyMatrix4(a.matrixWorld),this.applyPositionAndRotation(),r.add(g),this.startMedia()}h&&(this.skybox.visible=!0)}unspawnModel(){var e;this.modelSpawned&&(this.scene.remove(this.model),this.modelSpawned=!1,this.isAnimationRunning=!1,this.stopMedia(),null!==(e=this.sceneInstance)&&void 0!==e&&e.exit&&this.sceneInstance.exit({engine:this}),this.justUnspawned=!0,setTimeout((()=>{this.justUnspawned=!1}),200))}applyPositionAndRotation(){var{artifact:e,model:t}=this;if(t){var{pos:i={},rot:a={}}=e;i.x&&(t.position.x+=i.x),i.y&&(t.position.y+=i.y),i.z&&(t.position.z+=i.z);var n=g.degToRad;a.x&&t.rotateX(n(a.x)),a.y&&t.rotateY(n(a.y)),a.z&&t.rotateZ(n(a.z))}}endSession(){var e=this;return o((function*(){var i;e.hud.hide(),e.renderer.setAnimationLoop(null),t("#".concat(T)).classList.remove("visible"),null!==(i=e.sceneInstance)&&void 0!==i&&i.exit&&e.sceneInstance.exit({engine:e}),e.scene&&ve(e.scene),t.remove("#".concat(J)),t.remove("#".concat(Q));var a=t("#".concat(C));if(a){var n=a.parentNode;n.id===T?t.remove(a):t.remove(n)}y.B.classList.remove(N),t(".start-experience-button").forEach((e=>{e.removeAttribute("disabled")})),$&&y.location.reload()}))()}isHittestScene(){return![xe.Float].includes(this.type)}render(e,t){var i=this;return o((function*(){var a,n,o=i.clock.getDelta();i.renderHittest(t),i.mixer&&i.mixer.update(o),i.renderVideoTrigger(),null!==(a=i.sceneInstance)&&void 0!==a&&a.tick&&i.sceneInstance.tick({delta:o,engine:i,timestamp:e,frame:t}),i.renderAnalyseAudio(),i.renderLookAtCamera(o),i.cameraPlane&&i.renderUnderwater(o),i.ocean&&i.renderOcean(o),i.particles&&i.particles.update(o),i.customMaterials&&i.customMaterials.forEach((e=>{var{config:t,material:i}=e;if(i.uniforms.uTime){var{speed:a=1}=t;i.uniforms.uTime.value+=o*a}})),null!==(n=i.sceneInstance)&&void 0!==n&&n.render?i.sceneInstance.render({delta:o,engine:i,timestamp:e,frame:t}):i.renderer.render(i.scene,i.camera)}))()}renderLookAtCamera(e){var{camera:t,lookAtCameraObjects:i=[]}=this;null!=i&&i.length&&i.forEach((i=>{var a=new c(0,0,i.position.distanceTo(t.position));i.localToWorld(a);var n=a.clone(),o=this.artifact.lookAtSpeed||.001;this.lookAtAlpha+=e*o,n.distanceToSquared(t.position)>.5&&(n.lerp(t.position,Math.min(1,this.lookAtAlpha)),i.lookAt(n))}))}renderVideoTrigger(){if(this.modelSpawned&&this.artifact.triggerVideo&&this.videoTrigger){var{triggerVideoDistance:e=1.1,triggerAudio:t}=this.artifact,i=e*e,a=this.videoTrigger.position.clone();a.add(this.videoTrigger.parent.position),this.camera.position.distanceToSquared(a)<=i?this.videoElement.paused&&(this.videoElement.play(),this.videoTrigger.visible=!0,t&&this.audioElement&&this.audioElement.play()):this.videoElement.paused||(this.videoElement.pause(),this.videoTrigger.visible=!1,t&&this.audioElement&&this.audioElement.pause())}}renderHittest(e){var i=this;return o((function*(){if(e&&i.XR){var a=i.renderer.xr.getSession();i.hitTestSourceRequested||(i.hitTestSource=yield a.requestHitTestSource({space:i.refSpace}),t.on(a,"end",(()=>{i.hitTestSourceRequested=!1,i.hitTestSource=null})),i.hitTestSourceRequested=!0);var n=e.getHitTestResults(i.hitTestSource);if(n.length){if(i.lastHit=n[0],!i.modelSpawned){i.reticle.visible=!0;var o=i.renderer.xr.getReferenceSpace();i.reticle.matrix.fromArray(i.lastHit.getPose(o).transform.matrix)}i.hud.hideHitSearch()}else i.reticle.visible=!1,i.modelSpawned||i.hud.showHitSearch(),i.lastHit=void 0}}))()}renderAnalyseAudio(){var t;if(this.artifact.analyseAudio){var{audioAnalyserThreshold:i=0,waves:a=[]}=this.artifact;this.analyser.getByteFrequencyData(this.analyserArray);var n=0;this.analyserArray.forEach(((e,t)=>{e>=i&&(e=>a.some((t=>e>=t[0]&&e<=t[1])))(t)&&(n+=e)}));var o=0;a.map((e=>{o+=e[1]-(e[0]-1)})),this.audioAverage=n/o/255,e.fn(null===(t=this.sceneInstance)||void 0===t?void 0:t.renderAudioAnalyser)&&this.sceneInstance.renderAudioAnalyser(this.audioAverage,this)}}renderUnderwater(e){this.cameraPlane.tick(e)}renderOcean(e){var{animationSpeed:t=1}=this.artifact.ocean;this.ocean.material.uniforms.time.value+=e*t*.1}}class ke{constructor(e){var{artifact:i,root:a,THREE:n}=e;this.artifact=i,this.root=a,n&&(this.THREE=n);var{android:o,chrome:r}=he;this.isAndroidChrome=o&&r,this._warningContainer=t("#timeout-warning"),this._header=t("#timeout-warning-header"),this._headerDone=t("#timeout-warning-header-done"),this._preloadInfo=t("#timeout-warning-info"),this._cancelButton=t("#timeout-warning-cancel"),this._confirmButton=t("#timeout-warning-confirm"),this._tooFarContainer=t("#toofar-warning"),this._tooFarPreviewButton=t("#toofar-warning-load-preview-button"),this._tooFarDistanceInfo=t("#toofar-warning-distance"),this._tooFarCancelButton=t("#toofar-warning-cancel-button"),this._tooFarAbortButton=t("#toofar-warning-abort-button"),this._webglDisabledContainer=t("#timeout-warning-webgl-disabled"),this._webglDisabledOkButton=t("#timeout-warning-webgl-disabled-ok-button"),this.confirmButtonClickHandler=this.confirmButtonClickHandler.bind(this),t.on(this._confirmButton,"click",this.confirmButtonClickHandler),this.onTooFarCancelButtonClick=this.onTooFarCancelButtonClick.bind(this),this.onTooFarPreviewButtonClick=this.onTooFarPreviewButtonClick.bind(this),this.onWebglDisabledOkButtonClick=this.onWebglDisabledOkButtonClick.bind(this),this.textureLoader=new ne,this.gltfLoader=new oe,this.plyLoader=new re,this.collectPreloadPromises(),this.startEngine=this.startEngine.bind(this)}collectPreloadPromises(){var e={skybox:this.loadSkybox()},{audio:t,glb:i,type:a,video:n}=this.artifact;t&&(e.audioElement=this.loadAudio()),(e=>{var t=APP_DB.SCENE_TYPES;return!e||[t.Float,t.Hit].includes(e)})(a)||(e.scene=this.loadScene()),!1!==i&&(e.gltf=this.loadGltf()),n&&(e.videoElement=this.loadVideo()),this.promises=e}init(){var e=arguments,i=this;return o((function*(){var a=e.length>0&&void 0!==e[0]?e[0]:{},{map:n,XR:o}=a;i._isWorking=!0,i._isCancelled=!1,i._session=!1,i.map=n,i.XR=o,t.on(i._cancelButton,"click",(()=>{i._isCancelled=!0,i.finished()})),t.show([i._warningContainer,i._header]),i.timeout=y.setTimeout(i.showTimeoutWarning,se)}))()}loadScene(){var i=this;return o((function*(){var{artifact:a}=i,n=APP_DB.SCENE_TYPES,{type:o=n.Hit}=a,r=Object.entries(n).find((e=>{var[t,i]=e;return i===o})),s="".concat(i.root,"/CustomScene.js");if(e.arr(r)){var l=r[0];s="./scenes/".concat(l,".js")}var{default:d}=yield import(s),c=new d({artifact:a,mergeConfig:me,preload:i,$:t,W:y,is:e});return null!=c&&c.preload&&(yield c.preload({artifact:a,preload:i})),c}))()}loadSkybox(){var e=this;return o((function*(){var{city:t,sky:i,slug:a}=e.artifact,n=i||a,o="jpg";y.SUPPORTS.WEBP&&(o="webp");var r=n;return n.startsWith("/")||(r=[y.STATIC_URL,"skybox",t,n].filter((e=>e)).join("/")),r.endsWith(".".concat(o))||(r+=".".concat(o)),yield e.promisifiedLoad({loader:e.textureLoader,file:r})}))()}loadVideo(){var i=this;return o((function*(){var{slug:a,video:n}=i.artifact,o=!0===n?a:n,r=t.create("video",{id:Q,loop:!0,playsinline:!0,preload:"auto",crossorigin:"anonymous"});i.videoElement=r;var s=["webm","mp4"],l=e.str(o)?o:a;l.startsWith("/")||(l.endsWith(".mp4")?(s=["mp4"],l=l.slice(0,-4)):l="/video/".concat(l,"/").concat(l)),l.endsWith(".mp4")&&(s=["mp4"],l=l.slice(0,-4));var d="".concat(y.MEDIA_URL).concat(l);s.forEach((e=>{t.create("source",{src:"".concat(d,".").concat(e,"?v=").concat(le),type:"video/".concat(e),parent:r})})),t.append(r);var{videoWidth:c}=r;if(c>0)return r;var h="canplaythrough";return de&&(h="loadedmetadata"),new Promise((e=>{t.on(r,h,(t=>{de?setTimeout((()=>{e(t.target)}),ce):e(t.target)}))}))}))()}loadAudio(){var i=this;return o((function*(){var{slug:a,audio:n}=i.artifact;t.remove("#".concat(J));var o=t.create("audio",{id:J,loop:!0,crossorigin:"anonymous"});i.audioElement=o;var r=e.str(n)?n:a;r.startsWith("/")||(r="/audio/".concat(r));var s=["ogg","mp4","mp3"];r.endsWith(".mp3")&&(s=["mp3"],r=r.slice(0,-4));var l="".concat(y.MEDIA_URL).concat(r);s.forEach((e=>{t.create("source",{src:"".concat(l,".").concat(e,"?v=").concat(le),type:"audio/".concat(e),parent:o})})),t.append(o);var{duration:d}=o;if(e.num(d)&&d>0)return o;var c="canplaythrough";return de&&(c="loadedmetadata"),new Promise((e=>{t.on(o,c,(t=>e(t.target)))}))}))()}loadGltf(){var e=this;return o((function*(){var{artifact:t,XR:i}=e,{file:a,version:n=1}=t,o=i?"&xr=1":"",r="".concat(y.GLB_URL,"/").concat(a,".glb?v=").concat(n).concat(o);return yield e.promisifiedLoad({loader:e.gltfLoader,file:r})}))()}promisifiedLoad(e){var{loader:t,file:i}=e;return new Promise(((e,a)=>{t.load(i,(t=>{e(t)}),(e=>{e.lengthComputable&&(Math.ceil(e.loaded/e.total*100),"/".concat(e.total))}),(e=>{this.setError(e,"Error loading artifact.",5e3),a(e)}))}))}startEngine(){var e=this;return o((function*(){var{artifact:i,XR:a}=e,n=yield Promise.all(Object.entries(e.promises).map(function(){var e=o((function*(e){var[t,i]=e;return[t,yield i]}));return function(t){return e.apply(this,arguments)}}()));e.assets=Object.fromEntries(n);var r=new Se({artifact:i,preload:e,XR:a}),s=yield r.init(e.assets.scene);if(!s)throw new Error("Session undefined.");t.hide(e._header),t.hide(e._preloadInfo),t.show(e._headerDone),e._session=s,e._timeoutShown&&e.isAndroidChrome?t.prop(e._confirmButton,{disabled:!1}):e._isCancelled||(yield e.finishLoad())}))()}showTimeoutWarning(){t.show(this._preloadInfo),this.isAndroidChrome&&(t.show(this._confirmButton),this._confirmButton.setAttribute("disabled",!0),this._timeoutShown=!0)}confirmButtonClickHandler(){var e=this;return o((function*(){e._session&&(t.off(e._confirmButton,"click",e.confirmButtonClickHandler),yield e.finishLoad(),e.finished())}))()}finishLoad(){var e=this;return o((function*(){if(e._session){var{hud:i,initFallbackSession:a,initScene:n}=e._session;try{yield n(),i.show(),t.show("#".concat(T)),e.finished()}catch(n){"InvalidStateError"===n.name||"NotSupportedError"===n.name?(yield a(),i.show(),t.show("#".concat(T)),e.finished()):"SecurityError"===n.name&&(t.show(e._confirmButton),t.prop(e._confirmButton,{disabled:!1}))}}}))()}setError(e,t){y.clearTimeout(this.timeout),this.finished()}showTooFarNotification(e){var{distance:i,artifact:a,map:n}=e,o="meter",r=i;r>=1e3?(o="kilometer",r>=2e3&&(o+="s"),r=Math.round(r/1e3)):r>=2&&(o+="s"),this.artifact=a,this.map=n,this.XR=!1,this._tooFarDistanceInfo.innerText="This artifact is ".concat(r," ").concat(o," away."),t.show(this._tooFarContainer),t.on(this._tooFarPreviewButton,"click",this.onTooFarPreviewButtonClick),t.on(this._tooFarCancelButton,"click",this.onTooFarCancelButtonClick),t.on(this._tooFarAbortButton,"click",this.onTooFarCancelButtonClick)}onTooFarCancelButtonClick(){t.off(this._tooFarPreviewButton,"click",this.onTooFarPreviewButtonClick),this._isCancelled=!0,t.hide(this._tooFarContainer),this.finished()}onTooFarPreviewButtonClick(){var e=this;return o((function*(){t.off(e._tooFarPreviewButton,"click",e.onTooFarPreviewButtonClick),t.off(e._tooFarCancelButton,"click",e.onTooFarCancelButtonClick),t.off(e._tooFarAbortButton,"click",e.onTooFarCancelButtonClick),t.hide(e._tooFarContainer);var{artifact:i,map:a,XR:n}=e;yield e.init({artifact:i,map:a,XR:n}),yield e.startEngine()}))()}showWebglDisabledNotification(){t.show(this._webglDisabledContainer),t.hide([this._header,this._headerDone,this._preloadInfo,this._cancelButton,this._confirmButton]),t.on(this._webglDisabledOkButton,"click",this.onWebglDisabledOkButtonClick)}onWebglDisabledOkButtonClick(){t.off(this._webglDisabledOkButton,"click",this.onWebglDisabledOkButtonClick),this._isCancelled=!0,t.hide(this._webglDisabledContainer),this.finished()}finished(){this._isWorking=!1,this._timeoutShown=!1,t(".start-experience-button").forEach((e=>{e.removeAttribute("disabled")})),t.hide([this._warningContainer,this._confirmButton,this._preloadInfo,this._headerDone]),t.prop(this._confirmButton,{disabled:!0}),t.show(this._header),y.clearTimeout(this.timeout)}}export{ke as Preload};
